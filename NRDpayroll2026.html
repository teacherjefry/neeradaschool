<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada Payroll System v2026 (Unified)</title>
    
    <!-- Google Fonts: Noto Sans Lao -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Sans+Lao:wght@100..900&family=Inter:wght@100..900&display=swap" rel="stylesheet">
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <style>
        /* Theme Variables - Default Blue */
        :root {
            --primary-900: #1e3a8a;
            --primary-800: #1e40af;
            --primary-700: #1d4ed8;
            --primary-600: #2563eb;
            --primary-100: #dbeafe;
            --primary-50: #eff6ff;
        }

        /* Font Family Override for Lao Support */
        body {
            font-family: 'Noto Sans Lao', 'Inter', sans-serif !important;
        }

        /* Theme Overrides */
        body.theme-default { --primary-900: #1e3a8a; --primary-800: #1e40af; --primary-700: #1d4ed8; --primary-600: #2563eb; --primary-100: #dbeafe; --primary-50: #eff6ff; }
        body.theme-emerald { --primary-900: #064e3b; --primary-800: #065f46; --primary-700: #047857; --primary-600: #059669; --primary-100: #d1fae5; --primary-50: #ecfdf5; }
        body.theme-rose { --primary-900: #881337; --primary-800: #9f1239; --primary-700: #be123c; --primary-600: #e11d48; --primary-100: #ffe4e6; --primary-50: #fff1f2; }
        body.theme-slate { --primary-900: #0f172a; --primary-800: #1e293b; --primary-700: #334155; --primary-600: #475569; --primary-100: #f1f5f9; --primary-50: #f8fafc; }
        body.theme-violet { --primary-900: #4c1d95; --primary-800: #5b21b6; --primary-700: #6d28d9; --primary-600: #7c3aed; --primary-100: #ede9fe; --primary-50: #f5f3ff; }

        /* Color Class Mappings - Blue */
        .bg-blue-900 { background-color: var(--primary-900) !important; }
        .bg-blue-800 { background-color: var(--primary-800) !important; }
        .bg-blue-700 { background-color: var(--primary-700) !important; }
        .bg-blue-600 { background-color: var(--primary-600) !important; }
        .bg-blue-100 { background-color: var(--primary-100) !important; }
        .bg-blue-50 { background-color: var(--primary-50) !important; }
        
        .text-blue-900 { color: var(--primary-900) !important; }
        .text-blue-800 { color: var(--primary-800) !important; }
        .text-blue-700 { color: var(--primary-700) !important; }
        .text-blue-600 { color: var(--primary-600) !important; }
        .text-blue-100 { color: var(--primary-100) !important; }
        
        .border-blue-100 { border-color: var(--primary-100) !important; }
        .border-blue-200 { border-color: #bfdbfe !important; }

        /* Custom scrollbar */
        #employee-list::-webkit-scrollbar, #editor-content::-webkit-scrollbar, #dept-tree::-webkit-scrollbar { width: 6px; }
        #employee-list::-webkit-scrollbar-thumb, #editor-content::-webkit-scrollbar-thumb, #dept-tree::-webkit-scrollbar-thumb { background-color: #cbd5e1; border-radius: 3px; }

        /* Editor Highlights */
        .field-highlight-1 input { background-color: #f0fdf4 !important; border-color: #22c55e !important; font-weight: 800 !important; color: #15803d !important; }
        .field-highlight-2 input { background-color: #fff7ed !important; border-color: #f97316 !important; font-weight: 800 !important; color: #c2410c !important; }

        /* Row Highlighting & Indentation Styles */
        .lao-indent {
            padding-left: 1.5rem !important;
            padding-right: 0.5rem !important;
            margin-bottom: 2px;
            border-left: none !important;
        }
        .bg-light-green { background-color: #f0fdf4 !important; }
        .bg-light-orange { background-color: #fff7ed !important; }
        .bg-light-purple { background-color: #f5f3ff !important; }
        .bg-light-yellow { background-color: #fefce8 !important; border-top: 2px solid #1e3a8a !important; }

        @media print {
            @page { size: auto; margin: 0mm; } 
            html, body { height: auto !important; overflow: visible !important; background: white !important; }
            
            body > *:not(#app-content) { display: none !important; }
            header, aside, #editor-content, #empty-state, .no-print, button, select, 
            input:not([type="hidden"]), #bulk-action-management, .max-w-6xl > div:first-child { 
                display: none !important; 
            }
            
            #app-content, #view-payroll, #payroll-workspace, #editor-area { 
                display: block !important; 
                height: auto !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 0 !important; 
                background: white !important;
                position: static !important;
                overflow: visible !important;
            }

            #preview-pane { 
                display: block !important; 
                position: relative !important; 
                width: 100% !important; 
                margin: 0 !important; 
                padding: 15mm !important; 
                border: none !important; 
                box-shadow: none !important;
                background: white !important;
                visibility: visible !important;
                opacity: 1 !important;
                font-size: 12pt !important;
                /* Force Print Colors */
                -webkit-print-color-adjust: exact !important; 
                print-color-adjust: exact !important;
            }

            /* Ensure all elements inside preview pane print exactly as seen */
            #preview-pane * { 
                visibility: visible !important; 
                opacity: 1 !important; 
            }

            /* Specifically force colored backgrounds and text colors */
            .bg-blue-900 { background-color: #1e3a8a !important; color: white !important; }
            .bg-blue-50 { background-color: #eff6ff !important; }
            .bg-red-50 { background-color: #fef2f2 !important; }
            .bg-green-100 { background-color: #dcfce7 !important; }
            .bg-orange-100 { background-color: #ffedd5 !important; }
            .bg-purple-100 { background-color: #f3e8ff !important; }
            .bg-yellow-50 { background-color: #fefce8 !important; }

            .text-red-600 { color: #dc2626 !important; }
            .text-red-700 { color: #b91c1c !important; }
            .text-red-800 { color: #991b1b !important; }
            .text-red-900 { color: #7f1d1d !important; }
            .text-blue-900 { color: #1e3a8a !important; }
            .text-green-900 { color: #14532d !important; }
            .text-orange-900 { color: #7c2d12 !important; }
            .text-purple-900 { color: #581c87 !important; }
            
            /* Specific fix for English Salary Pay text */
            .text-white { color: white !important; }

            .print-info-container { 
                display: grid !important; 
                grid-template-columns: 1fr 1fr !important; 
                gap: 15px !important; 
                margin-bottom: 20px !important; 
                background-color: #eff6ff !important; 
                padding: 15px !important; 
                border-radius: 8px !important;
                border: 1px solid #dbeafe !important;
            }

            #net-pay-block { color: white !important; }
            #prev-name { font-size: 14pt !important; font-weight: 700 !important; color: #1e3a8a !important; display: block !important; margin-bottom: 2px !important; }
            #prev-pos, #prev-dept, #prev-id { font-size: 11pt !important; font-weight: 700 !important; color: #1e3a8a !important; display: block !important; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900 h-screen flex flex-col overflow-hidden theme-default">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-blue-900 text-white flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-center animate-pulse">
            <h1 class="text-2xl font-bold">Neerada Payroll</h1>
            <p class="text-sm opacity-75 mt-2">Loading Unified System v2026...</p>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="flex flex-col h-full hidden">
        
        <!-- Header / Nav -->
        <header class="bg-blue-900 text-white p-3 md:p-4 shadow-md flex justify-between items-center z-20 shrink-0">
            <div class="flex items-center gap-4">
                <button id="mobile-back-btn" onclick="window.goBack()" class="lg:hidden p-1.5 bg-blue-800 rounded-full hover:bg-blue-700 hidden">
                    <i data-lucide="chevron-left" class="w-5 h-5 text-white"></i>
                </button>
                <div class="bg-white/10 p-2 rounded-full hidden md:block">
                    <i data-lucide="dollar-sign" class="w-5 h-5 text-yellow-400"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Neerada Payroll</h1>
                    <p class="text-[10px] text-blue-300 hidden md:block">Unified System v2026</p>
                </div>
                
                <div class="hidden md:flex bg-blue-800 rounded-lg p-1 ml-6">
                    <button id="tab-dashboard" onclick="window.switchView('dashboard')" class="px-4 py-1.5 text-sm font-medium rounded-md bg-blue-800 text-white transition-colors">Dashboard</button>
                    <button id="tab-payroll" onclick="window.switchView('payroll')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">Staff Manager</button>
                    <button id="tab-config" onclick="window.switchView('config')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">Payslip Data</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.openSettings()" class="p-2 rounded-full hover:bg-blue-800 transition-colors" title="Settings">
                    <i data-lucide="settings" class="w-5 h-5 text-blue-100"></i>
                </button>
                <div class="md:hidden flex gap-2">
                      <button onclick="window.switchView('dashboard')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700 text-white">Dash</button>
                      <button onclick="window.switchView('payroll')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700 text-white">Staff</button>
                      <button onclick="window.switchView('config')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700 text-white">Data</button>
                </div>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-blue-800 rounded-lg text-xs font-medium border border-blue-700 hidden md:flex text-white">
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    <span id="date-display">...</span>
                </div>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="flex-1 overflow-y-auto p-4 lg:p-8">
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Financial Overview</h2>
                        <p class="text-gray-500 text-sm">Combined Monthly Payroll Track</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <div class="flex bg-white rounded-md shadow-sm border border-gray-200">
                            <select id="filter-year" onchange="window.updateDashboardStats()" class="bg-transparent text-sm font-medium text-gray-700 p-2 outline-none border-r border-gray-200"></select>
                            <select id="filter-month" onchange="window.updateDashboardStats()" class="bg-transparent text-sm font-medium text-gray-700 p-2 outline-none">
                                <option value="All">All Months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <button onclick="window.openSaveHistoryModal()" class="flex items-center justify-center gap-2 bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition text-sm font-medium">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Monthly Run
                        </button>
                        <button onclick="window.downloadCSVReport()" class="flex items-center justify-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition text-sm font-medium ml-2" title="Download CSV Report">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export CSV
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-6 gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-2">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Paid (LAK)</p>
                        <p id="stat-total-paid-lak" class="text-2xl font-mono font-bold text-blue-900 mt-2 whitespace-nowrap overflow-x-auto">₭ 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-2">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Paid (USD)</p>
                        <p id="stat-total-paid-usd" class="text-2xl font-mono font-bold text-green-700 mt-2 whitespace-nowrap overflow-x-auto">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-1">
                        <p class="text-xs font-bold text-gray-400 uppercase">Staff Count</p>
                        <p id="stat-employees" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200 md:col-span-1">
                        <p class="text-xs font-bold text-gray-400 uppercase">Latest Record</p>
                        <div class="flex flex-col mt-2">
                            <span id="stat-last-month" class="text-sm font-bold text-gray-800">No Data</span>
                            <span id="stat-last-amount" class="text-xs text-gray-500">---</span>
                        </div>
                    </div>
                </div>

                <div id="dept-breakdown" class="mt-8"></div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-8">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-gray-700">Payment History Logs</h3>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 w-full text-gray-500 text-xs uppercase font-medium">
                            <tr>
                                <th class="px-4 py-3">Period</th>
                                <th class="px-4 py-3">Staff</th>
                                <th class="px-4 py-3 text-right">Total LAK</th>
                                <th class="px-4 py-3 text-right">Total USD</th>
                                <th class="px-4 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONFIGURATION VIEW -->
        <div id="view-config" class="flex-1 overflow-y-auto p-4 lg:p-8 hidden bg-gray-50">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden mb-8">
                    <div class="p-6 border-b border-gray-200 flex justify-between items-center text-blue-900">
                        <h2 class="text-xl font-bold flex items-center gap-3">
                            <i data-lucide="file-spreadsheet" class="w-6 h-6 text-yellow-600"></i> Payroll Structure Management
                        </h2>
                        <button onclick="window.addNewDept()" class="bg-indigo-600 text-white px-4 py-2 rounded text-sm font-bold shadow hover:bg-indigo-700 flex items-center gap-2">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> New Dept
                        </button>
                    </div>
                    <div class="p-6">
                        <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100 flex items-end gap-2">
                            <div class="flex-1">
                                <label class="block text-xs font-bold text-blue-800 uppercase mb-2">Select Department to Edit</label>
                                <select id="config-dept-select" onchange="window.loadDeptConfig()" class="w-full p-2 border rounded bg-white text-sm"></select>
                            </div>
                            <button onclick="window.renameDept()" class="bg-blue-50 text-blue-700 border border-blue-200 p-2 rounded hover:bg-blue-100 transition-colors" title="Rename Department">
                                <i data-lucide="edit-3" class="w-5 h-5"></i>
                            </button>
                            <button onclick="window.deleteDept()" class="bg-red-50 text-red-600 border border-red-200 p-2 rounded hover:bg-red-100 transition-colors" title="Delete Department">
                                <i data-lucide="trash-2" class="w-5 h-5"></i>
                            </button>
                        </div>

                        <div id="config-editor-area" class="grid grid-cols-1 md:grid-cols-2 gap-8"></div>

                        <div class="mt-8 flex justify-end gap-3 pt-6 border-t border-gray-100">
                            <button onclick="window.saveDeptConfig()" class="bg-blue-600 text-white px-8 py-2.5 rounded hover:bg-blue-700 flex items-center gap-2 font-bold shadow-md transition-all">
                                <i data-lucide="save" class="w-5 h-5"></i> Apply Changes Globally
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAYROLL MANAGER VIEW -->
        <div id="view-payroll" class="flex-1 overflow-hidden relative hidden">
            <div class="flex h-full flex-col lg:flex-row">
                <aside class="hidden xl:flex w-64 bg-gray-50 border-r border-gray-200 flex-col z-10 h-full overflow-y-auto">
                    <div class="p-4 border-b border-gray-100 bg-gray-100 sticky top-0">
                                <h2 class="font-bold text-gray-700 text-xs uppercase tracking-wider">Departments</h2>
                    </div>
                    <div id="dept-tree" class="p-2 space-y-1"></div>
                </aside>

                <aside id="sidebar" class="w-full lg:w-72 bg-white border-r border-gray-200 flex flex-col z-10 h-[35vh] lg:h-full">
                    <div class="p-4 border-b border-gray-100 bg-white flex flex-col gap-3 shrink-0">
                        <div class="flex justify-between items-center">
                            <h2 class="font-semibold text-gray-700 flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4"></i> Staff List
                            </h2>
                            <div class="flex gap-1">
                                <button onclick="window.downloadCSVTemplate()" title="Download CSV Template" class="p-1 hover:bg-blue-100 rounded text-green-600 transition-colors">
                                    <i data-lucide="file-text" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.triggerImport()" title="Import Staff CSV" class="p-1 hover:bg-blue-100 rounded text-blue-600 transition-colors">
                                    <i data-lucide="upload" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.deleteAllPhotos()" title="Delete All Photos" class="p-1 hover:bg-red-100 rounded text-red-600 transition-colors">
                                    <i data-lucide="image-off" class="w-4 h-4"></i>
                                </button>
                                <button onclick="window.openStaffModal(null)" title="Add Staff" class="p-1 hover:bg-blue-100 rounded text-blue-600 transition-colors">
                                    <i data-lucide="plus" class="w-4 h-4"></i>
                                </button>
                            </div>
                            <input type="file" id="staff-csv-input" accept=".csv" class="hidden" onchange="window.handleStaffCSV(this)">
                        </div>
                    </div>

                    <div id="bulk-action-management" class="p-4 border-b border-gray-100 bg-white shadow-inner shrink-0">
                        <h3 class="text-xs font-bold text-gray-600 mb-3 flex items-center gap-2 uppercase tracking-tight">
                            <i data-lucide="database" class="w-3.5 h-3.5 text-indigo-600"></i> Filtered Data Actions
                        </h3>
                        <div class="text-[9px] text-gray-500 mb-3 uppercase font-semibold">Targets: <span id="current-filter-label" class="text-blue-800 font-bold">All Staff</span></div>

                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.bulkSavePayroll()" class="col-span-2 flex items-center justify-center gap-2 py-2 bg-indigo-600 text-white font-bold rounded shadow-sm hover:bg-indigo-700 transition text-xs">
                                <i data-lucide="save-all" class="w-3.5 h-3.5"></i> Save All to History
                            </button>
                            <button onclick="window.bulkResetPayroll()" class="flex items-center justify-center gap-2 py-2 bg-yellow-50 text-yellow-700 border border-yellow-200 font-bold rounded shadow-sm hover:bg-yellow-100 transition text-[10px]">
                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset Data
                            </button>
                            <button id="delete-dept-button" onclick="window.deleteAllEmployeesInFilter()" class="flex items-center justify-center gap-2 py-2 bg-red-50 text-red-700 border border-red-200 font-bold rounded shadow-sm hover:bg-red-100 transition text-[10px]">
                                <i data-lucide="trash-2" class="w-3.5 h-3.5"></i> Delete All
                            </button>
                        </div>
                    </div>

                    <div id="filter-status" class="px-4 py-2 bg-blue-50 text-xs text-blue-800 border-b border-blue-100 hidden flex justify-between items-center">
                        <span id="filter-label" class="font-medium truncate">All Staff</span>
                        <button onclick="window.clearFilter()" class="text-blue-500 hover:text-blue-700"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                    <div id="employee-list" class="flex-1 overflow-y-auto p-2"></div>
                </aside>

                <main id="payroll-workspace" class="flex-1 overflow-y-auto bg-gray-100 p-4 lg:p-6 block">
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                            <i data-lucide="briefcase" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <p>Select an employee to view details.</p>
                    </div>

                    <div id="editor-area" class="w-full max-w-6xl mx-auto flex flex-col xl:flex-row gap-6 hidden">
                        <div class="w-full xl:w-1/3 space-y-4 no-print flex flex-col h-full">
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4 flex items-center justify-between">
                                <div class="text-xs font-bold text-blue-800 uppercase tracking-wide">Period</div>
                                <div class="flex gap-2">
                                    <select id="editor-month" onchange="window.loadPeriodData()" class="text-xs border rounded p-1 bg-white outline-none"></select>
                                    <select id="editor-year" onchange="window.loadPeriodData()" class="text-xs border rounded p-1 bg-white outline-none"></select>
                                </div>
                            </div>

                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4">
                                <div class="grid grid-cols-1 gap-2">
                                    <button onclick="window.viewEmployeeHistory()" class="flex items-center justify-center gap-2 w-full py-2 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 text-sm font-medium mb-1">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4"></i> View History Dashboard
                                    </button>
                                    <button onclick="window.editCurrentStaff()" class="flex items-center justify-center gap-2 w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                                        <i data-lucide="user-cog" class="w-4 h-4"></i> Edit Staff Details
                                    </button>
                                    <button onclick="window.loadPreviousMonthData()" class="flex items-center justify-center gap-2 w-full py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded hover:bg-orange-100 text-sm font-medium">
                                        <i data-lucide="copy" class="w-4 h-4"></i> Copy from Previous Month
                                    </button>
                                    <button onclick="window.saveEmployeePayrollData()" class="flex items-center justify-center gap-2 w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium">
                                        <i data-lucide="save" class="w-4 h-4"></i> Save Month Data
                                    </button>
                                    <button onclick="window.resetCurrentPayroll()" class="flex items-center justify-center gap-2 w-full py-2 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 text-sm">
                                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset Data
                                    </button>
                                    <div class="grid grid-cols-3 gap-2 mt-1">
                                        <button onclick="window.openPrintSettings()" title="Print Settings" class="flex items-center justify-center py-2 bg-gray-800 text-white rounded hover:bg-gray-900 text-sm"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                        <button onclick="window.sendEmail()" title="Email Payslip" class="flex items-center justify-center py-2 bg-blue-500 text-white rounded hover:bg-blue-600 text-sm"><i data-lucide="mail" class="w-4 h-4"></i></button>
                                        <button onclick="window.sendWhatsApp()" title="WhatsApp" class="flex items-center justify-center py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            </div>
                            <div id="editor-content" class="flex-1 overflow-y-auto"></div>
                        </div>

                        <!-- Live Preview -->
                        <div id="preview-pane" class="w-full xl:w-2/3 bg-white p-6 md:p-8 rounded shadow-lg border border-gray-200 text-xs md:text-sm">
                            <div class="border-b-2 border-blue-900 pb-4 mb-4 flex justify-between items-start">
                                <div class="flex items-center gap-4">
                                    <img id="prev-school-logo" class="h-16 w-auto hidden object-contain">
                                    <div>
                                        <h1 class="text-xl md:text-2xl font-bold text-blue-900 uppercase tracking-widest">Neerada School</h1>
                                        <p class="text-gray-500 text-xs mt-1">Excellence in Education</p>
                                        <div class="flex items-center gap-2 text-gray-400 text-[10px] mt-1">
                                            <i data-lucide="building" class="w-3 h-3"></i>
                                            <span id="prev-campus">Campus</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end">
                                    <img id="prev-profile-pic" class="h-16 w-16 object-cover rounded-full border mb-2 hidden bg-gray-100">
                                    <div class="text-right">
                                        <h2 class="text-lg font-semibold text-gray-800">PAYSLIP</h2>
                                        <p class="text-xs text-gray-600">Date: <span id="prev-date" class="font-bold"></span></p>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-6 bg-blue-50 p-3 rounded-lg print-info-container">
                                <div><p class="text-[10px] text-gray-500 uppercase">Employee Name</p><p id="prev-name" class="text-gray-800 text-sm font-bold">---</p></div>
                                <div><p class="text-[10px] text-gray-500 uppercase">Position</p><p id="prev-pos" class="font-bold text-gray-800 text-sm">---</p></div>
                                <div><p class="text-[10px] text-gray-500 uppercase">Department</p><p id="prev-dept" class="font-bold text-gray-800 text-sm">---</p></div>
                                <div><p class="text-[10px] text-gray-500 uppercase">Employee ID</p><p id="prev-id" class="text-gray-800 font-mono text-sm">---</p></div>
                            </div>
                            
                            <div id="preview-content"></div>
                            <div id="print-footer" class="mt-8 text-center text-[10px] text-gray-400">
                                <p>Computer-generated. No signature required.</p>
                                <p>© <span id="copyright-year"></span> Neerada School Payroll System</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="add-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md max-h-[90vh] overflow-y-auto">
            <h2 id="modal-title" class="text-xl font-bold mb-4 text-blue-900">Staff Details</h2>
            <form id="add-form" onsubmit="window.saveEmployee(event)" class="space-y-4">
                <input type="hidden" name="id" id="form-id">
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-full bg-gray-100 border flex items-center justify-center overflow-hidden">
                        <img id="form-preview-pic" class="w-full h-full object-cover hidden">
                        <i data-lucide="user" id="form-default-icon" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <div class="flex-1 space-y-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Profile Photo</label>
                        <input type="file" id="form-profile-pic" accept="image/*" onchange="window.handleProfileUpload(this)" class="w-full text-xs text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <button type="button" id="delete-modal-photo-btn" onclick="window.clearModalPhoto()" class="text-[10px] text-red-500 hover:text-red-700 underline font-medium mt-1 hidden">Remove Photo</button>
                    </div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label><input required name="name" id="form-name" type="text" class="w-full border rounded p-2 text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Campus</label>
                        <select name="campus" id="form-campus" class="w-full border rounded p-2 text-sm bg-gray-50" onchange="window.filterModalDepts()">
                            <option>Sibounheuang</option>
                            <option>Chommany</option>
                            <option>General Services</option>
                        </select>
                    </div>
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Department</label><select name="department" id="form-department" onchange="window.toggleBankFields()" class="w-full border rounded p-2 text-sm bg-white"></select></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label><input required name="position" id="form-position" type="text" class="w-full border rounded p-2 text-sm"></div>
                <div class="grid grid-cols-2 gap-4">
                    <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">LAK Bank Account</label><input name="bankLak" id="form-bank-lak" type="text" class="w-full border rounded p-2 text-sm"></div>
                    <div id="bank-usd-container" class="hidden"><label class="block text-xs font-bold text-gray-500 mb-1">USD Bank Account</label><input name="bankUsd" id="form-bank-usd" type="text" class="w-full border rounded p-2 text-sm"></div>
                </div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label><input name="email" id="form-email" type="email" class="w-full border rounded p-2 text-sm"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-1">WhatsApp</label><input name="whatsapp" id="form-whatsapp" type="text" class="w-full border rounded p-2 text-sm"></div>
                <div class="pt-4 flex gap-3"><button type="button" onclick="window.closeModal()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button><button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium">Save Staff</button></div>
            </form>
        </div>
    </div>

    <div id="employee-history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[80vh] flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-start shrink-0">
                <div><h2 class="text-xl font-bold text-gray-800 flex items-center gap-2"><i data-lucide="bar-chart-2" class="w-5 h-5 text-blue-600"></i><span id="hist-emp-name">Employee History</span></h2><p id="hist-emp-dept" class="text-sm text-gray-500">Department</p></div>
                <button onclick="document.getElementById('employee-history-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-6 h-6"></i></button>
            </div>
            <div class="p-6">
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100"><p class="text-xs font-bold text-blue-800 uppercase">Total Earned (LAK)</p><p id="hist-total-lak" class="text-2xl font-mono font-bold text-blue-900 mt-1">₭ 0</p></div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100"><p class="text-xs font-bold text-green-800 uppercase">Total Earned (USD)</p><p id="hist-total-usd" class="text-2xl font-mono font-bold text-green-900 mt-1">$0.00</p></div>
                </div>
                <div id="hist-rows" class="overflow-y-auto max-h-[50vh] flex-1 space-y-2"></div>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4"><h2 class="text-xl font-bold text-gray-800">Settings</h2><button onclick="window.closeSettings()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button></div>
            <div class="space-y-6">
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">App Theme</label><select id="theme-select" onchange="window.setTheme(this.value)" class="w-full border rounded p-2 text-sm bg-white"><option value="default">Default Blue</option><option value="emerald">Emerald Green</option><option value="rose">Rose Red</option><option value="slate">Slate Dark</option><option value="violet">Violet</option></select></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">School Logo</label><input type="file" accept="image/*" onchange="window.handleLogoUpload(this)" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100"></div>
                <div><label class="block text-xs font-bold text-gray-500 uppercase mb-2">Data Management</label><div class="grid grid-cols-1 gap-2"><button onclick="window.exportData()" class="flex items-center justify-center gap-2 w-full py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded hover:bg-blue-100 text-sm font-medium"><i data-lucide="download" class="w-4 h-4"></i> Export Backup</button><button onclick="document.getElementById('import-file').click()" class="flex items-center justify-center gap-2 w-full py-2 bg-gray-50 text-gray-700 border border-gray-200 rounded hover:bg-gray-100 text-sm font-medium"><i data-lucide="upload" class="w-4 h-4"></i> Import Restore</button><input type="file" id="import-file" accept=".json" class="hidden" onchange="window.importData(this)"></div></div>
            </div>
            <p class="text-[10px] text-gray-400 mt-6 text-center">Neerada GS Payroll System v2026</p>
        </div>
    </div>

    <!-- Modal: Print Settings -->
    <div id="print-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[150] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Print Settings</h2>
            <div class="space-y-6">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Orientation</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="print-orient" value="portrait" checked class="text-blue-600"><span class="text-sm">Portrait</span></label>
                        <label class="flex items-center gap-2 cursor-pointer"><input type="radio" name="print-orient" value="landscape" class="text-blue-600"><span class="text-sm">Landscape</span></label>
                    </div>
                </div>
                <div>
                    <div class="flex justify-between items-center mb-2"><label class="block text-xs font-bold text-gray-500 uppercase">Page Scale</label><span id="scale-val" class="text-xs font-mono font-bold text-blue-600">100%</span></div>
                    <input type="range" id="print-scale" min="50" max="150" value="100" class="w-full accent-blue-600" oninput="document.getElementById('scale-val').innerText = this.value + '%'">
                </div>
                <div class="pt-2 flex gap-3">
                    <button onclick="window.closePrintSettings()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button onclick="window.executePrint()" class="flex-1 py-2 bg-gray-800 text-white rounded hover:bg-gray-900 font-medium flex items-center justify-center gap-2"><i data-lucide="printer" class="w-4 h-4"></i> Print Now</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Modal -->
    <div id="save-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold mb-4 text-blue-900">Save Payroll Run</h2>
            <form onsubmit="window.savePayrollHistory(event)" class="space-y-4">
                <select id="save-month" class="w-full border rounded p-2 text-sm bg-white"></select>
                <input id="save-year" type="number" class="w-full border rounded p-2 text-sm" value="2026">
                <button type="submit" class="w-full py-2 bg-green-600 text-white rounded font-medium mt-4">Save & Close</button>
            </form>
        </div>
    </div>

    <script src="https://unpkg.com/lucide@latest"></script>

    <script>
        // --- DATA STATE ---
        const DB_NAME = 'NeeradaCombinedDB_v1';
        const DB_VERSION = 1;
        const STORE_EMPLOYEES = 'employees';
        const STORE_HISTORY = 'history_logs';
        const STORE_CONFIG = 'department_configs';
        
        // Campus-Department Mapping
        const ACADEMIC_DEPTS = ['Kindergarten', 'Primary', 'Secondary', 'English', 'Academic Head - Kinder', 'Academic Head - Primary', 'Academic Head - HS', 'Vice Principal'];
        const GS_DEPTS = [
            'Accounts (ບັນຊີ)', 
            'Admin (ບໍລິຫານ)', 
            'Secretary (ເລຂານຸການ)', 
            'Invitational Teachers (ຄູຮັບເຊີນ)', 
            'Cooks (ແມ່ຄົວ)', 
            'Cleaners (ພະນັກງານອະນາໄມ)', 
            'Drivers (ພະນັກງານຂັບລົດ)', 
            'Repair (ສ້ອມແປງ)'
        ];
        // Combine for initialization
        const DEFAULT_DEPTS = [...ACADEMIC_DEPTS, ...GS_DEPTS];

        const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const CAMPUSES = ['Sibounheuang', 'Chommany', 'General Services'];
        
        const LAO_FIELDS = {
            research: 'ດຸໝັ່ນຄົ້ນຄວ້າ&ພັດທະນາການສອນ (ຮູ້ນໍາໃຊ້ເຕັກນິກເພື່ອເຮັດໃຫ້ ນຮ ມັກຮຽນ)',
            media: 'ນຳໃຊ້ສື່ການສອນ/ແຕ່ງບົດສອນ/ຕິດຕາມພັດທະນາການ ນຮ.ຫ້າວຫັນໃນການປະກອບສ່ວນໃນວຽກອື່ນໆຂອງໂຮງຮຽນ',
            behaviorBasic: 'ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ໃສ່ใจນຳ ນັກຮຽນ', 
            classResp: 'ຄວາມຮັບຜິດຊອບໃນຫ້ອງຮຽນ : ທຸກໆຢ່າງ',
            policy: 'ນະໂຍບາຍອື່ນໆ',
            basic: 'ເງີນເດືອນພື້ນຖານ', 
            cert: 'ໃບປະກາດ (ປຕີ/ຊັ້ນສູງ/ຊັ້ນກາງ)',
            homeroom: 'ຄູປະຈຳຫ້ອງ/ຄູປະຈຳຫ້ອງສະໝຸດ/ຄູປະຈຳເດີ່ນກິລາ',
            behaviorStart: 'ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ນຮ/ໃສ່ใจນຳນັກຮຽນ',
            start: 'ເລີ້ມຕົ້ນ',
            accumulated: 'ເງີນສະສົມປີຜ່ານມາ',
            increase: 'ເພີ້ມປະຈຳປີ 2025-2026'
        };
        const laoEarningsStruct = [ LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy, LAO_FIELDS.basic, LAO_FIELDS.cert, LAO_FIELDS.homeroom, LAO_FIELDS.behaviorStart, LAO_FIELDS.start, LAO_FIELDS.accumulated, LAO_FIELDS.increase ];
        
        // Deduction labels
        const defaultDeductions = [
            'ຫັກເງີນອາກອນ 5% (ຕາມເງີນເດືອນຕົວຈິງ)',
            'ຫັກປະກັນສັງຄົມ 5.5%',
            'ມາຊ້າ',
            'Others ອື່ນໆ'
        ];

        let db = null;
        let employees = [];
        let history = [];
        let departmentConfigs = {};
        let selectedEmployee = null;
        let currentPayrollState = {};
        let currentFilter = { campus: 'All', department: 'All' };
        let editorMonth = "";
        let editorYear = new Date().getFullYear();
        let tempProfilePic = null;

        async function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onupgradeneeded = (e) => {
                    const db = e.target.result;
                    if(!db.objectStoreNames.contains(STORE_EMPLOYEES)) db.createObjectStore(STORE_EMPLOYEES, { keyPath: 'id' });
                    if(!db.objectStoreNames.contains(STORE_HISTORY)) db.createObjectStore(STORE_HISTORY, { keyPath: 'dateId' });
                    if(!db.objectStoreNames.contains(STORE_CONFIG)) db.createObjectStore(STORE_CONFIG, { keyPath: 'name' });
                };
                request.onsuccess = (e) => { db = e.target.result; resolve(db); };
                request.onerror = (e) => reject(e.target.error);
            });
        }

        async function transact(storeName, mode, op) {
            if(!db) await openDB();
            const tx = db.transaction(storeName, mode);
            const store = tx.objectStore(storeName);
            const req = op(store);
            return new Promise((res, rej) => {
                req.onsuccess = () => res(req.result);
                req.onerror = () => rej(req.error);
            });
        }

        async function initApp() {
            try {
                await openDB();
                const configs = await transact(STORE_CONFIG, 'readonly', (s) => s.getAll());
                if (configs.length === 0) {
                    for (const d of DEFAULT_DEPTS) {
                        let earnings = [...laoEarningsStruct];
                        let deductions = [...defaultDeductions];
                        
                        if (d.includes('Accounts')) {
                            earnings = ['Basic Pay (USD)', 'Exchange Rate (LAK)', 'ເງີນເດືອນພື້ນຖານ', 'ສະສົມປີຜ່ານມາ', 'ເພີ້ມປະຈຳປີ 2025-2026', 'ບໍລິຫານຫ້ອງການ/ບັນຊີ', 'ດຸໝັ່ນມາການ (ບໍ່ຂາດການ)', 'ພົວພັນວຽກທາງນອກ-ພາຍໃນ', 'ບັນຊີ ການເງີນວຽກອື່ນໆຂອງໂຮງຮຽນ'];
                        } else if (d.includes('Invitational Teachers')) {
                            earnings = ['ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)', 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)', 'ເງີນເດືອນ'];
                        } else if (d === 'English') {
                            earnings = []; // Special Handling
                            deductions = [];
                        }
                        
                        const cfg = { name: d, earnings, deductions };
                        await transact(STORE_CONFIG, 'readwrite', (s) => s.put(cfg));
                        departmentConfigs[d] = cfg;
                    }
                } else { 
                    configs.forEach(c => departmentConfigs[c.name] = c);
                }

                employees = await transact(STORE_EMPLOYEES, 'readonly', (s) => s.getAll());
                history = await transact(STORE_HISTORY, 'readonly', (s) => s.getAll());

                const savedTheme = localStorage.getItem('neerada_theme') || 'default';
                document.body.className = `bg-gray-100 font-sans text-gray-900 h-screen flex flex-col overflow-hidden theme-${savedTheme}`;
                
                // Load saved logo
                const savedLogo = localStorage.getItem('neerada_school_logo');
                if (savedLogo) {
                    const logoEl = document.getElementById('prev-school-logo');
                    if (logoEl) {
                        logoEl.src = savedLogo;
                        logoEl.classList.remove('hidden');
                    }
                }

                setupYearSelectors(); 
                setupMonthSelectors();
                window.updateDashboardStats(); 
                renderDeptSidebar(); 
                renderEmployeeList();
                
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                if (window.lucide) lucide.createIcons();
                updateDateWidget();
                document.getElementById('copyright-year').innerText = new Date().getFullYear();
            } catch(e) { console.error("Init fail:", e); }
        }

        function getOrderedDepartments() {
            const allDepts = Object.keys(departmentConfigs);
            return allDepts.sort((a, b) => {
                const indexA = DEFAULT_DEPTS.indexOf(a);
                const indexB = DEFAULT_DEPTS.indexOf(b);
                if (indexA !== -1 && indexB !== -1) return indexA - indexB;
                if (indexA !== -1) return -1;
                if (indexB !== -1) return 1;
                return a.localeCompare(b);
            });
        }

        function setupYearSelectors() {
            const yr = new Date().getFullYear();
            const endYear = Math.max(2030, yr + 1);
            let opts = "";
            for (let i = yr - 2; i <= endYear; i++) {
                opts += `<option value="${i}">${i}</option>`;
            }
            
            const fy = document.getElementById('filter-year'); if(fy) fy.innerHTML = `<option value="All">All Years</option>` + opts;
            const ey = document.getElementById('editor-year'); if(ey) { ey.innerHTML = opts; ey.value = yr; }
            const sy = document.getElementById('save-year'); if(sy) sy.value = yr;
            editorYear = yr;
        }

        function setupMonthSelectors() {
            const m = MONTHS[new Date().getMonth()];
            const opts = MONTHS.map(mn => `<option value="${mn}">${mn}</option>`).join('');
            const fm = document.getElementById('filter-month'); if(fm) fm.innerHTML = `<option value="All">All Months</option>` + opts;
            const em = document.getElementById('editor-month'); if(em) { em.innerHTML = opts; em.value = m; }
            const sm = document.getElementById('save-month'); if(sm) sm.innerHTML = opts;
            editorMonth = m;
        }

        function updateDateWidget() { 
            const el = document.getElementById('date-display');
            if(el) el.innerText = new Date().toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); 
        }
        
        function formatMoney(n) { return '₭ ' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2}); }
        function formatUSD(n) { return '$' + parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2}); }

        function generateEmployeeID(emp, month, year) {
            let campusCode = "GENSERV";
            if (emp.campus === "Sibounheuang") campusCode = "SBH";
            else if (emp.campus === "Chommany") campusCode = "CHM";
            
            const deptCode = (emp.department || "U").charAt(0).toUpperCase();
            const nameCode = (emp.name || "STAFF").split(' ')[0].toUpperCase();
            const monthCode = month.substring(0, 3).toUpperCase();
            const yearCode = year.toString().slice(-2);
            
            return `${campusCode}-${deptCode}-${nameCode}-${monthCode}-${yearCode}`;
        }

        function renderDeptSidebar() {
            const tree = document.getElementById('dept-tree'); if(!tree) return;
            const currentDepts = getOrderedDepartments();
            let html = `<div onclick="window.setFilter('All', 'All')" class="cursor-pointer px-3 py-2 rounded mb-2 text-sm flex justify-between items-center gap-2 ${currentFilter.campus === 'All' && currentFilter.department === 'All' ? 'bg-blue-100 text-blue-800 font-bold' : 'text-gray-600 hover:bg-gray-200'}"><div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> All Staff</div><span class="text-xs bg-black/10 px-1.5 py-0.5 rounded-full font-mono">${employees.length}</span></div>`; 
            
            CAMPUSES.forEach(campus => { 
                html += `<div class="mt-4 mb-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider flex justify-between items-center cursor-pointer text-blue-800 bg-blue-100 hover:bg-blue-200 transition-colors shadow-sm" onclick="window.setFilter('${campus}', 'All')">${campus}<i data-lucide="chevron-down" class="w-3 h-3 text-blue-500"></i></div>`; 
                
                // Determine target departments for this campus
                let targetDepts = [];
                if (campus === 'General Services') {
                    targetDepts = GS_DEPTS;
                } else {
                    targetDepts = ACADEMIC_DEPTS;
                }

                // Filter available departments to match the target list for this campus
                const deptsToShow = currentDepts.filter(d => targetDepts.includes(d));

                deptsToShow.forEach(dept => { 
                    const count = employees.filter(e => e.campus === campus && e.department === dept).length; 
                    const isActive = currentFilter.campus === campus && currentFilter.department === dept;
                    html += `<div onclick="window.setFilter('${campus}', '${dept}')" class="cursor-pointer px-3 py-1.5 rounded ml-2 text-sm transition-colors flex justify-between items-center ${isActive ? 'bg-white shadow-sm text-blue-700 font-medium border-l-2 border-blue-500' : 'text-gray-500 hover:bg-gray-200 border-l-2 border-transparent'}"><span>${dept}</span><span class="text-[10px] ${isActive ? 'bg-blue-50 text-blue-600' : 'bg-gray-100 text-gray-400'} px-1.5 py-0.5 rounded-full font-mono">${count}</span></div>`; 
                }); 
            }); 
            tree.innerHTML = html;
            
            const bl = document.getElementById('current-filter-label'); if(bl) bl.innerText = currentFilter.department !== 'All' ? `${currentFilter.department} (${currentFilter.campus})` : 'All Staff';
            const delBtn = document.getElementById('delete-dept-button');
            if (delBtn) { if (currentFilter.department !== 'All') { delBtn.disabled = false; delBtn.classList.remove('opacity-50'); } else { delBtn.disabled = true; delBtn.classList.add('opacity-50'); } }
            if (window.lucide) lucide.createIcons();
        }

        window.setFilter = (c, d) => { currentFilter = { campus: c, department: d }; renderDeptSidebar(); renderEmployeeList(); };
        window.clearFilter = () => window.setFilter('All', 'All');

        function renderEmployeeList() {
            const list = document.getElementById('employee-list'); if(!list) return;
            let filtered = employees;
            if (currentFilter.campus !== 'All') filtered = filtered.filter(e => e.campus === currentFilter.campus);
            if (currentFilter.department !== 'All') filtered = filtered.filter(e => e.department === currentFilter.department);
            
            list.innerHTML = filtered.map(emp => `
                <div onclick="window.selectEmployee('${emp.id}')" class="p-3 rounded-lg cursor-pointer transition-all border mb-2 ${selectedEmployee?.id === emp.id ? 'bg-blue-50 border-blue-200 shadow-sm' : 'bg-white border-transparent hover:bg-gray-50'}">
                    <div class="flex justify-between items-start">
                        <div class="flex items-center gap-3">
                            ${emp.profilePic ? `<img src="${emp.profilePic}" class="w-8 h-8 rounded-full object-cover">` : `<div class="w-8 h-8 rounded-full bg-gray-200 flex items-center justify-center"><i data-lucide="user" class="w-4 h-4 text-gray-400"></i></div>`}
                            <div>
                                <p class="font-bold text-gray-800 text-sm">${emp.name}</p>
                                <p class="text-xs text-blue-600 font-medium">${emp.department}</p>
                                <p class="text-[10px] text-gray-400 mt-1">Modified: ${emp.lastModified ? new Date(emp.lastModified).toLocaleDateString() : 'N/A'}</p>
                            </div>
                        </div>
                        <button onclick="event.stopPropagation(); window.deleteEmployee('${emp.id}')" class="text-gray-300 hover:text-red-500 p-1" title="Delete Staff"><i data-lucide="trash-2" class="w-3.5 h-3.5"></i></button>
                    </div>
                </div>
            `).join('');
            if (window.lucide) lucide.createIcons();
        }

        window.selectEmployee = (id) => { 
            selectedEmployee = employees.find(e => String(e.id) === String(id)); 
            loadPeriodData(); 
            document.getElementById('empty-state').classList.add('hidden'); 
            document.getElementById('editor-area').classList.remove('hidden'); 
            
            renderEmployeeList(); 
        };

        function loadPeriodData() {
            if (!selectedEmployee) return;
            const m = document.getElementById('editor-month').value; 
            const y = document.getElementById('editor-year').value;
            editorMonth = m; editorYear = y; 
            const key = `${y}-${m}`;
            currentPayrollState = (selectedEmployee.payrollHistory && selectedEmployee.payrollHistory[key]) ? JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[key])) : createInitialState(selectedEmployee.department);
            renderEditor();
        }

        function createInitialState(dept) {
            if (dept === 'English') {
                return { basicPay: 0, accumulated: 0, increase: 0, earningsOthersUSD: 0, otHours: 0, otRate: 0, itLAK: 0, extraWorkOthersLAK: 0, stipendLAK: 0, profTax: 0, absences: 0, visa: 0, deductionsOthersUSD: 0, insuranceLAK: 0, deductionsOthersLAK: 0, cashOut: 0, exchangeRate: 0, notes: "" };
            }
            const cfg = departmentConfigs[dept] || { earnings: [], deductions: [] }; 
            const state = {};
            cfg.earnings.forEach(f => state[f] = 0); 
            cfg.deductions.forEach(f => state[f] = 0);
            return state;
        }

        function renderEditor() {
            const container = document.getElementById('editor-content'); 
            const dept = selectedEmployee.department;
            
            if (dept === 'English') {
                renderEnglishEditor(container);
                renderPreview(); // Added to ensure preview updates on load
                return;
            }

            const cfg = departmentConfigs[dept] || { earnings: [], deductions: [] };
            const earns = cfg.earnings.map(f => {
                const isCalc = (f === LAO_FIELDS.basic || f === LAO_FIELDS.start || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ');
                const highlight = isCalc ? (f === LAO_FIELDS.basic || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ' ? 'field-highlight-1' : 'field-highlight-2') : '';
                return `<div class="${highlight}"><label class="block text-[10px] font-bold text-gray-500 mb-1 truncate" title="${f}">${f}</label><input type="number" ${isCalc ? 'readonly' : ''} data-field="${f}" oninput="window.updatePayrollField('${f}', this.value)" class="w-full text-sm border rounded p-1.5" value="${currentPayrollState[f] || 0}"></div>`;
            }).join('');
            const deds = cfg.deductions.map(f => `<div><label class="block text-[10px] font-bold text-gray-500 mb-1 truncate">${f}</label><input type="number" data-field="${f}" oninput="window.updatePayrollField('${f}', this.value)" class="w-full text-sm border rounded p-1.5 text-red-600" value="${currentPayrollState[f] || 0}"></div>`).join('');
            container.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4"><h3 class="font-bold text-gray-700 border-b pb-2 mb-3 text-xs uppercase">Earnings (LAK)</h3><div class="grid grid-cols-2 gap-3">${earns}</div></div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200"><h3 class="font-bold text-red-700 border-b pb-2 mb-3 text-xs uppercase">Deductions (LAK)</h3><div class="grid grid-cols-2 gap-3">${deds}</div></div>`;
            renderPreview();
        }

        function renderEnglishEditor(container) {
            const d = currentPayrollState;
            container.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-2 text-xs">
                    <div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-blue-700">Settings</h3><div class="flex gap-2"><div><label class="block text-[9px] font-bold mb-1">Rate</label><input type="number" value="${d.exchangeRate}" oninput="window.updatePayrollField('exchangeRate', this.value)" class="w-16 border rounded text-right p-1"></div><div><label class="block text-[9px] font-bold mb-1">CashOut</label><input type="number" value="${d.cashOut}" oninput="window.updatePayrollField('cashOut', this.value)" class="w-12 border rounded text-right p-1"></div></div></div>
                    <h3 class="font-bold text-gray-600 mt-2 mb-2">EARNINGS (USD)</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Basic Pay</label><input type="number" class="w-full border rounded p-1" value="${d.basicPay||0}" oninput="window.updatePayrollField('basicPay', this.value)"></div><div><label class="block font-bold mb-1">Accumulated</label><input type="number" class="w-full border rounded p-1" value="${d.accumulated||0}" oninput="window.updatePayrollField('accumulated', this.value)"></div><div><label class="block font-bold mb-1">Increase</label><input type="number" class="w-full border rounded p-1" value="${d.increase||0}" oninput="window.updatePayrollField('increase', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.earningsOthersUSD||0}" oninput="window.updatePayrollField('earningsOthersUSD', this.value)"></div></div>
                    <h3 class="font-bold text-gray-600 mt-4 mb-2">OVERTIME (USD)</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Total Hours</label><input type="number" class="w-full border rounded p-1" value="${d.otHours||0}" oninput="window.updatePayrollField('otHours', this.value)"></div><div><label class="block font-bold mb-1">Rate/Hr</label><input type="number" class="w-full border rounded p-1" value="${d.otRate||0}" oninput="window.updatePayrollField('otRate', this.value)"></div></div>
                    <h3 class="font-bold text-purple-700 mt-4 mb-2">EXTRA WORK (LAK)</h3><div class="grid grid-cols-3 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">IT</label><input type="number" class="w-full border rounded p-1" value="${d.itLAK||0}" oninput="window.updatePayrollField('itLAK', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.extraWorkOthersLAK||0}" oninput="window.updatePayrollField('extraWorkOthersLAK', this.value)"></div><div><label class="block font-bold mb-1">Stipend</label><input type="number" class="w-full border rounded p-1" value="${d.stipendLAK||0}" oninput="window.updatePayrollField('stipendLAK', this.value)"></div></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4 space-y-2 text-xs"><h3 class="font-bold text-red-700 border-b pb-2 mb-2">DEDUCTIONS</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Prof. Tax</label><input type="number" class="w-full border rounded p-1" value="${d.profTax||0}" oninput="window.updatePayrollField('profTax', this.value)"></div><div><label class="block font-bold mb-1">Absences</label><input type="number" class="w-full border rounded p-1" value="${d.absences||0}" oninput="window.updatePayrollField('absences', this.value)"></div><div><label class="block font-bold mb-1">Visa</label><input type="number" class="w-full border rounded p-1" value="${d.visa||0}" oninput="window.updatePayrollField('visa', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.deductionsOthersUSD||0}" oninput="window.updatePayrollField('deductionsOthersUSD', this.value)"></div></div><h4 class="font-bold text-red-500 mt-4 mb-2 text-[10px]">LAK DEDUCTIONS</h4><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Insurance</label><input type="number" class="w-full border rounded p-1" value="${d.insuranceLAK||0}" oninput="window.updatePayrollField('insuranceLAK', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.deductionsOthersLAK||0}" oninput="window.updatePayrollField('deductionsOthersLAK', this.value)"></div></div></div>
                <div class="mt-4"><label class="block text-xs font-bold text-gray-500 mb-1">Notes</label><textarea class="w-full border rounded p-2 text-xs" rows="2" oninput="window.updatePayrollField('notes', this.value)">${d.notes || ''}</textarea></div>`;
        }

        window.updatePayrollField = async (f, v) => {
            currentPayrollState[f] = parseFloat(v) || 0;
            
            // Special Logic: Accounts
            if (selectedEmployee.department.includes('Accounts')) {
                const usd = parseFloat(currentPayrollState['Basic Pay (USD)'] || 0);
                const rate = parseFloat(currentPayrollState['Exchange Rate (LAK)'] || 0);
                if (usd > 0 && rate > 0) {
                    currentPayrollState['ເງີນເດືອນພື້ນຖານ'] = usd * rate;
                    const bi = document.querySelector(`input[data-field="ເງີນເດືອນພື້ນຖານ"]`);
                    if(bi) bi.value = currentPayrollState['ເງີນເດືອນພື້ນຖານ'];
                }
            }

            // Special Logic: Invitational Teachers
            if (selectedEmployee.department.includes('Invitational Teachers')) {
                const hrs = parseFloat(currentPayrollState['ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)'] || 0);
                const rate = parseFloat(currentPayrollState['ອັດຕາຊົ່ວໂມງ (Rate per Hour)'] || 0);
                if (hrs > 0 && rate > 0) {
                    currentPayrollState['ເງີນເດືອນ'] = hrs * rate;
                    const bi = document.querySelector(`input[data-field="ເງີນເດືອນ"]`);
                    if(bi) bi.value = currentPayrollState['ເງີນເດືອນ'];
                }
            }

            // Special Logic: Standard Lao (Auto-sum Basic)
            const bSum = [LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy].reduce((a,c) => a + (parseFloat(currentPayrollState[c])||0), 0);
            if (currentPayrollState.hasOwnProperty(LAO_FIELDS.basic)) {
                if (!selectedEmployee.department.includes('Accounts') && !selectedEmployee.department.includes('Invitational Teachers')) {
                    currentPayrollState[LAO_FIELDS.basic] = bSum;
                }
                
                if (currentPayrollState.hasOwnProperty(LAO_FIELDS.start)) {
                    currentPayrollState[LAO_FIELDS.start] = (parseFloat(currentPayrollState[LAO_FIELDS.basic])||0) + (parseFloat(currentPayrollState[LAO_FIELDS.cert])||0) + (parseFloat(currentPayrollState[LAO_FIELDS.homeroom])||0) + (parseFloat(currentPayrollState[LAO_FIELDS.behaviorStart])||0);
                    const si = document.querySelector(`input[data-field="${LAO_FIELDS.start}"]`);
                    if(si) si.value = currentPayrollState[LAO_FIELDS.start];
                }
                
                const bi = document.querySelector(`input[data-field="${LAO_FIELDS.basic}"]`);
                if(bi) bi.value = currentPayrollState[LAO_FIELDS.basic];
            }
            renderPreview();
        };

        function calculatePayrollFromState(emp, state) {
            if (emp.department === 'English') {
                const d = state;
                const ot = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0);
                const gross = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0) + ot;
                const dedUSD = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0);
                const netUSD = gross - dedUSD;
                const convert = netUSD - (parseFloat(d.cashOut)||0);
                const convLAK = convert * (parseFloat(d.exchangeRate)||0);
                const extra = (parseFloat(d.itLAK)||0)+(parseFloat(d.itOthersLAK)||0)+(parseFloat(d.stipendLAK)||0);
                const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0);
                return { lak: Math.max(0, convLAK + extra - dedLAK), usd: parseFloat(d.cashOut)||0 };
            }
            
            const cfg = departmentConfigs[emp.department] || { earnings: [], deductions: [] };
            let te = 0, td = 0;
            cfg.earnings.forEach(f => {
                const v = parseFloat(state[f] || 0);
                // Exclude auto-calc totals from sum to avoid double counting if they exist in list
                if (![LAO_FIELDS.basic, LAO_FIELDS.start, 'ເງີນເດືອນພື້ນຖານ', 'ເງີນເດືອນ', 'Basic Pay (USD)', 'Exchange Rate (LAK)', 'ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)', 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)'].includes(f)) te += v;
                // Special additions for unique depts
                if (emp.department.includes('Accounts') && f === 'ເງີນເດືອນພື້ນຖານ') te += v;
                if (emp.department.includes('Invitational Teachers') && f === 'ເງີນເດືອນ') te += v;
                if (!emp.department.includes('Accounts') && !emp.department.includes('Invitational Teachers') && f === LAO_FIELDS.basic) te += v;
            });
            cfg.deductions.forEach(f => td += parseFloat(state[f] || 0));
            return { lak: Math.max(0, te - td), usd: 0 };
        }

        function renderPreview() {
            if (!selectedEmployee) return;
            const dept = selectedEmployee.department;
            
            document.getElementById('prev-name').innerText = selectedEmployee.name;
            document.getElementById('prev-pos').innerText = selectedEmployee.position;
            document.getElementById('prev-dept').innerText = selectedEmployee.department;
            document.getElementById('prev-date').innerText = new Date(editorYear, MONTHS.indexOf(editorMonth) + 1, 0).toLocaleDateString();
            document.getElementById('prev-id').innerText = generateEmployeeID(selectedEmployee, editorMonth, editorYear);
            document.getElementById('prev-campus').innerText = selectedEmployee.campus;
            
            const pe = document.getElementById('prev-profile-pic');
            if(selectedEmployee.profilePic) { pe.src = selectedEmployee.profilePic; pe.classList.remove('hidden'); } else pe.classList.add('hidden');
            
            const container = document.getElementById('preview-content');
            if (dept === 'English') { renderEnglishPreview(container); return; }

            const cfg = departmentConfigs[dept] || { earnings: [], deductions: [] }; 
            let te = 0, td = 0;
            const er = cfg.earnings.map(f => {
                const v = currentPayrollState[f] || 0;
                // Logic to display vs logic to sum
                const isBasicResult = (f === LAO_FIELDS.basic || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ');
                const isStart = f === LAO_FIELDS.start;
                const isUSD = (f === 'Basic Pay (USD)');
                const isRate = (f === 'Exchange Rate (LAK)' || f === 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)' || f === 'ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)');

                if (!isRate && f !== LAO_FIELDS.start && f !== 'Basic Pay (USD)') {
                    if (isBasicResult) {
                         if (selectedEmployee.department.includes('Accounts') || selectedEmployee.department.includes('Invitational Teachers')) {
                             te += parseFloat(v);
                         } else if (f === LAO_FIELDS.basic) {
                             te += parseFloat(v);
                         }
                    } else {
                        te += parseFloat(v);
                    }
                }
                
                if (v > 0 || isBasicResult || isStart || isUSD || isRate) {
                    let hClass = 'py-1 border-b border-gray-100';
                    let tClass = 'text-gray-800'; // Default text color

                    if (isBasicResult || f === 'ເງີນເດືອນພື້ນຖານ') {
                        hClass = 'lao-indent bg-green-100 border-green-200';
                        tClass = 'text-green-900 font-bold';
                    }
                    else if (isStart || f === 'ເລີ້ມຕົ້ນ') {
                        hClass = 'lao-indent bg-orange-100 border-orange-200';
                        tClass = 'text-orange-900 font-bold';
                    }
                    else if (f === 'ເງີນສະສົມປີຜ່ານມາ' || f === 'ເພີ້ມປະຈຳປີ 2025-2026') {
                        hClass = 'bg-purple-100 border-purple-200';
                        tClass = 'text-purple-900 font-bold';
                    }

                    const valStr = isUSD ? formatUSD(v) : (isRate ? parseFloat(v).toLocaleString() : formatMoney(v));
                    return `<div class="flex justify-between text-xs transition-all ${hClass}"><span class="${tClass}">${f}</span><span class="font-mono ${tClass}">${valStr}</span></div>`;
                }
                return '';
            }).join('');
            
            const dr = cfg.deductions.map(f => {
                const v = currentPayrollState[f] || 0; td += parseFloat(v);
                // FORCE RED TEXT for Deductions
                return v > 0 ? `<div class="flex justify-between py-1 border-b text-xs text-red-600 font-medium"><span>${f}</span><span class="font-mono">(${formatMoney(v)})</span></div>` : '';
            }).join('');
            
            const totalDedRow = `<div class="flex justify-between mt-2 pt-2 bg-red-50 px-2 font-bold text-red-900 border-t border-red-200"><span>TOTAL DEDUCTIONS</span><span>(${formatMoney(td)})</span></div>`;
            
            container.innerHTML = `
                <div class="space-y-4">
                    <div><h3 class="font-bold border-b-2 border-blue-200 text-blue-800 text-xs uppercase tracking-tight">Earnings</h3>${er}<div class="flex justify-between mt-2 pt-2 bg-yellow-50 px-2 font-bold text-yellow-900 border-t border-yellow-200"><span>Total Earnings</span><span>${formatMoney(te)}</span></div></div>
                    <div><h3 class="font-bold border-b-2 border-red-200 text-red-800 text-xs uppercase tracking-tight">Deductions</h3>${dr}${totalDedRow}</div>
                    <div id="net-pay-block" class="bg-blue-900 text-white p-3 rounded flex justify-between items-center font-bold"><span class="text-white">NET PAY (LAK)</span><span class="text-xl font-mono text-white font-bold">${formatMoney(te - td)}</span></div>
                    
                    <div class="mt-6 pt-4 border-t-2 border-gray-200">
                        <h4 class="font-bold text-xs text-gray-700 underline mb-2">ໝາຍເຫດ:</h4>
                        <ol class="list-decimal list-inside text-[10px] text-gray-600 space-y-1">
                            <li>ການຕອບຮັບຈາກ ຜປຄ ຫາຄູທີ່ສອນ/ຄູປະຈຳຫ້ອງ</li>
                            <li>ຄວາມເປັນລະບຽບໃນຫ້ອງທີ່ສອນ: ຄວາມເປັນລະບຽບຂອງໂຕະຕັ່ງ, ຄວາມສະອາດ ແລະ ອື່ນໆ</li>
                            <li>ທຸກໆການເຄື່ອນໄຫວໄປປະຊຸມ/ອອກວຽກກິດຈະກຳນອກ ຕ້ອງເຮັດບົດລາຍງານສົ່ງ.</li>
                        </ol>
                    </div>
                </div>`;
        }

        function renderEnglishPreview(container) { 
            const d = currentPayrollState; 
            const otPayment = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0); 
            const earnSum = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0); 
            const grossUSD = earnSum + otPayment; 
            const dedUSDSum = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0); 
            const netUSD = grossUSD - dedUSDSum; 
            const convertible = netUSD - (parseFloat(d.cashOut)||0); 
            const convertedLAK = convertible * (parseFloat(d.exchangeRate)||0); 
            const extraLAK = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0); 
            const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0); 
            const finalLAK = convertedLAK + extraLAK - dedLAK; 
            const fUSD = (n) => `$${parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; 
            const fLAK = (n) => formatMoney(n); 
            // Update renderRow to use red text if it's a deduction (d is true)
            const renderRow = (l, v, isDed, c) => `<div class="flex justify-between py-1 border-b border-gray-100 last:border-0"><span class="${isDed ? 'text-red-700' : 'text-gray-600'}">${l}</span><span class="font-mono ${isDed ? 'text-red-600' : ''}">${c==='USD'?fUSD(v):fLAK(v)}</span></div>`; 
            
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-xs">
                <div>
                    <h4 class="font-bold text-blue-900 border-b-2 border-blue-100 mb-2 pb-1">EARNINGS</h4>
                    ${renderRow('Basic Pay ($)', d.basicPay, false, 'USD')}
                    ${renderRow('Accumulated ($)', d.accumulated, false, 'USD')}
                    ${renderRow('2025-26 Increased ($)', d.increase, false, 'USD')}
                    ${renderRow('Others ($)', d.earningsOthersUSD, false, 'USD')}
                    
                    <h4 class="font-bold text-blue-900 border-b-2 border-blue-100 mt-4 mb-2 pb-1">OVERTIME (USD)</h4>
                    <div class="flex justify-between py-1 text-gray-500 italic"><span>Total no. of hours</span><span>${d.otHours}</span></div>
                    <div class="flex justify-between py-1 text-gray-500 italic"><span>Rate per hour</span><span>$${d.otRate}</span></div>
                    ${renderRow('Payment', otPayment, false, 'USD')}
                    
                    <h4 class="font-bold text-purple-900 border-b-2 border-purple-100 mt-4 mb-2 pb-1">EXTRA WORK (LAK)</h4>
                    ${renderRow('IT (LAK)', d.itLAK, false, 'LAK')}
                    ${renderRow('Others (LAK)', d.extraWorkOthersLAK, false, 'LAK')}
                    ${renderRow('STIPEND (4 levels)', d.stipendLAK, false, 'LAK')}
                    
                    <div class="bg-blue-50 p-2 rounded mt-4">
                        <div class="flex justify-between font-bold text-blue-800"><span>Gross Pay ($)</span><span>${fUSD(grossUSD)}</span></div>
                        <div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>Rate USD to LAK</span><span>${formatMoney(d.exchangeRate)}</span></div>
                    </div>
                </div>
                <div>
                    <h4 class="font-bold text-red-900 border-b-2 border-red-100 mb-2 pb-1">DEDUCTIONS</h4>
                    ${renderRow('Professional Tax ($)', d.profTax, true, 'USD')}
                    ${renderRow('Absences ($)', d.absences, true, 'USD')}
                    ${renderRow('Visa ($)', d.visa, true, 'USD')}
                    ${renderRow('Others ($)', d.deductionsOthersUSD, true, 'USD')}
                    <div class="flex justify-between font-bold text-red-700 border-t border-red-200 mt-1 pt-1 mb-4"><span>TOTAL DEDUCTIONS ($)</span><span>(${fUSD(dedUSDSum)})</span></div>
                    
                    ${renderRow('Insurance (LAK)', d.insuranceLAK, true, 'LAK')}
                    ${renderRow('Others (LAK)', d.deductionsOthersLAK, true, 'LAK')}
                    <div class="flex justify-between font-bold text-red-700 border-t border-red-200 mt-1 pt-1"><span>Deductions (LAK)</span><span>(${fLAK(dedLAK)})</span></div>
                </div>
            </div>
            
            <div class="mt-6 border-t-2 border-gray-800 pt-4 text-xs">
                <div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-700">Net Pay ($)</span><span class="font-mono font-bold">${fUSD(netUSD)}</span></div>
                <div class="flex justify-between items-center mb-1 text-gray-500"><span>Cash out ${fUSD(d.cashOut)}</span><span>(${fUSD(d.cashOut)})</span></div>
                <div class="flex justify-between items-center mb-1 text-gray-500"><span>$ convertible to LAK</span><span>${fUSD(convertible)}</span></div>
                <div class="bg-blue-900 text-white p-4 rounded flex justify-between items-center mt-3 shadow-lg">
                    <span class="font-bold uppercase tracking-wider text-lg text-white">Salary Pay (LAK)</span>
                    <span class="font-bold text-2xl font-mono text-white">${fLAK(finalLAK)}</span>
                </div>
            </div>
            ${d.notes ? `<div class="mt-4 pt-2 border-t border-gray-300 text-[10px]"><p class="font-bold">Notes:</p><p class="whitespace-pre-wrap">${d.notes}</p></div>` : ''}`; 
        }

        // --- NEW/FIXED BUTTON ACTIONS ---

        window.viewEmployeeHistory = () => {
            if (!selectedEmployee) return;
            document.getElementById('hist-emp-name').innerText = selectedEmployee.name;
            document.getElementById('hist-emp-dept').innerText = selectedEmployee.department;
            
            const rows = document.getElementById('hist-rows');
            const historyData = selectedEmployee.payrollHistory || {};
            const sortedKeys = Object.keys(historyData).sort((a,b) => b.localeCompare(a));
            
            let totalHistoryLAK = 0;
            let totalHistoryUSD = 0;

            if (sortedKeys.length === 0) {
                rows.innerHTML = '<p class="text-center text-gray-400 py-8">No history recorded for this staff member.</p>';
            } else {
                rows.innerHTML = sortedKeys.map(key => {
                    const total = calculatePayrollFromState(selectedEmployee, historyData[key]);
                    totalHistoryLAK += total.lak;
                    totalHistoryUSD += total.usd;

                    return `
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <div>
                                <p class="font-bold text-blue-900">${key}</p>
                                <p class="text-xs text-gray-500">Recorded Period</p>
                            </div>
                            <div class="text-right">
                                <div class="flex flex-col items-end gap-0.5">
                                    <span class="font-mono font-bold text-green-700 text-sm">${formatMoney(total.lak)}</span>
                                    <span class="font-mono font-bold text-blue-600 text-xs">${formatUSD(total.usd)}</span>
                                </div>
                                <button onclick="window.applyHistoryEntry('${key}')" class="text-[10px] text-gray-400 underline hover:text-blue-600 mt-1">Load to Editor</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update the totals in the modal header
            document.getElementById('hist-total-lak').innerText = formatMoney(totalHistoryLAK);
            document.getElementById('hist-total-usd').innerText = formatUSD(totalHistoryUSD);
            
            document.getElementById('employee-history-modal').classList.remove('hidden');
            if (window.lucide) lucide.createIcons();
        };

        window.applyHistoryEntry = (key) => {
            if (!selectedEmployee?.payrollHistory?.[key]) return;
            currentPayrollState = JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[key]));
            renderEditor();
            document.getElementById('employee-history-modal').classList.add('hidden');
        };

        window.editCurrentStaff = () => { 
            if(selectedEmployee) window.openStaffModal(selectedEmployee.id); 
        };

        window.loadPreviousMonthData = () => {
            if (!selectedEmployee) return;
            const currMIdx = MONTHS.indexOf(editorMonth);
            let prevMIdx = currMIdx - 1;
            let prevYr = parseInt(editorYear);
            
            if (prevMIdx < 0) {
                prevMIdx = 11;
                prevYr--;
            }
            
            const prevKey = `${prevYr}-${MONTHS[prevMIdx]}`;
            if (selectedEmployee.payrollHistory && selectedEmployee.payrollHistory[prevKey]) {
                if (confirm(`Copy data from ${MONTHS[prevMIdx]} ${prevYr}?`)) {
                    currentPayrollState = JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[prevKey]));
                    renderEditor();
                }
            } else {
                alert(`No data found for ${MONTHS[prevMIdx]} ${prevYr}`);
            }
        };

        window.resetCurrentPayroll = () => {
            if (!selectedEmployee) return;
            if (confirm("Reset current editor data to zero?")) {
                currentPayrollState = createInitialState(selectedEmployee.department);
                renderEditor();
            }
        };

        window.sendWhatsApp = () => {
            if (!selectedEmployee) return;
            const phone = selectedEmployee.whatsapp || "";
            const text = encodeURIComponent(constructPayslipMessage());
            window.open(`https://wa.me/${phone.replace(/\D/g, '')}?text=${text}`, '_blank');
        };

        window.sendEmail = () => {
            if (!selectedEmployee) return;
            const email = selectedEmployee.email || "";
            const subject = encodeURIComponent(`Payslip - ${editorMonth} ${editorYear} - ${selectedEmployee.name}`);
            const body = encodeURIComponent(constructPayslipMessage().replace(/\*/g, '')); 
            window.open(`mailto:${email}?subject=${subject}&body=${body}`, '_self');
        };

        window.handleLogoUpload = (input) => {
            const reader = new FileReader();
            reader.onload = (e) => {
                const dataUrl = e.target.result;
                localStorage.setItem('neerada_school_logo', dataUrl);
                const logo = document.getElementById('prev-school-logo');
                if (logo) {
                    logo.src = dataUrl;
                    logo.classList.remove('hidden');
                }
            };
            if (input.files[0]) reader.readAsDataURL(input.files[0]);
        };

        window.handleProfileUpload = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = (e) => {
                tempProfilePic = e.target.result;
                const prev = document.getElementById('form-preview-pic');
                prev.src = tempProfilePic;
                prev.classList.remove('hidden');
                document.getElementById('form-default-icon').classList.add('hidden');
                document.getElementById('delete-modal-photo-btn').classList.remove('hidden');
            };
            reader.readAsDataURL(file);
        };

        window.clearModalPhoto = () => {
            tempProfilePic = null;
            document.getElementById('form-profile-pic').value = "";
            const prev = document.getElementById('form-preview-pic');
            prev.src = "";
            prev.classList.add('hidden');
            document.getElementById('form-default-icon').classList.remove('hidden');
            document.getElementById('delete-modal-photo-btn').classList.add('hidden');
        };

        // --- CORE ACTIONS ---
        window.saveEmployeePayrollData = async () => {
            const key = `${editorYear}-${editorMonth}`;
            if (!selectedEmployee.payrollHistory) selectedEmployee.payrollHistory = {};
            selectedEmployee.payrollHistory[key] = JSON.parse(JSON.stringify(currentPayrollState));
            await transact(STORE_EMPLOYEES, 'readwrite', (s) => s.put(selectedEmployee));
            window.updateDashboardStats(); renderEmployeeList(); alert("Saved!");
        };

        window.deleteEmployee = async (id) => {
            if (!confirm("Are you sure you want to delete this staff member? This action cannot be undone.")) return;
            await transact(STORE_EMPLOYEES, 'readwrite', s => s.delete(id));
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            if (selectedEmployee && selectedEmployee.id === id) {
                selectedEmployee = null;
                document.getElementById('editor-area').classList.add('hidden');
                document.getElementById('empty-state').classList.remove('hidden');
            }
            renderEmployeeList();
            renderDeptSidebar();
            window.updateDashboardStats();
        };

        window.filterModalDepts = () => {
            const campus = document.getElementById('form-campus').value;
            const deptSelect = document.getElementById('form-department');
            const currentVal = deptSelect.value;
            
            let allowedDepts = [];
            if (campus === 'General Services') {
                allowedDepts = GS_DEPTS;
            } else {
                allowedDepts = ACADEMIC_DEPTS;
            }
            
            // Get all configured departments and filter them
            const allDepts = getOrderedDepartments();
            const filteredOptions = allDepts.filter(d => {
                const isAcademic = ACADEMIC_DEPTS.includes(d);
                const isGS = GS_DEPTS.includes(d);
                
                if (campus === 'General Services') {
                    return isGS || (!isAcademic && !isGS); // Show GS and custom unassigned
                } else {
                    return isAcademic || (!isAcademic && !isGS); // Show Academic and custom unassigned
                }
            });
            
            deptSelect.innerHTML = filteredOptions.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // Try to preserve value if valid, else select first
            if (filteredOptions.includes(currentVal)) {
                deptSelect.value = currentVal;
            } else if (filteredOptions.length > 0) {
                deptSelect.value = filteredOptions[0];
            }
            
            window.toggleBankFields();
        };

        window.openStaffModal = (id) => {
            document.getElementById('add-form').reset(); 
            document.getElementById('form-id').value = ""; 
            window.clearModalPhoto();
            
            if(id) {
                const emp = employees.find(e => String(e.id) === String(id));
                if (emp) {
                    document.getElementById('modal-title').innerText = "Edit Staff Details";
                    document.getElementById('form-id').value = emp.id; 
                    document.getElementById('form-name').value = emp.name; 
                    document.getElementById('form-position').value = emp.position; 
                    
                    // Set campus first
                    document.getElementById('form-campus').value = emp.campus || (ACADEMIC_DEPTS.includes(emp.department) ? "Sibounheuang" : "General Services");
                    
                    // Filter departments based on campus
                    window.filterModalDepts();
                    
                    // Then set department
                    document.getElementById('form-department').value = emp.department; 
                    
                    document.getElementById('form-bank-lak').value = emp.bankLak || ""; 
                    document.getElementById('form-bank-usd').value = emp.bankUsd || ""; 
                    document.getElementById('form-email').value = emp.email || ""; 
                    document.getElementById('form-whatsapp').value = emp.whatsapp || "";
                    
                    if(emp.profilePic) { 
                        tempProfilePic = emp.profilePic; 
                        const prev = document.getElementById('form-preview-pic');
                        prev.src = emp.profilePic; prev.classList.remove('hidden'); 
                        document.getElementById('form-default-icon').classList.add('hidden'); 
                        document.getElementById('delete-modal-photo-btn').classList.remove('hidden'); 
                    }
                }
            } else { 
                document.getElementById('modal-title').innerText = "Add Staff"; 
                document.getElementById('form-campus').value = "Sibounheuang"; // Default
                window.filterModalDepts();
            }
            
            document.getElementById('add-modal').classList.remove('hidden'); 
            document.getElementById('add-modal').classList.add('flex');
            window.toggleBankFields(); // Re-trigger to show/hide USD field if needed
            if (window.lucide) lucide.createIcons();
        };

        window.saveEmployee = async (e) => {
            e.preventDefault(); const fd = new FormData(e.target); const data = Object.fromEntries(fd.entries()); const ex = employees.find(x => x.id === data.id);
            data.id = data.id || 'EMP_' + Date.now(); data.payrollHistory = ex ? (ex.payrollHistory || {}) : {}; data.profilePic = tempProfilePic; data.lastModified = new Date().toISOString();
            await transact(STORE_EMPLOYEES, 'readwrite', (s) => s.put(data)); 
            employees = await transact(STORE_EMPLOYEES, 'readonly', (s) => s.getAll()); 
            renderEmployeeList(); renderDeptSidebar(); window.closeModal(); window.updateDashboardStats();
            if(selectedEmployee?.id === data.id) { selectedEmployee = data; renderPreview(); }
        };

        window.closeModal = () => document.getElementById('add-modal').classList.add('hidden');

        window.loadDeptConfig = () => {
            const select = document.getElementById('config-dept-select');
            const currentDepts = getOrderedDepartments();
            if (select && select.options.length === 0) select.innerHTML = currentDepts.map(d => `<option value="${d}">${d}</option>`).join('');
            const dept = select.value; 
            const cfg = departmentConfigs[dept];
            if(!cfg) return;
            const ri = (type, list) => list.map((f, i) => `<div class="flex gap-2 mb-2 items-center"><input type="text" value="${f}" onchange="window.updateConfigFieldName('${dept}', '${type}', ${i}, this.value)" class="flex-1 p-2 border rounded text-sm"><button onclick="window.removeConfigField('${dept}', '${type}', ${i})" class="text-red-400 p-1 hover:bg-red-50 rounded"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`).join('');
            document.getElementById('config-editor-area').innerHTML = `<div class="p-6 bg-blue-50 rounded-xl border border-blue-100"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-blue-800 uppercase text-xs">Earnings</h4><button onclick="window.addConfigField('${dept}', 'earnings')" class="text-[10px] bg-blue-600 text-white px-2 py-1 rounded font-bold hover:bg-blue-700">+ Add</button></div><div id="cfg-earn-list">${ri('earnings', cfg.earnings)}</div></div><div class="p-6 bg-red-50 rounded-xl border border-red-100"><div class="flex justify-between items-center mb-4"><h4 class="font-bold text-red-800 uppercase text-xs">Deductions</h4><button onclick="window.addConfigField('${dept}', 'deductions')" class="text-[10px] bg-green-600 text-white px-2 py-1 rounded font-bold">+ Add</button></div><div id="cfg-ded-list">${ri('deductions', cfg.deductions)}</div></div>`;
            if (window.lucide) lucide.createIcons();
        };

        window.updateConfigFieldName = (dept, type, idx, val) => { departmentConfigs[dept][type][idx] = val; };
        window.addConfigField = (dept, type) => { departmentConfigs[dept][type].push("New Field"); window.loadDeptConfig(); };
        window.removeConfigField = (dept, type, idx) => { departmentConfigs[dept][type].splice(idx, 1); window.loadDeptConfig(); };
        window.saveDeptConfig = async () => { for (const d in departmentConfigs) await transact(STORE_CONFIG, 'readwrite', s => s.put(departmentConfigs[d])); alert("Saved!"); if (selectedEmployee) loadPeriodData(); renderDeptSidebar(); };

        window.addDepartment = async () => {
            const name = prompt("Enter new Department name (e.g. Finance (ການເງິນ)):");
            if (!name || name.trim() === "") return;
            if (departmentConfigs[name]) return alert("Department already exists.");
            const cfg = { name, earnings: [...laoEarningsStruct], deductions: [...defaultDeductions] };
            await transact(STORE_CONFIG, 'readwrite', s => s.put(cfg));
            departmentConfigs[name] = cfg;
            document.getElementById('config-dept-select').innerHTML = ""; 
            window.loadDeptConfig(); renderDeptSidebar();
        };

        window.renameDept = async () => {
            const select = document.getElementById('config-dept-select');
            const oldName = select.value;
            if (!oldName) return;
            const newName = prompt("Enter new name for department:", oldName);
            if (!newName || newName.trim() === "" || newName === oldName) return;
            if (departmentConfigs[newName]) return alert("A department with this name already exists.");
            const cfg = JSON.parse(JSON.stringify(departmentConfigs[oldName]));
            cfg.name = newName;
            await transact(STORE_CONFIG, 'readwrite', s => { s.put(cfg); s.delete(oldName); });
            for (const emp of employees.filter(e => e.department === oldName)) {
                emp.department = newName;
                await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
            }
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            departmentConfigs[newName] = cfg; delete departmentConfigs[oldName];
            select.innerHTML = ""; renderDeptSidebar(); renderEmployeeList();
            window.loadDeptConfig(); document.getElementById('config-dept-select').value = newName;
            alert(`Renamed "${oldName}" to "${newName}".`);
        };

        window.deleteDept = async () => {
            const dept = document.getElementById('config-dept-select').value;
            if (employees.some(e => e.department === dept)) return alert("Cannot delete. Staff are assigned to this department.");
            if (!confirm(`Delete department "${dept}"?`)) return;
            await transact(STORE_CONFIG, 'readwrite', s => s.delete(dept));
            delete departmentConfigs[dept];
            document.getElementById('config-dept-select').innerHTML = "";
            window.loadDeptConfig(); renderDeptSidebar();
        };

        window.executePrint = () => {
            const o = document.querySelector('input[name="print-orient"]:checked').value; 
            const s = parseFloat(document.getElementById('print-scale').value) / 100;
            let st = document.getElementById('print-dynamic-style'); if (!st) { st = document.createElement('style'); st.id = 'print-dynamic-style'; document.head.appendChild(st); }
            st.innerHTML = `@media print { @page { size: A4 ${o}; margin: 5mm; } #preview-pane { display: block !important; position: absolute !important; left: 0 !important; top: 0 !important; transform: scale(${s}) !important; width: calc(100% / ${s}) !important; transform-origin: top left !important; } }`;
            window.closePrintSettings(); setTimeout(() => window.print(), 100);
        };

        window.updateDashboardStats = async () => {
            const vy = document.getElementById('filter-year'); 
            const vm = document.getElementById('filter-month'); 
            if(!vy || !vm) return;
            
            const yr = vy.value; const mn = vm.value; 
            let liveTotalLAK = 0; 
            let liveTotalUSD = 0;
            let liveStaffCount = 0;
            
            // New Breakdown Structure: { "Campus": { "Dept": { lak: 0, usd: 0, staffIds: Set() } } }
            let breakdown = {};

            employees.forEach(emp => {
                let empHasEntryInPeriod = false;
                if (emp.payrollHistory) {
                    Object.keys(emp.payrollHistory).forEach(key => {
                        const [kYr, kMn] = key.split('-');
                        const matchYr = (yr === 'All' || String(kYr) === String(yr));
                        const matchMn = (mn === 'All' || String(kMn) === String(mn));

                        if (matchYr && matchMn) {
                            const result = calculatePayrollFromState(emp, emp.payrollHistory[key]);
                            liveTotalLAK += result.lak;
                            liveTotalUSD += result.usd;
                            empHasEntryInPeriod = true;

                            // Aggregation
                            const c = emp.campus || "Unassigned";
                            const d = emp.department || "Unassigned";
                            
                            if (!breakdown[c]) breakdown[c] = {};
                            if (!breakdown[c][d]) breakdown[c][d] = { lak: 0, usd: 0, staffIds: new Set() };
                            
                            breakdown[c][d].lak += result.lak;
                            breakdown[c][d].usd += result.usd;
                            breakdown[c][d].staffIds.add(emp.id);
                        }
                    });
                }
                if (empHasEntryInPeriod) liveStaffCount++;
            });
            
            // Update Top Cards
            const lakEl = document.getElementById('stat-total-paid-lak');
            if(lakEl) lakEl.innerText = formatMoney(liveTotalLAK); 
            
            const usdEl = document.getElementById('stat-total-paid-usd');
            if(usdEl) usdEl.innerText = formatUSD(liveTotalUSD);

            const empEl = document.getElementById('stat-employees');
            if(empEl) empEl.innerText = liveStaffCount;

            // Render Breakdown Table
            const dbEl = document.getElementById('dept-breakdown');
            if (dbEl) {
                let tableHtml = `
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-gray-700 text-xs uppercase">Department Breakdown</h3>
                    </div>
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-medium">
                            <tr>
                                <th class="px-4 py-3">Campus</th>
                                <th class="px-4 py-3">Department</th>
                                <th class="px-4 py-3 text-center">Active Staff</th>
                                <th class="px-4 py-3 text-right">Total Pay (LAK)</th>
                                <th class="px-4 py-3 text-right">Total Pay (USD)</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-100">`;

                let hasRows = false;
                // Sort Campuses
                Object.keys(breakdown).sort().forEach(campus => {
                    // Sort Departments
                    Object.keys(breakdown[campus]).sort().forEach(dept => {
                        const data = breakdown[campus][dept];
                        hasRows = true;
                        tableHtml += `
                            <tr class="hover:bg-gray-50">
                                <td class="px-4 py-3 font-medium text-blue-900">${campus}</td>
                                <td class="px-4 py-3">${dept}</td>
                                <td class="px-4 py-3 text-center">${data.staffIds.size}</td>
                                <td class="px-4 py-3 text-right font-mono text-blue-700">${formatMoney(data.lak)}</td>
                                <td class="px-4 py-3 text-right font-mono text-green-700">${formatUSD(data.usd)}</td>
                            </tr>
                        `;
                    });
                });

                if (!hasRows) {
                    tableHtml += `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No data available for this period.</td></tr>`;
                }

                tableHtml += `</tbody></table></div>`;
                dbEl.innerHTML = tableHtml;
            }

            const logs = await transact(STORE_HISTORY, 'readonly', s => s.getAll());
            let fl = logs.filter(l => {
                const matchYear = (yr === 'All' || String(l.year) === String(yr));
                const matchMonth = (mn === 'All' || String(l.month) === String(mn));
                return matchYear && matchMonth;
            });

            const latestLog = fl.sort((a,b) => b.dateId.localeCompare(a.dateId))[0];
            const lastMonthEl = document.getElementById('stat-last-month');
            const lastAmountEl = document.getElementById('stat-last-amount');
            if (latestLog) {
                lastMonthEl.innerText = `${latestLog.month} ${latestLog.year}`;
                lastAmountEl.innerText = formatMoney(latestLog.totalLAK);
            } else {
                lastMonthEl.innerText = "No Finalized Runs";
                lastAmountEl.innerText = "---";
            }
            
            const hlist = document.getElementById('history-list');
            if(hlist) {
                hlist.innerHTML = fl.sort((a,b) => b.dateId.localeCompare(a.dateId)).map(h => `
                    <tr>
                        <td class="p-4 text-sm font-bold text-blue-900">${h.month} ${h.year}</td>
                        <td class="p-4 text-sm">${h.employeeCount} Staff</td>
                        <td class="p-4 text-sm text-right font-mono font-bold text-green-700">${formatMoney(h.totalLAK)}</td>
                        <td class="p-4 text-sm text-right font-mono font-bold text-green-700">$${(h.totalUSD || 0).toFixed(2)}</td>
                        <td class="p-4 text-right">
                            <button onclick="window.deleteHistory('${h.dateId}')" class="text-red-500 text-xs underline font-bold">Delete Log</button>
                        </td>
                    </tr>`).join('');
            }
        };

        window.deleteHistory = async (id) => { if (confirm("Delete this finalizing log? (This won't delete employee data)")) { await transact(STORE_HISTORY, 'readwrite', s => s.delete(id)); window.updateDashboardStats(); } };
        window.openSaveHistoryModal = () => document.getElementById('save-modal').classList.remove('hidden');
        window.savePayrollHistory = async (e) => {
            e.preventDefault(); 
            const mn = document.getElementById('save-month').value; 
            const yr = document.getElementById('save-year').value; 
            const key = `${yr}-${mn}`;
            let totalLAK = 0;
            let totalUSD = 0;
            let count = 0;
            
            employees.forEach(emp => { 
                if (emp.payrollHistory && emp.payrollHistory[key]) { 
                    const result = calculatePayrollFromState(emp, emp.payrollHistory[key]);
                    totalLAK += result.lak;
                    totalUSD += result.usd;
                    count++; 
                } 
            });
            
            await transact(STORE_HISTORY, 'readwrite', (s) => s.put({ dateId: key, month: mn, year: yr, totalLAK, totalUSD, employeeCount: count, timestamp: new Date().toISOString() })); 
            window.updateDashboardStats(); 
            document.getElementById('save-modal').classList.add('hidden');
        };

        window.handleStaffCSV = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                const text = e.target.result;
                const rows = text.split('\n').filter(r => r.trim());
                if (rows.length < 2) return alert("Invalid CSV");
                
                for (let i = 1; i < rows.length; i++) {
                    const cols = rows[i].split(',').map(c => c.replace(/^"|"$/g, '').trim());
                    if (cols.length < 3) continue;
                    
                    const id = 'EMP_' + Date.now() + i;
                    const name = cols[2];
                    const dept = cols[4];
                    const pos = cols[5];
                    
                    await transact(STORE_EMPLOYEES, 'readwrite', s => s.put({
                        id, name, department: dept, position: pos, payrollHistory: {}, campus: "General Services"
                    }));
                }
                employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
                renderEmployeeList(); renderDeptSidebar();
            };
            reader.readAsText(file);
        };

        window.triggerImport = () => document.getElementById('staff-csv-input').click();

        window.deleteAllPhotos = async () => {
            if (!confirm("Remove all employee photos?")) return;
            for (const emp of employees) {
                emp.profilePic = null;
                await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
            }
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            renderEmployeeList();
        };

        window.setTheme = (theme) => {
            localStorage.setItem('neerada_theme', theme);
            document.body.className = `bg-gray-100 font-sans text-gray-900 h-screen flex flex-col overflow-hidden theme-${theme}`;
        };

        window.downloadCSVReport = () => {
            const yrFilter = document.getElementById('filter-year').value; 
            const mnFilter = document.getElementById('filter-month').value;
            let rows = [["Period", "Employee ID", "Name", "Campus", "Department", "Position", "LAK Account", "USD Account", "Total LAK (₭)", "Total USD ($)"]];
            let grandTotalLAK = 0;
            let grandTotalUSD = 0;
            employees.forEach(emp => { 
                if(!emp.payrollHistory) return; 
                Object.keys(emp.payrollHistory).forEach(key => { 
                    const [y, m] = key.split('-'); 
                    if((yrFilter === 'All' || y === yrFilter) && (mnFilter === 'All' || m === mnFilter)) {
                        const result = calculatePayrollFromState(emp, emp.payrollHistory[key]);
                        grandTotalLAK += result.lak;
                        grandTotalUSD += result.usd;
                        
                        const csvEmpId = generateEmployeeID(emp, m, y);
                        
                        rows.push([`${m} ${y}`, csvEmpId, emp.name, emp.campus || "General Services", emp.department, emp.position, (emp.bankLak || "N/A"), (emp.bankUsd || "N/A"), result.lak, result.usd]);
                    } 
                }); 
            });
            rows.push(["", "", "", "", "", "", "", "Grand Total", grandTotalLAK, grandTotalUSD]);
            const yrLabel = yrFilter === 'All' ? 'AllYears' : yrFilter;
            const mnLabel = mnFilter === 'All' ? 'AllMonths' : mnFilter;
            const filename = `Neerada_Payroll_Report_${yrLabel}_${mnLabel}_unified.csv`;
            
            // UTF-8 BOM Logic for Excel Compatibility
            const csvContent = rows.map(r => r.map(cell => `"${cell}"`).join(",")).join("\n");
            const blob = new Blob(["\ufeff" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement("a"); 
            a.href = url;
            a.download = filename; 
            a.click();
            URL.revokeObjectURL(url);
        };

        window.switchView = (v) => { 
            ['dashboard', 'payroll', 'config'].forEach(i => { const el = document.getElementById('view-'+i); const tab = document.getElementById('tab-'+i); if(el) el.classList.add('hidden'); if(tab) tab.className = "px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors"; }); 
            const av = document.getElementById('view-'+v); const at = document.getElementById('tab-'+v);
            if(av) av.classList.remove('hidden'); if(at) at.className = "px-4 py-1.5 text-sm font-medium rounded-md bg-blue-800 text-white transition-colors";
            if (v === 'config') window.loadDeptConfig(); if (v === 'dashboard') window.updateDashboardStats(); 
        };
        window.goBack = () => { 
            selectedEmployee = null; 
            document.getElementById('editor-area').classList.add('hidden'); 
            document.getElementById('empty-state').classList.remove('hidden'); 
            
            // Note: Mobile toggle logic removed to ensure all panels stay visible after selection
        };
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden');
        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden');
        window.openPrintSettings = () => { if(!selectedEmployee) return; document.getElementById('print-modal').classList.remove('hidden'); document.getElementById('print-modal').classList.add('flex'); };
        window.closePrintSettings = () => { document.getElementById('print-modal').classList.add('hidden'); };
        window.openSaveHistoryModal = () => document.getElementById('save-modal').classList.remove('hidden');

        // Missing Functions Implemented Below
        
        window.bulkSavePayroll = () => {
             // Since this is in "Filtered Data Actions", it maps to the save modal to finalize the run.
             window.openSaveHistoryModal();
        };

        window.bulkResetPayroll = async () => {
            const yr = document.getElementById('editor-year').value;
            const mn = document.getElementById('editor-month').value;
            const targetStr = currentFilter.department === 'All' ? 'ALL Staff' : currentFilter.department;
            
            if(!confirm(`RESET payroll data for ${targetStr} for ${mn} ${yr}? This cannot be undone.`)) return;
            
            const key = `${yr}-${mn}`;
            let count = 0;
            
            const targetEmployees = currentFilter.department === 'All' ? employees : employees.filter(e => e.department === currentFilter.department);
            
            for(const emp of targetEmployees) {
                if(emp.payrollHistory && emp.payrollHistory[key]) {
                    delete emp.payrollHistory[key];
                    await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(emp));
                    count++;
                }
            }
            
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            window.updateDashboardStats();
            if(selectedEmployee) loadPeriodData(); // Refresh editor if open
            alert(`Reset data for ${count} employees.`);
        };

        window.deleteAllEmployeesInFilter = async () => {
            const targetStr = currentFilter.department === 'All' ? 'ALL Staff' : currentFilter.department;
            if(!confirm(`DELETE ${targetStr}? This will remove employees and all their history permanently.`)) return;
            if(!confirm(`Are you absolutely sure you want to delete ${targetStr}?`)) return;
            
            const targetEmployees = currentFilter.department === 'All' ? employees : employees.filter(e => e.department === currentFilter.department);
            
            for(const emp of targetEmployees) {
                await transact(STORE_EMPLOYEES, 'readwrite', s => s.delete(emp.id));
            }
            
            employees = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            selectedEmployee = null;
            document.getElementById('editor-area').classList.add('hidden');
            document.getElementById('empty-state').classList.remove('hidden');
            renderEmployeeList();
            renderDeptSidebar();
            window.updateDashboardStats();
            alert("Deletion complete.");
        };

        window.downloadCSVTemplate = () => {
            const headers = ["No", "ID", "Name", "Gender", "Department", "Position", "LAK Account", "USD Account", "Email", "WhatsApp"];
            const csvContent = "data:text/csv;charset=utf-8," + headers.join(",");
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "staff_import_template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- EXPORT/IMPORT BACKUP ---
        window.exportData = async () => {
            const emp = await transact(STORE_EMPLOYEES, 'readonly', s => s.getAll());
            const hist = await transact(STORE_HISTORY, 'readonly', s => s.getAll());
            const cfg = await transact(STORE_CONFIG, 'readonly', s => s.getAll());
            const data = { employees: emp, history: hist, config: cfg, timestamp: Date.now() };
            const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `neerada_backup_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        };

        window.importData = (input) => {
            const file = input.files[0];
            if (!file) return;
            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    
                    // Normalization for legacy backups
                    let importedConfig = data.config || data.departmentConfigs;
                    let importedEmployees = data.employees;
                    let importedHistory = data.history || data.history_logs;

                    if (!importedEmployees) throw new Error("Invalid backup: Missing employees data.");
                    
                    // Handle legacy config format (Object vs Array)
                    if (importedConfig && !Array.isArray(importedConfig)) {
                        importedConfig = Object.entries(importedConfig).map(([name, cfg]) => ({ name, ...cfg }));
                    }

                    if (!importedConfig) {
                        if(!confirm("Backup is missing configuration data. Import employees only?")) return;
                        importedConfig = []; 
                    } else {
                         if (!confirm(`Restore backup from ${new Date(data.timestamp || Date.now()).toLocaleDateString()}? This will overwrite current data.`)) return;
                    }

                    // Define default GS configs to merge if missing (prevents legacy backups from hiding GS depts)
                    const defaultGSConfigs = {};
                    for (const d of GS_DEPTS) {
                        let earnings = [...laoEarningsStruct];
                        let deductions = [...defaultDeductions];
                        if (d.includes('Accounts')) {
                            earnings = ['Basic Pay (USD)', 'Exchange Rate (LAK)', 'ເງີນເດືອນພື້ນຖານ', 'ສະສົມປີຜ່ານມາ', 'ເພີ້ມປະຈຳປີ 2025-2026', 'ບໍລິຫານຫ້ອງການ/ບັນຊີ', 'ດຸໝັ່ນມາການ (ບໍ່ຂາດການ)', 'ພົວພັນວຽກທາງນອກ-ພາຍໃນ', 'ບັນຊີ ການເງີນວຽກອື່ນໆຂອງໂຮງຮຽນ'];
                        } else if (d.includes('Invitational Teachers')) {
                            earnings = ['ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)', 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)', 'ເງີນເດືອນ'];
                        }
                        defaultGSConfigs[d] = { name: d, earnings, deductions };
                    }
                    
                    // Merge logic: ensure GS depts exist in importedConfig
                    const importedDeptNames = new Set(importedConfig.map(c => c.name));
                    for (const gsDept of GS_DEPTS) {
                        if (!importedDeptNames.has(gsDept)) {
                            importedConfig.push(defaultGSConfigs[gsDept]);
                        }
                    }

                    // 1. Clear and Restore Config
                    if (importedConfig.length > 0) {
                        await transact(STORE_CONFIG, 'readwrite', s => s.clear());
                        for (const c of importedConfig) await transact(STORE_CONFIG, 'readwrite', s => s.put(c));
                        // Refresh cache
                        departmentConfigs = {};
                        importedConfig.forEach(c => departmentConfigs[c.name] = { earnings: c.earnings, deductions: c.deductions });
                    }

                    // 2. Clear and Restore Employees
                    await transact(STORE_EMPLOYEES, 'readwrite', s => s.clear());
                    for (const em of importedEmployees) {
                        // Ensure required fields exist
                        if(!em.payrollHistory) em.payrollHistory = {};
                        if(!em.savedPayroll) em.savedPayroll = {};
                        await transact(STORE_EMPLOYEES, 'readwrite', s => s.put(em));
                    }
                    employees = importedEmployees;

                    // 3. Clear and Restore History
                    await transact(STORE_HISTORY, 'readwrite', s => s.clear());
                    if (importedHistory) {
                        for (const h of importedHistory) await transact(STORE_HISTORY, 'readwrite', s => s.put(h));
                        history = importedHistory;
                    }

                    alert("Restore successful! Reloading...");
                    window.location.reload(); 
                } catch (err) {
                    alert("Error importing data: " + err.message);
                    console.error("Import Error Details:", err);
                }
            };
            reader.readAsText(file);
            input.value = ''; // Reset input so same file can be selected again
        };

        window.toggleBankFields = () => {
            const dept = document.getElementById('form-department').value;
            const usdCont = document.getElementById('bank-usd-container');
            if (dept === 'English') {
                usdCont.classList.remove('hidden');
            } else {
                usdCont.classList.add('hidden');
            }
        };

        // --- CONTACT SAVING HELPER ---
        function downloadVCard() {
            if(!selectedEmployee) return;
            const n = selectedEmployee.name;
            const tel = selectedEmployee.whatsapp; 
            if(!tel) return;
            
            const vcf = `BEGIN:VCARD\nVERSION:3.0\nFN:${n}\nORG:Neerada School;${selectedEmployee.department}\nTEL;TYPE=CELL:${tel}\nEMAIL:${selectedEmployee.email}\nEND:VCARD`;
            
            const blob = new Blob([vcf], { type: 'text/vcard;charset=utf-8' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.href = url;
            link.download = `${n.replace(/\s+/g, '_')}.vcf`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);
        }

        function constructPayslipMessage() {
            if (!selectedEmployee) return "";
            const dept = selectedEmployee.department;
            const cfg = departmentConfigs[dept] || { earnings: [], deductions: [] };
            const state = currentPayrollState;
            const dateStr = new Date(editorYear, MONTHS.indexOf(editorMonth) + 1, 0).toLocaleDateString();
            const empID = generateEmployeeID(selectedEmployee, editorMonth, editorYear);

            let msg = `*PAYSLIP - Neerada School*\n`;
            msg += `----------------------------\n`;
            msg += `Date: ${dateStr}\n`;
            msg += `Employee: ${selectedEmployee.name}\n`;
            msg += `ID: ${empID}\n`;
            msg += `Position: ${selectedEmployee.position}\n`;
            msg += `Department: ${selectedEmployee.department}\n`;
            msg += `Campus: ${selectedEmployee.campus}\n`;
            msg += `----------------------------\n\n`;

            if(dept === 'English') {
                const d = state;
                const fUSD = (n) => `$${parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
                const fLAK = (n) => formatMoney(n);

                const otPayment = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0);
                const earnSum = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0);
                const grossUSD = earnSum + otPayment;
                const dedUSDSum = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0);
                const netUSD = grossUSD - dedUSDSum;
                const convertible = netUSD - (parseFloat(d.cashOut)||0);
                const convertedLAK = convertible * (parseFloat(d.exchangeRate)||0);
                const extraLAK = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0);
                const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0);
                const finalLAK = convertedLAK + extraLAK - dedLAK;

                msg += `*EARNINGS*\n`;
                msg += `Basic Pay ($): ${fUSD(d.basicPay)}\n`;
                msg += `Accumulated ($): ${fUSD(d.accumulated)}\n`;
                msg += `2025-26 Increased ($): ${fUSD(d.increase)}\n`;
                msg += `Others ($): ${fUSD(d.earningsOthersUSD)}\n\n`;

                msg += `*OVERTIME (USD)*\n`;
                msg += `Total hours: ${d.otHours}\n`;
                msg += `Rate per hour: $${d.otRate}\n`;
                msg += `Payment: ${fUSD(otPayment)}\n\n`;

                msg += `*EXTRA WORK (LAK)*\n`;
                msg += `IT (LAK): ${fLAK(d.itLAK)}\n`;
                msg += `Others (LAK): ${fLAK(d.extraWorkOthersLAK)}\n`;
                msg += `STIPEND (4 levels): ${fLAK(d.stipendLAK)}\n\n`;

                msg += `Gross Pay ($): ${fUSD(grossUSD)}\n`;
                msg += `Rate USD to LAK: ${formatMoney(d.exchangeRate)}\n\n`;

                msg += `*DEDUCTIONS*\n`;
                msg += `Professional Tax ($): (${fUSD(d.profTax)})\n`;
                msg += `Absences ($): (${fUSD(d.absences)})\n`;
                msg += `Visa ($): (${fUSD(d.visa)})\n`;
                msg += `Others ($): (${fUSD(d.deductionsOthersUSD)})\n`;
                msg += `TOTAL DEDUCTIONS ($): (${fUSD(dedUSDSum)})\n\n`;

                msg += `Insurance (LAK): (${fLAK(d.insuranceLAK)})\n`;
                msg += `Others (LAK): (${fLAK(d.deductionsOthersLAK)})\n`;
                msg += `Deductions (LAK): (${fLAK(dedLAK)})\n\n`;

                msg += `----------------------------\n`;
                msg += `Net Pay ($): ${fUSD(netUSD)}\n`;
                msg += `Cash out: ${fUSD(d.cashOut)}\n`;
                msg += `$ convertible: ${fUSD(convertible)}\n`;
                msg += `*SALARY PAY (LAK): ${fLAK(finalLAK)}*\n`;
                
                if (d.notes) msg += `\nNotes: ${d.notes}\n`;

            } else {
                let te = 0;
                let td = 0;
                msg += `*EARNINGS*\n`;
                cfg.earnings.forEach(f => {
                    const v = state[f] || 0;
                    
                    // Logic mirroring renderPreview
                    const isBasicResult = (f === LAO_FIELDS.basic || f === 'ເງີນເດືອນພື້ນຖານ' || f === 'ເງີນເດືອນ');
                    const isStart = f === LAO_FIELDS.start;
                    const isUSD = (f === 'Basic Pay (USD)');
                    const isRate = (f === 'Exchange Rate (LAK)' || f === 'ອັດຕາຊົ່ວໂມງ (Rate per Hour)' || f === 'ຊົ່ວໂມງສອນທັງໝົດ (Total Hours Taught)');

                    if (!isRate && f !== LAO_FIELDS.start && f !== 'Basic Pay (USD)') {
                        if (isBasicResult) {
                             if (selectedEmployee.department.includes('Accounts') || selectedEmployee.department.includes('Invitational Teachers') || f === LAO_FIELDS.basic) {
                                 te += parseFloat(v);
                             }
                        } else {
                            te += parseFloat(v);
                        }
                    }

                    if (v > 0 || isBasicResult || isStart || isUSD || isRate) {
                        const valStr = isUSD ? formatUSD(v) : (isRate ? parseFloat(v).toLocaleString() : formatMoney(v));
                        msg += `${f}: ${valStr}\n`;
                    }
                });
                msg += `*Total Earnings: ${formatMoney(te)}*\n`;
                
                msg += `\n*DEDUCTIONS*\n`;
                cfg.deductions.forEach(f => {
                    const v = state[f] || 0;
                    if (v > 0) {
                        td += parseFloat(v);
                        msg += `${f}: (${formatMoney(v)})\n`;
                    }
                });
                msg += `*TOTAL DEDUCTIONS: (${formatMoney(td)})*\n`;
                msg += `\n*NET PAY (LAK): ${formatMoney(te - td)}*\n`;
                
                msg += `\n----------------------------\n`;
                msg += `ໝາຍເຫດ:\n`;
                msg += `1. ການຕອບຮັບຈາກ ຜປຄ ຫາຄູທີ່ສອນ/ຄູປະຈຳຫ້ອງ\n`;
                msg += `2. ຄວາມເປັນລະບຽບໃນຫ້ອງທີ່ສອນ: ຄວາມເປັນລະບຽບຂອງໂຕະຕັ່ງ, ຄວາມສະອາດ ແລະ ອື່ນໆ\n`;
                msg += `3. ທຸກໆການເຄື່ອນໄຫວໄປປະຊຸມ/ອອກວຽກກິດຈະກຳນອກ ຕ້ອງເຮັດບົດລາຍງານສົ່ງ.\n`;
            }
            
            msg += `\n_Computer Generated message._\n`;
            msg += `© 2026 Neerada School Payroll System`;
            return msg;
        }

        // --- NEW/FIXED BUTTON ACTIONS ---

        window.viewEmployeeHistory = () => {
            if (!selectedEmployee) return;
            document.getElementById('hist-emp-name').innerText = selectedEmployee.name;
            document.getElementById('hist-emp-dept').innerText = selectedEmployee.department;
            
            const rows = document.getElementById('hist-rows');
            const historyData = selectedEmployee.payrollHistory || {};
            const sortedKeys = Object.keys(historyData).sort((a,b) => b.localeCompare(a));
            
            let totalHistoryLAK = 0;
            let totalHistoryUSD = 0;

            if (sortedKeys.length === 0) {
                rows.innerHTML = '<p class="text-center text-gray-400 py-8">No history recorded for this staff member.</p>';
            } else {
                rows.innerHTML = sortedKeys.map(key => {
                    const total = calculatePayrollFromState(selectedEmployee, historyData[key]);
                    totalHistoryLAK += total.lak;
                    totalHistoryUSD += total.usd;

                    return `
                        <div class="flex justify-between items-center p-4 bg-gray-50 rounded-lg border border-gray-100">
                            <div>
                                <p class="font-bold text-blue-900">${key}</p>
                                <p class="text-xs text-gray-500">Recorded Period</p>
                            </div>
                            <div class="text-right">
                                <div class="flex flex-col items-end gap-0.5">
                                    <span class="font-mono font-bold text-green-700 text-sm">${formatMoney(total.lak)}</span>
                                    <span class="font-mono font-bold text-blue-600 text-xs">${formatUSD(total.usd)}</span>
                                </div>
                                <button onclick="window.applyHistoryEntry('${key}')" class="text-[10px] text-gray-400 underline hover:text-blue-600 mt-1">Load to Editor</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
            
            // Update the totals in the modal header
            document.getElementById('hist-total-lak').innerText = formatMoney(totalHistoryLAK);
            document.getElementById('hist-total-usd').innerText = formatUSD(totalHistoryUSD);
            
            document.getElementById('employee-history-modal').classList.remove('hidden');
            if (window.lucide) lucide.createIcons();
        };

        window.onload = initApp;
    </script>
</body>
</html>