<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Neerada Payroll System v3.7</title>
    
    <!-- Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
        }
        /* Theme Variables - Default (Blue) */
        :root {
            --primary-900: #1e3a8a;
            --primary-800: #1e40af;
            --primary-700: #1d4ed8;
            --primary-600: #2563eb;
            --primary-100: #dbeafe;
            --primary-50: #eff6ff;
        }

        /* Theme Overrides */
        body.theme-emerald { --primary-900: #064e3b; --primary-800: #065f46; --primary-700: #047857; --primary-600: #059669; --primary-100: #d1fae5; --primary-50: #ecfdf5; }
        body.theme-rose { --primary-900: #881337; --primary-800: #9f1239; --primary-700: #be123c; --primary-600: #e11d48; --primary-100: #ffe4e6; --primary-50: #fff1f2; }
        body.theme-slate { --primary-900: #0f172a; --primary-800: #1e293b; --primary-700: #334155; --primary-600: #475569; --primary-100: #f1f5f9; --primary-50: #f8fafc; }
        body.theme-violet { --primary-900: #4c1d95; --primary-800: #5b21b6; --primary-700: #6d28d9; --primary-600: #7c3aed; --primary-100: #ede9fe; --primary-50: #f5f3ff; }

        /* Apply Variables */
        .bg-blue-900 { background-color: var(--primary-900) !important; }
        .bg-blue-800 { background-color: var(--primary-800) !important; }
        .text-blue-900 { color: var(--primary-900) !important; }
        .text-blue-800 { color: var(--primary-800) !important; }
        .text-blue-700 { color: var(--primary-700) !important; }
        .text-blue-600 { color: var(--primary-600) !important; }
        .bg-blue-600 { background-color: var(--primary-600) !important; }
        .hover\:bg-blue-700:hover { background-color: var(--primary-700) !important; }
        .hover\:bg-blue-800:hover { background-color: var(--primary-800) !important; }
        .bg-blue-50 { background-color: var(--primary-50) !important; }
        .bg-blue-100 { background-color: var(--primary-100) !important; }
        .text-blue-100 { color: var(--primary-100) !important; }
        .border-blue-100 { border-color: var(--primary-100) !important; }
        .border-blue-200 { border-color: #bfdbfe !important; } /* Hardcoded fallback close to 200 */

        /* Custom scrollbar */
        #employee-list::-webkit-scrollbar,
        #editor-content::-webkit-scrollbar,
        #dept-tree::-webkit-scrollbar {
            width: 6px;
        }
        #employee-list::-webkit-scrollbar-thumb,
        #editor-content::-webkit-scrollbar-thumb,
        #dept-tree::-webkit-scrollbar-thumb {
            background-color: #cbd5e1;
            border-radius: 3px;
        }

        /* Auto-calc Highlights in Editor */
        .field-highlight-1 input {
            background-color: #f0fdf4 !important; /* Green-50 */
            border-color: #22c55e !important;
            font-weight: 800 !important;
            color: #15803d !important;
        }
        .field-highlight-2 input {
            background-color: #fff7ed !important; /* Orange-50 */
            border-color: #f97316 !important;
            font-weight: 800 !important;
            color: #c2410c !important;
        }

        @media print {
            /* Default to Portrait, overridden by JS for Landscape */
            @page { size: auto; margin: 0mm; } 
            
            html, body { height: 100%; width: 100%; margin: 0; padding: 0; background: white; }
            body * { visibility: hidden; }
            #preview-pane, #preview-pane * { visibility: visible; }
            #preview-pane { 
                position: fixed; left: 0; top: 0; 
                width: 100%; 
                margin: 0; padding: 10mm; 
                background: white; z-index: 9999;
                border: none !important; box-shadow: none !important;
                display: flex; flex-direction: column;
                transform-origin: top left; /* Critical for scaling */
            }
            #preview-pane { font-family: sans-serif; color: #000; }
            #prev-name { font-size: 16pt !important; font-weight: 800 !important; color: var(--primary-900) !important; line-height: 1.1; }
            #prev-pos, #prev-dept, #prev-id { font-size: 12pt !important; font-weight: 700 !important; color: var(--primary-900) !important; }
            #preview-pane .text-xs { font-size: 10pt !important; }
            #preview-pane .text-sm { font-size: 11pt !important; }
            #preview-pane .text-\[10px\] { font-size: 9pt !important; color: #6b7280 !important; }
            #preview-pane h3, #preview-pane h4 { 
                font-size: 12pt !important; font-weight: bold !important; 
                margin-top: 8px !important; margin-bottom: 4px !important;
                border-bottom-width: 2px !important;
            }
            #preview-pane .gap-6 { gap: 8px !important; }
            #preview-pane .gap-8 { gap: 15px !important; }
            #preview-pane .p-3 { padding: 6px !important; }
            #preview-pane .py-1 { padding-top: 1px !important; padding-bottom: 1px !important; }
            #preview-pane .mt-6, #preview-pane .mt-8 { margin-top: 10px !important; }
            #preview-pane .mb-6 { margin-bottom: 8px !important; }
            #print-footer { margin-top: auto !important; padding-top: 10px; border-top: 1px solid #ccc; font-size: 8pt !important; }
            #preview-pane .grid { display: grid !important; width: 100% !important; }
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            .no-print { display: none !important; }
            
            /* Print Specific Highlights */
            .print-highlight-1 { background-color: #f0fdf4 !important; border: 1px solid #bbf7d0 !important; color: #166534 !important; font-weight: bold !important; padding: 4px !important; margin-bottom: 4px !important; border-radius: 4px !important; }
            .print-highlight-2 { background-color: #fff7ed !important; border: 1px solid #fed7aa !important; color: #9a3412 !important; font-weight: bold !important; padding: 4px !important; margin-bottom: 4px !important; border-radius: 4px !important; }
            .print-highlight-special { background-color: #e0e7ff !important; border: 1px solid #c7d2fe !important; color: #4338ca !important; font-weight: bold !important; font-size: 11pt !important; padding: 4px !important; border-radius: 4px !important; margin-bottom: 4px !important;}
            .print-highlight-total { background-color: #fef9c3 !important; border-top: 2px solid #ca8a04 !important; color: #854d0e !important; font-weight: 900 !important; padding: 6px !important; }
        }
    </style>
</head>
<body class="bg-gray-100 font-sans text-gray-900 h-screen flex flex-col overflow-hidden">

    <!-- Loading Screen -->
    <div id="loading-screen" class="fixed inset-0 bg-blue-900 text-white flex items-center justify-center z-50 transition-opacity duration-500">
        <div class="text-center animate-pulse">
            <h1 class="text-2xl font-bold">Neerada Payroll</h1>
            <p class="text-sm opacity-75 mt-2">Loading System v3.7. Connecting to database...</p>
            <p id="user-info" class="text-xs mt-2 text-blue-300"></p>
        </div>
    </div>

    <!-- App Content -->
    <div id="app-content" class="flex flex-col h-full hidden">
        
        <!-- Header / Nav -->
        <header class="bg-blue-900 text-white p-3 md:p-4 shadow-md flex justify-between items-center z-20 shrink-0">
            <div class="flex items-center gap-4">
                <button id="mobile-back-btn" onclick="window.goBack()" class="lg:hidden p-1.5 bg-blue-800 rounded-full hover:bg-blue-700 hidden">
                    <i data-lucide="chevron-left" class="w-5 h-5 text-white"></i>
                </button>
                <div class="bg-white/10 p-2 rounded-full hidden md:block">
                    <i data-lucide="dollar-sign" class="w-5 h-5 text-yellow-400"></i>
                </div>
                <div>
                    <h1 class="font-bold text-lg leading-tight">Neerada Payroll</h1>
                    <p class="text-[10px] text-blue-300 hidden md:block">System v3.7</p>
                </div>
                
                <div class="hidden md:flex bg-blue-800 rounded-lg p-1 ml-6">
                    <button id="tab-dashboard" onclick="window.switchView('dashboard')" class="px-4 py-1.5 text-sm font-medium rounded-md bg-blue-800 text-white transition-colors">Dashboard</button>
                    <button id="tab-payroll" onclick="window.switchView('payroll')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">Staff Manager</button>
                    <button id="tab-config" onclick="window.switchView('config')" class="px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors">Payslip Data</button>
                </div>
            </div>
            
            <div class="flex items-center gap-2">
                <button onclick="window.openSettings()" class="p-2 rounded-full hover:bg-blue-800 transition-colors" title="Settings">
                    <i data-lucide="settings" class="w-5 h-5 text-blue-100"></i>
                </button>
                <div class="md:hidden flex gap-2">
                     <button onclick="window.switchView('dashboard')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700">Dash</button>
                     <button onclick="window.switchView('payroll')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700">Staff</button>
                     <button onclick="window.switchView('config')" class="text-xs bg-blue-800 px-2 py-1 rounded border border-blue-700">Data</button>
                </div>
                <div class="flex items-center gap-2 px-3 py-1.5 bg-blue-800 rounded-lg text-xs font-medium border border-blue-700 hidden md:flex">
                    <i data-lucide="calendar" class="w-3 h-3"></i>
                    <span id="date-display">...</span>
                </div>
            </div>
        </header>

        <!-- DASHBOARD VIEW -->
        <div id="view-dashboard" class="flex-1 overflow-y-auto p-4 lg:p-8">
            <div class="max-w-6xl mx-auto space-y-8">
                <div class="flex flex-col md:flex-row justify-between items-end gap-4">
                    <div>
                        <h2 class="text-2xl font-bold text-gray-800">Financial Overview</h2>
                        <p class="text-gray-500 text-sm">Track salary payments and history</p>
                    </div>
                    <div class="flex gap-2 items-center">
                        <div class="flex bg-white rounded-md shadow-sm border border-gray-200">
                            <select id="filter-year" onchange="window.updateDashboardStats()" class="bg-transparent text-sm font-medium text-gray-700 p-2 outline-none border-r border-gray-200"></select>
                            <select id="filter-month" onchange="window.updateDashboardStats()" class="bg-transparent text-sm font-medium text-gray-700 p-2 outline-none">
                                <option value="All">All Months</option>
                                <option value="January">January</option>
                                <option value="February">February</option>
                                <option value="March">March</option>
                                <option value="April">April</option>
                                <option value="May">May</option>
                                <option value="June">June</option>
                                <option value="July">July</option>
                                <option value="August">August</option>
                                <option value="September">September</option>
                                <option value="October">October</option>
                                <option value="November">November</option>
                                <option value="December">December</option>
                            </select>
                        </div>
                        <button onclick="window.openSaveHistoryModal()" class="flex items-center gap-2 bg-green-600 text-white px-4 py-2 rounded shadow hover:bg-green-700 transition text-sm font-medium">
                            <i data-lucide="save" class="w-4 h-4"></i> Save Monthly Run
                        </button>
                        <button onclick="window.downloadCSVReport()" class="flex items-center gap-2 bg-indigo-600 text-white px-4 py-2 rounded shadow hover:bg-indigo-700 transition text-sm font-medium ml-2" title="Download CSV Report">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Export CSV
                        </button>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Paid (LAK)</p>
                        <p id="stat-total-paid-lak" class="text-2xl font-mono font-bold text-blue-900 mt-2">₭ 0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs font-bold text-gray-400 uppercase">Total Paid (USD)</p>
                        <p id="stat-total-paid-usd" class="text-2xl font-mono font-bold text-green-700 mt-2">$0.00</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs font-bold text-gray-400 uppercase">Staff Count</p>
                        <p id="stat-employees" class="text-3xl font-bold text-gray-800 mt-2">0</p>
                    </div>
                    <div class="bg-white p-6 rounded-xl shadow-sm border border-gray-200">
                        <p class="text-xs font-bold text-gray-400 uppercase">Latest Record</p>
                        <div class="flex flex-col mt-2">
                            <span id="stat-last-month" class="text-sm font-bold text-gray-800">No Data</span>
                            <span id="stat-last-amount" class="text-xs text-gray-500">---</span>
                        </div>
                    </div>
                </div>

                <!-- NEW SECTION: Department Breakdown -->
                <div id="dept-breakdown" class="mt-8">
                    <!-- Populated by JS -->
                </div>

                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden mt-8">
                    <div class="p-4 border-b border-gray-100 bg-gray-50">
                        <h3 class="font-bold text-gray-700">Payment History Logs</h3>
                    </div>
                    <table class="w-full text-left">
                        <thead class="bg-gray-50 w-full text-gray-500 text-xs uppercase font-medium">
                            <tr>
                                <th class="px-4 py-3">Period</th>
                                <th class="px-4 py-3">Staff</th>
                                <th class="px-4 py-3 text-right">Total LAK</th>
                                <th class="px-4 py-3 text-right">Total USD</th>
                                <th class="px-4 py-3 text-right">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="history-list" class="divide-y divide-gray-100"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- CONFIGURATION VIEW -->
        <div id="view-config" class="flex-1 overflow-y-auto p-4 lg:p-8 hidden bg-gray-50">
            <div class="max-w-4xl mx-auto">
                <div class="bg-white rounded-xl shadow border border-gray-200 overflow-hidden">
                    <div class="p-6 border-b border-gray-200 flex justify-between items-start">
                        <div>
                            <h2 class="text-xl font-bold text-gray-800">Payslip Data Configuration</h2>
                            <p class="text-sm text-gray-500">Manage earnings and deductions fields.</p>
                        </div>
                        <button onclick="window.addNewDept()" class="bg-blue-600 text-white px-3 py-1.5 rounded text-sm flex items-center gap-2 hover:bg-blue-700">
                            <i data-lucide="plus-circle" class="w-4 h-4"></i> New Dept
                        </button>
                    </div>
                    <div class="p-6">
                        
                        
                        <div class="mb-6 bg-blue-50 p-4 rounded-lg border border-blue-100">
                            <label class="block text-xs font-bold text-blue-800 uppercase mb-2">Select Department</label>
                            <div class="flex gap-2">
                                <select id="config-dept-select" onchange="window.loadDeptConfig()" class="flex-1 p-2 border rounded bg-white text-sm"></select>
                                <button onclick="window.renameDept()" class="px-3 py-2 bg-white border border-gray-300 rounded hover:bg-gray-50 text-gray-600" title="Rename"><i data-lucide="edit-3" class="w-4 h-4"></i></button>
                                <button onclick="window.deleteDept()" class="px-3 py-2 bg-white border border-red-200 text-red-500 rounded hover:bg-red-50" title="Delete"><i data-lucide="trash-2" class="w-4 h-4"></i></button>
                            </div>
                        </div>
                        <div id="config-editor-area" class="grid grid-cols-1 md:grid-cols-2 gap-8">
                            <div class="bg-green-50 p-4 rounded border border-green-100">
                                <h3 class="font-bold text-green-800 mb-4 flex justify-between items-center">
                                    Earnings Fields
                                    <button onclick="window.addField('earnings')" class="text-xs bg-green-200 px-2 py-1 rounded hover:bg-green-300">+ Add Field</button>
                                </h3>
                                <div id="config-earnings-list" class="space-y-2"></div>
                            </div>
                            <div class="bg-red-50 p-4 rounded border border-red-100">
                                <h3 class="font-bold text-red-800 mb-4 flex justify-between items-center">
                                    Deductions Fields
                                    <button onclick="window.addField('deductions')" class="text-xs bg-red-200 px-2 py-1 rounded hover:bg-red-300">+ Add Field</button>
                                </h3>
                                <div id="config-deductions-list" class="space-y-2"></div>
                            </div>
                        </div>
                        <div class="mt-6 flex justify-end">
                            <button onclick="window.saveDeptConfig()" class="bg-blue-600 text-white px-6 py-2 rounded hover:bg-blue-700 flex items-center gap-2 font-medium shadow-sm">
                                <i data-lucide="save" class="w-4 h-4"></i> Save Changes
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- PAYROLL MANAGER VIEW -->
        <div id="view-payroll" class="flex-1 overflow-hidden relative hidden">
            <div class="flex h-full">
                <!-- LEVEL 1 SIDEBAR -->
                <aside class="hidden xl:flex w-64 bg-gray-50 border-r border-gray-200 flex-col z-10 h-full overflow-y-auto">
                    <div class="p-4 border-b border-gray-200 bg-gray-100 sticky top-0">
                               <h2 class="font-bold text-gray-700 text-xs uppercase tracking-wider">Departments</h2>
                    </div>
                    <div id="dept-tree" class="p-2 space-y-1"></div>
                </aside>

                    <!-- LEVEL 2 SIDEBAR -->
                <aside id="sidebar" class="w-full lg:w-72 bg-white border-r border-gray-200 flex flex-col z-10 h-full">
                    <div class="p-4 border-b border-gray-100 bg-white flex flex-col gap-3 shrink-0">
                        <div class="flex justify-between items-center">
                            <h2 class="font-semibold text-gray-700 flex items-center gap-2">
                                <i data-lucide="users" class="w-4 h-4"></i> Staff List
                            </h2>
                            <div class="flex gap-1">
                                <button onclick="window.triggerImport()" title="Import Staff Info CSV" class="p-1 hover:bg-gray-100 rounded text-gray-600 transition-colors">
                                    <i data-lucide="upload" class="w-5 h-5"></i>
                                </button>
                                <button onclick="window.deleteBulkPhotos()" title="Delete All Photos" class="p-1 hover:bg-red-100 rounded text-red-600 transition-colors">
                                    <i data-lucide="image-off" class="w-5 h-5"></i>
                                </button>
                                <button onclick="window.openStaffModal(null)" title="Add Staff" class="p-1 hover:bg-blue-100 rounded text-blue-600 transition-colors">
                                    <i data-lucide="plus" class="w-5 h-5"></i>
                                </button>
                            </div>
                            <input type="file" id="csv-input" accept=".csv" class="hidden" onchange="window.handleCSV(this)">
                        </div>
                        <div class="xl:hidden">
                            <select id="mobile-filter" onchange="window.handleMobileFilter(this.value)" class="w-full text-xs border border-gray-300 rounded p-1.5 bg-gray-50">
                                <option value="All|All">All Staff</option>
                            </select>
                        </div>
                    </div>
                    
                    <!-- NEW: Bulk Payroll Actions -->
                    <div id="bulk-payroll-actions" class="p-4 border-b border-gray-100 bg-blue-50 shrink-0">
                        <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="clock-rewind" class="w-4 h-4 text-blue-600"></i> Bulk Actions (<span id="bulk-period-display">...</span>)
                        </h3>
                        <p class="text-[10px] text-gray-600 mb-3">Applies to *all* staff for the selected Payroll Period in the main workspace.</p>
                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.resetAllEmployeePayrollData()" class="flex items-center justify-center gap-1 py-1.5 bg-red-100 text-red-700 font-medium rounded shadow-sm hover:bg-red-200 transition text-xs">
                                <i data-lucide="rotate-ccw" class="w-3 h-3"></i> Reset All Data
                            </button>
                            <button onclick="window.saveAllEmployeePayrollData()" class="flex items-center justify-center gap-1 py-1.5 bg-green-600 text-white font-medium rounded shadow hover:bg-green-700 transition text-xs">
                                <i data-lucide="save" class="w-3 h-3"></i> Save All Data
                            </button>
                        </div>
                    </div>
                    <!-- END: Bulk Payroll Actions -->
                    
                    <!-- START: MOVED BULK PAYSLIP DATA MANAGEMENT -->
                    <div id="bulk-payslip-management" class="p-4 border-b border-gray-100 bg-gray-50/50 shrink-0">
                        <h3 class="text-sm font-bold text-gray-700 mb-3 flex items-center gap-2">
                            <i data-lucide="file-spreadsheet" class="w-4 h-4 text-yellow-600"></i> Bulk Payslip Data
                        </h3>
                        <p class="text-[10px] text-gray-600 mb-3">Download a template to bulk-edit earnings and deductions for Lao departments. Only editable fields included.</p>

                        <div class="grid grid-cols-2 gap-2">
                            <button onclick="window.downloadPayslipTemplate('Kindergarten')" class="flex items-center justify-center gap-1 py-1 bg-yellow-400 text-white font-medium rounded shadow-sm hover:bg-yellow-500 transition text-xs">
                                <i data-lucide="download" class="w-3 h-3"></i> KG Template
                            </button>
                            <button onclick="window.downloadPayslipTemplate('Primary')" class="flex items-center justify-center gap-1 py-1 bg-yellow-400 text-white font-medium rounded shadow-sm hover:bg-yellow-500 transition text-xs">
                                <i data-lucide="download" class="w-3 h-3"></i> Primary Template
                            </button>
                            <button onclick="window.downloadPayslipTemplate('Secondary')" class="flex items-center justify-center gap-1 py-1 bg-yellow-400 text-white font-medium rounded shadow-sm hover:bg-yellow-500 transition text-xs">
                                <i data-lucide="download" class="w-3 h-3"></i> Secondary Template
                            </button>
                            <label for="bulk-payslip-input" class="col-span-2 flex items-center justify-center gap-2 py-1.5 bg-green-600 text-white font-medium rounded shadow hover:bg-green-700 transition cursor-pointer text-sm">
                                <i data-lucide="upload" class="w-4 h-4"></i> Upload Payslip Data
                                <input type="file" id="bulk-payslip-input" accept=".csv" class="hidden" onchange="window.handlePayslipCSV(this)">
                            </label>
                        </div>
                    </div>
                    <!-- END: MOVED BULK PAYSLIP DATA MANAGEMENT -->
                    
                    <div id="filter-status" class="px-4 py-2 bg-blue-50 text-xs text-blue-800 border-b border-blue-100 hidden flex justify-between items-center">
                        <span id="filter-label" class="font-medium truncate">All Staff</span>
                        <button onclick="window.clearFilter()" class="text-blue-500 hover:text-blue-700"><i data-lucide="x" class="w-3 h-3"></i></button>
                    </div>
                    <div id="employee-list" class="flex-1 overflow-y-auto p-2"></div>
                </aside>

                <!-- Main Content -->
                <main id="payroll-workspace" class="flex-1 overflow-y-auto bg-gray-100 p-4 lg:p-6 hidden lg:block">
                    <!-- Empty State -->
                    <div id="empty-state" class="flex flex-col items-center justify-center h-full text-gray-400 space-y-4">
                        <div class="w-16 h-16 bg-gray-200 rounded-full flex items-center justify-center">
                            <i data-lucide="briefcase" class="w-8 h-8 text-gray-400"></i>
                        </div>
                        <p>Select an employee to view details.</p>
                    </div>

                    <!-- Editor Area -->
                    <div id="editor-area" class="w-full max-w-6xl mx-auto flex flex-col xl:flex-row gap-6 hidden">
                        <!-- Controls -->
                        <div class="w-full xl:w-1/3 space-y-4 no-print flex flex-col h-full">
                            <!-- Period Selector -->
                            <div class="bg-blue-50 border border-blue-200 rounded-xl p-3 mb-4 flex items-center justify-between">
                                <div class="text-xs font-bold text-blue-800 uppercase tracking-wide">Payroll Period</div>
                                <div class="flex gap-2">
                                    <select id="editor-month" onchange="window.loadPeriodData()" class="text-xs border-gray-300 rounded p-1 bg-white outline-none"></select>
                                    <select id="editor-year" onchange="window.loadPeriodData()" class="text-xs border-gray-300 rounded p-1 bg-white outline-none"></select>
                                </div>
                            </div>

                            <!-- ACTIONS PANEL -->
                            <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mb-4">
                                <div class="grid grid-cols-1 gap-2">
                                    <!-- NEW: View Employee History -->
                                    <button onclick="window.viewEmployeeHistory()" class="flex items-center justify-center gap-2 w-full py-2 bg-indigo-50 text-indigo-700 border border-indigo-200 rounded hover:bg-indigo-100 text-sm font-medium mb-1">
                                        <i data-lucide="bar-chart-2" class="w-4 h-4"></i> View History Dashboard
                                    </button>

                                    <button onclick="window.editCurrentStaff()" class="flex items-center justify-center gap-2 w-full py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm font-medium">
                                        <i data-lucide="user-cog" class="w-4 h-4"></i> Edit Staff Details
                                    </button>
                                    
                                    <!-- BUTTON: Load Previous Month -->
                                    <button onclick="window.loadPreviousMonthData()" class="flex items-center justify-center gap-2 w-full py-2 bg-orange-50 text-orange-700 border border-orange-200 rounded hover:bg-orange-100 text-sm font-medium">
                                        <i data-lucide="copy" class="w-4 h-4"></i> Copy from Previous Month
                                    </button>

                                    <button onclick="window.saveEmployeePayrollData()" class="flex items-center justify-center gap-2 w-full py-2 bg-green-600 text-white rounded hover:bg-green-700 text-sm font-medium">
                                        <i data-lucide="save" class="w-4 h-4"></i> Save for Selected Month
                                    </button>
                                    
                                    <button onclick="window.resetCurrentPayroll()" class="flex items-center justify-center gap-2 w-full py-2 bg-red-50 text-red-600 border border-red-200 rounded hover:bg-red-100 text-sm">
                                        <i data-lucide="rotate-ccw" class="w-4 h-4"></i> Reset Data
                                    </button>
                                    
                                    <div class="grid grid-cols-3 gap-2 mt-1">
                                        <button onclick="window.openPrintSettings()" title="Print" class="flex items-center justify-center py-2 bg-gray-800 text-white rounded hover:bg-gray-900 text-sm"><i data-lucide="printer" class="w-4 h-4"></i></button>
                                        <button onclick="window.sendEmail()" title="Email" class="flex items-center justify-center py-2 bg-blue-600 text-white rounded hover:bg-blue-700 text-sm"><i data-lucide="mail" class="w-4 h-4"></i></button>
                                        <button onclick="window.sendWhatsApp()" title="WhatsApp" class="flex items-center justify-center py-2 bg-green-500 text-white rounded hover:bg-green-600 text-sm"><i data-lucide="message-circle" class="w-4 h-4"></i></button>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Payslip Input Fields -->
                            <div id="editor-content" class="flex-1 overflow-y-auto"></div>
                        </div>

                        <!-- Live Preview -->
                        <div id="preview-pane" class="w-full xl:w-2/3 bg-white p-6 md:p-8 rounded shadow-lg border border-gray-200 text-xs md:text-sm">
                            <div class="border-b-2 border-blue-900 pb-4 mb-4 flex justify-between items-start">
                                <div class="flex items-center gap-4">
                                    <img id="prev-school-logo" class="h-16 w-auto hidden object-contain">
                                    <div>
                                        <h1 class="text-xl md:text-2xl font-bold text-blue-900 uppercase tracking-widest">Neerada School</h1>
                                        <p class="text-gray-500 text-xs mt-1">Excellence in Education</p>
                                        <div class="flex items-center gap-2 text-gray-400 text-[10px] mt-1">
                                            <i data-lucide="building" class="w-3 h-3"></i>
                                            <span id="prev-campus">Campus</span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex flex-col items-end">
                                    <img id="prev-profile-pic" class="h-20 w-20 object-cover rounded-full border mb-2 hidden bg-gray-100">
                                    <div class="text-right">
                                        <h2 class="text-lg font-semibold text-gray-800">PAYSLIP</h2>
                                        <p class="text-xs text-gray-600">Date: <span id="prev-date" class="font-bold"></span></p>
                                    </div>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-3 mb-6 bg-blue-50 p-3 rounded-lg">
                                <div><p class="text-[10px] text-gray-500 uppercase">Employee Name</p><p id="prev-name" class="font-bold text-gray-800">---</p></div>
                                <div><p class="text-[10px] text-gray-500 uppercase">Position</p><p id="prev-pos" class="font-bold text-gray-800">---</p></div>
                                <div><p class="text-[10px] text-gray-500 uppercase">Department</p><p id="prev-dept" class="font-bold text-gray-800">---</p></div>
                                <div><p class="text-[10px] text-gray-500 uppercase">Employee ID</p><p id="prev-id" class="text-gray-800 font-mono">---</p></div>
                                <div class="border-t border-blue-200 pt-2 mt-1">
                                    <p class="text-[10px] text-gray-500 uppercase">Email Address</p><p id="prev-email" class="text-gray-800">---</p>
                                </div>
                                <div class="border-t border-blue-200 pt-2 mt-1">
                                    <p class="text-[10px] text-gray-500 uppercase">WhatsApp</p><p id="prev-whatsapp" class="text-gray-800">---</p>
                                </div>
                            </div>
                            <div id="preview-content"></div>
                            <div id="print-footer" class="mt-8 text-center text-[10px] text-gray-400">
                                <p>Computer-generated. No signature required.</p>
                                <p>© <span id="copyright-year"></span> Neerada School Payroll System</p>
                            </div>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <!-- Modal: Settings -->
    <div id="settings-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold text-gray-800">Settings</h2>
                <button onclick="window.closeSettings()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            
            <div class="space-y-6">
                <!-- Theme -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">App Theme</label>
                    <select id="theme-select" onchange="window.setTheme(this.value)" class="w-full border rounded p-2 text-sm bg-white">
                        <option value="default">Default Blue</option>
                        <option value="emerald">Emerald Green</option>
                        <option value="rose">Rose Red</option>
                        <option value="slate">Slate Dark</option>
                        <option value="violet">Violet</option>
                    </select>
                </div>

                <!-- School Logo -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">School Logo</label>
                    <div class="flex items-center gap-4">
                        <div class="relative w-full">
                            <input type="file" accept="image/*" onchange="window.handleLogoUpload(this)" class="w-full text-xs text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-1">Upload a small PNG or JPG logo. Will appear on all payslips.</p>
                </div>

                <!-- Data Management -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Data Management</label>
                    <div class="grid grid-cols-1 gap-2">
                        <button onclick="window.exportData()" class="flex items-center justify-center gap-2 w-full py-2 bg-blue-50 text-blue-700 border border-blue-200 rounded hover:bg-blue-100 text-sm">
                            <i data-lucide="download" class="w-4 h-4"></i> Export Data (Backup)
                        </button>
                        <div class="relative">
                            <button onclick="document.getElementById('import-file').click()" class="flex items-center justify-center gap-2 w-full py-2 bg-gray-50 text-gray-700 border border-gray-200 rounded hover:bg-gray-100 text-sm">
                                <i data-lucide="upload" class="w-4 h-4"></i> Import Data (Restore)
                            </button>
                            <input type="file" id="import-file" accept=".json" class="hidden" onchange="window.importData(this)">
                        </div>
                    </div>
                    <p class="text-[10px] text-gray-400 mt-2">Importing will replace all current data.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Print Settings (NEW) -->
    <div id="print-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[150] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-4">Print Settings</h2>
            
            <div class="space-y-6">
                <!-- Orientation -->
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-2">Orientation</label>
                    <div class="flex gap-4">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="print-orient" value="portrait" checked class="text-blue-600">
                            <span class="text-sm">Portrait</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="radio" name="print-orient" value="landscape" class="text-blue-600">
                            <span class="text-sm">Landscape</span>
                        </label>
                    </div>
                </div>

                <!-- Scaling -->
                <div>
                    <div class="flex justify-between items-center mb-2">
                        <label class="block text-xs font-bold text-gray-500 uppercase">Fill Page Scale</label>
                        <span id="scale-val" class="text-xs font-mono font-bold text-blue-600">100%</span>
                    </div>
                    <input type="range" id="print-scale" min="50" max="150" value="100" class="w-full accent-blue-600" oninput="document.getElementById('scale-val').innerText = this.value + '%'">
                    <p class="text-[10px] text-gray-400 mt-1">Adjust to fit the content to one full A4 sheet.</p>
                </div>

                <div class="pt-2 flex gap-3">
                    <button onclick="window.closePrintSettings()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button onclick="window.executePrint()" class="flex-1 py-2 bg-gray-800 text-white rounded hover:bg-gray-900 font-medium flex items-center justify-center gap-2">
                        <i data-lucide="printer" class="w-4 h-4"></i> Print Now
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal: Add/Edit -->
    <div id="add-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <div class="flex justify-between items-center mb-4">
                <h2 id="modal-title" class="text-xl font-bold text-gray-800">Add New Staff</h2>
                <div class="flex gap-2">
                    <button onclick="window.downloadTemplate()" class="text-xs text-blue-600 underline">CSV Template</button>
                    <button onclick="window.closeModal()" class="text-gray-400 hover:text-gray-600"><i data-lucide="x" class="w-5 h-5"></i></button>
                </div>
            </div>
            <form id="add-form" onsubmit="window.saveEmployee(event)" class="space-y-4">
                <input type="hidden" name="id" id="form-id">
                
                <!-- Profile Picture Upload -->
                <div class="flex items-center gap-4 mb-4">
                    <div class="w-16 h-16 rounded-full bg-gray-100 border flex items-center justify-center overflow-hidden">
                        <img id="form-preview-pic" class="w-full h-full object-cover hidden">
                        <i data-lucide="user" id="form-default-icon" class="w-8 h-8 text-gray-400"></i>
                    </div>
                    <div class="flex-1 space-y-1">
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Profile Photo</label>
                        <input type="file" id="form-profile-pic" accept="image/*" onchange="window.handleProfileUpload(this)" class="w-full text-xs text-gray-500 file:mr-4 file:py-1.5 file:px-3 file:rounded-full file:border-0 file:text-xs file:font-semibold file:bg-blue-50 file:text-blue-700 hover:file:bg-blue-100">
                        <button type="button" id="delete-modal-photo-btn" onclick="window.clearModalPhoto()" class="text-[10px] text-red-500 hover:text-red-700 underline font-medium mt-1 hidden">
                            Remove Current Photo
                        </button>
                    </div>
                </div>

                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Full Name</label>
                    <input required name="name" id="form-name" type="text" class="w-full border rounded p-2 text-sm" placeholder="e.g. Somchai Vong">
                </div>
                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Campus</label>
                        <select name="campus" id="form-campus" class="w-full border rounded p-2 text-sm bg-white">
                            <option>Sibounheuang</option><option>Chommany</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Department</label>
                        <select name="department" id="form-department" class="w-full border rounded p-2 text-sm bg-white"></select>
                    </div>
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Position</label>
                    <input required name="position" id="form-position" type="text" class="w-full border rounded p-2 text-sm" placeholder="e.g. Teacher">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Email</label>
                    <input required name="email" id="form-email" type="email" class="w-full border rounded p-2 text-sm" placeholder="email@school.com">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">WhatsApp Number</label>
                    <input name="whatsapp" id="form-whatsapp" type="text" class="w-full border rounded p-2 text-sm" placeholder="e.g. 8562055555555">
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="window.closeModal()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-blue-600 text-white rounded hover:bg-blue-700 font-medium">Save Staff</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal: Save History -->
    <div id="save-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-sm">
            <h2 class="text-xl font-bold text-gray-800 mb-2">Save Payroll Run</h2>
            <p class="text-sm text-gray-500 mb-4">Calculate total salary for all active employees and save to history.</p>
            <form id="save-form" onsubmit="window.savePayrollHistory(event)" class="space-y-4">
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Year</label>
                    <input id="save-year" type="number" class="w-full border rounded p-2 text-sm" value="2025">
                </div>
                <div>
                    <label class="block text-xs font-bold text-gray-500 uppercase mb-1">Select Month</label>
                    <select id="save-month" class="w-full border rounded p-2 text-sm bg-white">
                        <option>January</option><option>February</option><option>March</option>
                        <option>April</option><option>May</option><option>June</option>
                        <option>July</option><option>August</option><option>September</option>
                        <option>October</option><option>November</option><option>December</option>
                    </select>
                </div>
                <div class="pt-4 flex gap-3">
                    <button type="button" onclick="window.closeSaveHistoryModal()" class="flex-1 py-2 text-gray-600 hover:bg-gray-100 rounded">Cancel</button>
                    <button type="submit" class="flex-1 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium">Save & Close</button>
                </div>
            </form>
        </div>
    </div>

    <!-- NEW MODAL: Employee History Dashboard -->
    <div id="employee-history-modal" class="fixed inset-0 bg-black/50 hidden items-center justify-center z-[100] p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-2xl h-[90vh] flex flex-col">
            <div class="p-6 border-b border-gray-100 flex justify-between items-start shrink-0">
                <div>
                    <h2 class="text-xl font-bold text-gray-800 flex items-center gap-2">
                        <i data-lucide="user" class="w-5 h-5 text-blue-600"></i>
                        <span id="hist-emp-name">Employee Name</span>
                    </h2>
                    <p id="hist-emp-dept" class="text-sm text-gray-500">Department</p>
                </div>
                <button onclick="document.getElementById('employee-history-modal').classList.add('hidden')" class="text-gray-400 hover:text-gray-600">
                    <i data-lucide="x" class="w-6 h-6"></i>
                </button>
            </div>
            
            <div class="p-6 overflow-y-auto flex-1">
                <!-- Lifetime Stats -->
                <div class="grid grid-cols-2 gap-4 mb-6">
                    <div class="bg-blue-50 p-4 rounded-lg border border-blue-100">
                        <p class="text-xs font-bold text-blue-800 uppercase">Total Earned (LAK)</p>
                        <p id="hist-total-lak" class="text-2xl font-mono font-bold text-blue-900 mt-1">₭ 0</p>
                    </div>
                    <div class="bg-green-50 p-4 rounded-lg border border-green-100">
                        <p class="text-xs font-bold text-green-800 uppercase">Total Earned (USD)</p>
                        <p id="hist-total-usd" class="text-2xl font-mono font-bold text-green-900 mt-1">$0.00</p>
                    </div>
                </div>

                <!-- History Table -->
                <h3 class="font-bold text-gray-700 mb-3 text-sm">Payment Records</h3>
                <div class="border rounded-lg overflow-hidden">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 text-gray-500 text-xs uppercase font-medium">
                            <tr>
                                <th class="px-4 py-3">Period</th>
                                <th class="px-4 py-3 text-right">LAK Paid</th>
                                <th class="px-4 py-3 text-right">USD Paid</th>
                            </tr>
                        </thead>
                        <tbody id="employee-history-rows" class="divide-y divide-gray-100">
                            <!-- Rows go here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, onSnapshot, collection, setDoc, deleteDoc, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Global variables provided by the Canvas environment
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-neerada-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db, auth, userId = null;
        let isAuthReady = false;
        
        // Log level for Firebase debugging
        setLogLevel('Debug');

        // --- DATA STATE (Firebase Synced) ---
        let employees = []; // Synced via onSnapshot
        let history = []; // Synced via onSnapshot (Summary of runs)
        let departmentConfigs = {}; // Synced via onSnapshot
        let settings = {}; // Synced via onSnapshot (Theme/Logo)
        let tempProfilePic = null; // Temporary state for image uploads
        
        let selectedEmployee = null;
        let currentPayrollState = {}; // Buffer for the currently visible month/year
        let isMobileListVisible = true;
        let currentView = 'dashboard';
        let currentFilter = { campus: 'All', department: 'All' };
        let editorMonth = "";
        let editorYear = new Date().getFullYear();
        
        const MONTHS = ["January","February","March","April","May","June","July","August","September","October","November","December"];
        const CAMPUSES = ['Sibounheuang', 'Chommany'];

        // --- LAO PAYROLL CONSTANTS ---
        const LAO_FIELDS = {
            research: 'ດຸໝັ່ນຄົ້ນຄວ້າ&ພັດທະນາການສອນການສອນ (ຮູ້ນໍາໃຊ້ເຕັກນິກເພື່ອເຮັດໃຫ້ ນຮ ມັກຮຽນ)',
            media: 'ນຳໃຊ້ສື່ການສອນ/ແຕ່ງບົດສອນ/ຕິດຕາມພັດທະນາການ ນຮ.ຫ້າວຫັນໃນການປະກອບສ່ວນໃນວຽກອື່ນໆຂອງໂຮງຮຽນ',
            behaviorBasic: 'ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ໃສ່ໃຈນຳ ນັກຮຽນ', 
            classResp: 'ຄວາມຮັບຜິດຊອບໃນຫ້ອງຮຽນ : ທຸກໆຢ່າງ',
            policy: 'ນະໂຍບາຍອື່ນໆ',
            basic: 'ເງີນເດືອນພື້ນຖານ', 
            cert: 'ໃບປະກາດ: ປຕີ (ສອງແສນຫ້າສິບ),ຊັ້ນສູງ (ສອງແສນ),ຊັ້ນກາງ (ໜຶ່ງແສນຫ້າສິບ)',
            homeroom: 'ຄູປະຈຳຫ້ອງ/ຄູປະຈຳຫ້ອງສະໝຸດ/ຄູປະຈຳເດີ່ນກິລາ',
            behaviorStart: 'ຄຸ້ມຄອງລະບຽບແລະຄວາມປະພຶດ ນຮ/ໃສ່ໃຈນຳນັກຮຽນ',
            start: 'ເລີ້ມຕົ້ນ',
            accumulated: 'ເງີນສະສົມປີຜ່ານມາ',
            increase: 'ເພີ້ມປະຈຳປີ 2025-2026'
        };
        const laoEarningsStruct = [ LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy, LAO_FIELDS.basic, LAO_FIELDS.cert, LAO_FIELDS.homeroom, LAO_FIELDS.behaviorStart, LAO_FIELDS.start, LAO_FIELDS.accumulated, LAO_FIELDS.increase ];
        const defaultDeptConfigs = { 
            'Kindergarten': { earnings: [...laoEarningsStruct], deductions: ['Tax (5%)', 'Social Security (5.5%)', 'Late Arrival'] }, 
            'Primary': { earnings: [...laoEarningsStruct], deductions: ['Tax', 'Social Security'] }, 
            'Secondary': { earnings: [...laoEarningsStruct], deductions: ['Tax'] }, 
            'Leadership (Head/VP)': { earnings: [...laoEarningsStruct], deductions: ['Tax'] }, 
            'Administration': { earnings: [...laoEarningsStruct], deductions: ['Tax'] }, 
            'English': { earnings: [], deductions: [] } 
        };

        // --- FIREBASE PATHS ---
        const getColRef = (name) => collection(db, `artifacts/${appId}/users/${userId}/${name}`);
        const getDocRef = (collectionName, docId) => doc(db, `artifacts/${appId}/users/${userId}/${collectionName}`, docId);

        // --- FIREBASE INITIALIZATION ---

        window.onload = initFirebase;

        async function initFirebase() {
            try {
                if (Object.keys(firebaseConfig).length === 0) {
                    throw new Error("Firebase configuration is missing.");
                }
                
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);

                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        document.getElementById('user-info').textContent = `User ID: ${userId}`;
                        loadDataListeners(); // Start real-time sync
                    } else {
                        isAuthReady = true; 
                        console.log("Signed in anonymously.");
                    }
                    finishUISetup(); // Finalize UI after auth attempt
                });

            } catch (error) {
                console.error("Error initializing Firebase:", error);
                document.getElementById('user-info').textContent = `Error: ${error.message}`;
            }
        }

        // --- FIREBASE DATA LISTENERS (Real-Time Sync) ---

        function loadDataListeners() {
            if (!isAuthReady || !userId || !db) return;

            // 1. Employee Roster
            onSnapshot(getColRef('neerada_payroll_employees'), (snapshot) => {
                employees = [];
                snapshot.forEach(doc => {
                    // Ensure payrollHistory and savedPayroll objects exist for logic below
                    const data = doc.data();
                    data.payrollHistory = data.payrollHistory || {};
                    data.savedPayroll = data.savedPayroll || createInitialState(data.department || 'English');
                    employees.push({ id: doc.id, ...data });
                });
                
                renderDeptSidebar();
                renderEmployeeList();
                if (selectedEmployee) selectEmployee(employees.find(e => e.id === selectedEmployee.id) || null, false);
                updateDashboardStats();
            }, console.error);

            // 2. Department Configs
            onSnapshot(getDocRef('neerada_settings', 'department_configs'), (docSnap) => {
                if (docSnap.exists() && docSnap.data().configs) {
                    departmentConfigs = docSnap.data().configs;
                } else {
                    departmentConfigs = JSON.parse(JSON.stringify(defaultDeptConfigs));
                    saveDeptConfig(departmentConfigs, false); // Save defaults without waiting for manual action
                }
                renderDeptSidebar();
                if (currentView === 'config') initConfigView();
            }, console.error);

            // 3. Payroll History Summary
            onSnapshot(getColRef('neerada_payroll_history'), (snapshot) => {
                history = [];
                snapshot.forEach(doc => {
                    history.push({ id: doc.id, ...doc.data() });
                });
                updateDashboardStats();
            }, console.error);
            
            // 4. App Settings (Theme/Logo)
            onSnapshot(getDocRef('neerada_settings', 'app_settings'), (docSnap) => {
                if (docSnap.exists()) {
                    settings = docSnap.data();
                    if (settings.theme) window.setTheme(settings.theme, false);
                    if (settings.logo) {
                        // Store the Base64 logo in localStorage for quick access (cache)
                        localStorage.setItem('neerada_school_logo', settings.logo);
                    } else {
                        localStorage.removeItem('neerada_school_logo');
                    }
                    renderPreview();
                }
            }, console.error);
        }

        // --- UI Setup (Runs after Firebase auth and listeners are established) ---

        function finishUISetup() {
            try {
                // Initialize Dates
                const yearSelect = document.getElementById('filter-year');
                const edYearSelect = document.getElementById('editor-year');
                const edMonthSelect = document.getElementById('editor-month');
                const currentYear = new Date().getFullYear();
                
                // Determine relevant years: current year + max year from history + 2 previous years
                const allYears = new Set([currentYear, currentYear - 1, currentYear - 2]);
                history.forEach(h => allYears.add(parseInt(h.year)));
                const sortedYears = Array.from(allYears).sort((a, b) => b - a);

                const yrs = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
                
                yearSelect.innerHTML = `<option value="All">All Years</option>` + yrs;
                yearSelect.value = 'All';
                
                edYearSelect.innerHTML = sortedYears.map(y => `<option value="${y}">${y}</option>`).join('');
                edYearSelect.value = currentYear;
                
                const currentM = MONTHS[new Date().getMonth()];
                edMonthSelect.innerHTML = MONTHS.map(m => `<option value="${m}">${m}</option>`).join('');
                document.getElementById('filter-month').value = currentM;
                edMonthSelect.value = currentM;
                editorMonth = currentM;
                editorYear = currentYear;

                // Final UI rendering (most are now handled by onSnapshot)
                updateDateWidget();
                document.getElementById('copyright-year').innerText = new Date().getFullYear();
                if(window.lucide) lucide.createIcons();
            } catch (error) {
                console.error("UI Setup Error:", error);
            } finally {
                // Show content
                document.getElementById('loading-screen').style.display = 'none';
                document.getElementById('app-content').classList.remove('hidden');
                window.switchView('dashboard');
                window.addEventListener('resize', updateViewVisibility);
            }
        }

        // --- HELPER FUNCTIONS ---
        function getSmartPaymentDate(monthName, year) { 
            const mIndex = MONTHS.indexOf(monthName); 
            let date = new Date(year, mIndex + 1, 0); 
            const day = date.getDay(); 
            if (day === 0) date.setDate(date.getDate() - 2); // Sunday -> Friday
            else if (day === 6) date.setDate(date.getDate() - 1); // Saturday -> Friday
            return date.toLocaleDateString(); 
        }
        
        function generateEmployeeId(dept, name, campus) {
            if (!dept || !name) return "---";
            const campusCode = campus === 'Sibounheuang' ? 'SBH' : (campus === 'Chommany' ? 'CHM' : 'UNK');
            const deptParts = dept.trim().split(/\s+/);
            let code = deptParts[0].charAt(0).toUpperCase();
            if (deptParts.length > 1) {
                const secondWord = deptParts[1].replace(/[^a-zA-Z0-9]/g, '');
                if (secondWord.length > 0) code += secondWord.charAt(0).toUpperCase();
            }
            const firstName = name.trim().split(/\s+/)[0].toUpperCase();
            return `${campusCode}-${code}-${firstName}`;
        }

        function formatMoney(amount) { return '₭ ' + parseFloat(amount||0).toLocaleString('en-US', {minimumFractionDigits: 0, maximumFractionDigits: 0}); }
        function updateDateWidget() { document.getElementById('date-display').innerText = new Date().toLocaleDateString(undefined, { month: 'short', day: 'numeric' }); }
        function updateBulkPeriodDisplay() {
            document.getElementById('bulk-period-display').innerText = `${editorMonth} ${editorYear}`;
        }

        // --- PAYSLIP DATA CONFIGURATION (FIREBASE) ---
        function initConfigView() { 
            const select = document.getElementById('config-dept-select'); 
            const depts = Object.keys(departmentConfigs);
            
            const englishIndex = depts.indexOf('English');
            if (englishIndex !== -1) {
                depts.splice(englishIndex, 1);
                depts.push('English');
            }
            select.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');

            loadDeptConfig(); 
        }
        window.addNewDept = async () => { 
            const name = prompt("Enter new Department name:"); 
            if(name && !departmentConfigs[name]) { 
                departmentConfigs[name] = { earnings: ['Basic Salary'], deductions: ['Tax'] }; 
                await window.saveDeptConfig(departmentConfigs);
                initConfigView(); 
            } 
        };
        window.deleteDept = async () => { 
            const dept = document.getElementById('config-dept-select').value; 
            if(dept === 'English' || Object.keys(defaultDeptConfigs).includes(dept)) { 
                alert("Cannot delete default or English departments."); 
                return; 
            } 
            if(!dept || !confirm(`Delete ${dept}? This will remove it from configuration, but staff records using this department name must be manually updated.`)) return; 
            delete departmentConfigs[dept]; 
            await window.saveDeptConfig(departmentConfigs);
            initConfigView(); 
        };
        window.renameDept = async () => { 
            const oldName = document.getElementById('config-dept-select').value; 
            if(oldName === 'English' || Object.keys(defaultDeptConfigs).includes(oldName)) { 
                alert("Cannot rename default departments."); 
                return; 
            } 
            if(!oldName) return; 
            const newName = prompt("Enter new name:", oldName); 
            if(newName && newName !== oldName && !departmentConfigs[newName]) { 
                departmentConfigs[newName] = departmentConfigs[oldName]; 
                delete departmentConfigs[oldName]; 
                
                // Update employee records in Firestore
                const batchUpdates = employees.filter(e => e.department === oldName).map(emp => {
                    const empRef = getDocRef('neerada_payroll_employees', emp.id);
                    return setDoc(empRef, { department: newName, lastModified: new Date().toISOString() }, { merge: true });
                });
                await Promise.all(batchUpdates);

                await window.saveDeptConfig(departmentConfigs);
                initConfigView(); 
            } 
        };
        window.loadDeptConfig = () => { const dept = document.getElementById('config-dept-select').value; if (departmentConfigs[dept]) renderConfigLists(dept); else document.getElementById('config-editor-area').innerHTML = '<p class="p-4 text-gray-500">Department not found or selected.</p>'; }
        
        window.saveDeptConfig = async (config, showMessage = true) => { 
            if (!userId) { alert("Authentication not ready."); return; }
            const configRef = getDocRef('neerada_settings', 'department_configs');
            try {
                await setDoc(configRef, { configs: config || departmentConfigs });
                if (showMessage) alert("Configuration Saved to Firestore!");
            } catch (error) {
                console.error("Error saving config:", error);
                if (showMessage) alert("Failed to save configuration. See console.");
            }
        };

        function renderConfigLists(dept) { 
            const cfg = departmentConfigs[dept]; 
            const isEnglish = dept === 'English';

            if (isEnglish) {
                document.getElementById('config-editor-area').innerHTML = `<div class="md:col-span-2 bg-blue-50 p-4 rounded border border-blue-200"><p class="text-sm text-blue-800 font-medium">The 'English' department uses a fixed set of fields (USD/LAK split) managed directly within the Staff Payroll view.</p><p class="text-xs text-gray-600 mt-2">Use the other department tabs to manage dynamic LAK fields.</p></div>`;
                return;
            }

            const renderList = (type, list) => list.map((item, idx) => {
                const isFixedLao = type === 'earnings' && Object.values(LAO_FIELDS).includes(item);
                const disabledButton = isFixedLao ? 'disabled title="Fixed system field"' : '';
                return `<div class="flex gap-2 items-center"><input type="text" value="${item}" onchange="window.updateConfigField('${dept}', '${type}', ${idx}, this.value)" class="flex-1 text-sm border rounded p-1.5 ${isFixedLao ? 'bg-gray-100/50 text-gray-800 font-medium' : ''}"><button onclick="window.removeConfigField('${dept}', '${type}', ${idx})" ${disabledButton} class="text-red-400 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed"><i data-lucide="trash-2" class="w-4 h-4"></i></button></div>`
            }).join(''); 
            
            document.getElementById('config-editor-area').innerHTML = `<div class="bg-green-50 p-4 rounded border border-green-100"><h3 class="font-bold text-green-800 mb-4 flex justify-between items-center">Earnings Fields<button onclick="window.addField('earnings')" class="text-xs bg-green-200 px-2 py-1 rounded hover:bg-green-300">+ Add Field</button></h3><div id="config-earnings-list" class="space-y-2">${renderList('earnings', cfg.earnings)}</div></div><div class="bg-red-50 p-4 rounded border border-red-100"><h3 class="font-bold text-red-800 mb-4 flex justify-between items-center">Deductions Fields<button onclick="window.addField('deductions')" class="text-xs bg-red-200 px-2 py-1 rounded hover:bg-red-300">+ Add Field</button></h3><div id="config-deductions-list" class="space-y-2">${renderList('deductions', cfg.deductions)}</div></div>`; 
            if(window.lucide) lucide.createIcons(); 
        }

        window.addField = (type) => { const dept = document.getElementById('config-dept-select').value; if(dept) { departmentConfigs[dept][type].push("New Custom Field"); renderConfigLists(dept); } };
        window.removeConfigField = (dept, type, idx) => { 
             const isFixedLao = type === 'earnings' && Object.values(LAO_FIELDS).includes(departmentConfigs[dept][type][idx]);
             if (isFixedLao) return; // Prevent removal of fixed fields
             departmentConfigs[dept][type].splice(idx, 1); 
             renderConfigLists(dept); 
        };
        window.updateConfigField = (dept, type, idx, val) => { departmentConfigs[dept][type][idx] = val; };
        
        function createInitialState(dept) { 
            if (dept === 'English') { 
                return { 
                    basicPay: 0, accumulated: 0, increase: 0, earningsOthersUSD: 0, 
                    otHours: 0, otRate: 0, itLAK: 0, extraWorkOthersLAK: 0, stipendLAK: 0, 
                    profTax: 0, absences: 0, visa: 0, deductionsOthersUSD: 0, 
                    insuranceLAK: 0, deductionsOthersLAK: 0, 
                    cashOut: 0, 
                    exchangeRate: 6000, // Default rate for English staff
                    notes: "" 
                }; 
            } 
            const config = departmentConfigs[dept]; 
            const state = {}; 
            if(config) { 
                // Initialize all fields to 0 for LAK departments
                if (config.earnings) config.earnings.forEach(f => state[f] = 0);
                if (config.deductions) config.deductions.forEach(f => state[f] = 0);
            } 
            return state; 
        }

        // --- STAFF & PAYROLL MANAGER (FIREBASE) ---
        window.editCurrentStaff = () => { if(selectedEmployee) window.openStaffModal(selectedEmployee.id); }
        window.openStaffModal = (empId) => {
            const modal = document.getElementById('add-modal'); 
            const title = document.getElementById('modal-title'); 
            const deptSelect = document.getElementById('form-department'); 
            const deletePhotoBtn = document.getElementById('delete-modal-photo-btn');
            const depts = Object.keys(departmentConfigs).sort(); 
            deptSelect.innerHTML = depts.map(d => `<option value="${d}">${d}</option>`).join('');
            
            // Reset form fields
            document.getElementById('form-id').value = ""; document.getElementById('form-name').value = ""; document.getElementById('form-position').value = ""; document.getElementById('form-email').value = ""; document.getElementById('form-whatsapp').value = ""; document.getElementById('form-profile-pic').value = ""; 
            tempProfilePic = 'KEEP_EXISTING';
            
            document.getElementById('form-preview-pic').classList.add('hidden'); document.getElementById('form-default-icon').classList.remove('hidden');
            deletePhotoBtn.classList.add('hidden');

            if(depts.length > 0) deptSelect.value = depts[0];

            if (empId) { 
                const emp = employees.find(e => String(e.id) === String(empId)); 
                if (emp) { 
                    title.innerText = "Edit Staff"; 
                    document.getElementById('form-id').value = emp.id; 
                    document.getElementById('form-name').value = emp.name; 
                    document.getElementById('form-campus').value = emp.campus || 'Sibounheuang'; 
                    document.getElementById('form-department').value = emp.department; 
                    document.getElementById('form-position').value = emp.position; 
                    document.getElementById('form-email').value = emp.email; 
                    document.getElementById('form-whatsapp').value = emp.whatsapp || ''; 
                    
                    if (emp.profilePic) { 
                        tempProfilePic = emp.profilePic;
                        const prev = document.getElementById('form-preview-pic'); 
                        prev.src = emp.profilePic; 
                        prev.classList.remove('hidden'); 
                        document.getElementById('form-default-icon').classList.add('hidden'); 
                        deletePhotoBtn.classList.remove('hidden');
                    } 
                } 
            } else { 
                title.innerText = "Add New Staff";
                tempProfilePic = null;
            } 
            modal.classList.remove('hidden'); modal.classList.add('flex');
        };
        window.closeModal = () => { document.getElementById('add-modal').classList.add('hidden'); document.getElementById('add-modal').classList.remove('flex'); };
        window.handleProfileUpload = (input) => { 
            const file = input.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = function(e) { 
                tempProfilePic = e.target.result; 
                const prev = document.getElementById('form-preview-pic'); 
                prev.src = tempProfilePic; 
                prev.classList.remove('hidden'); 
                document.getElementById('form-default-icon').classList.add('hidden'); 
                document.getElementById('delete-modal-photo-btn').classList.remove('hidden');
            }; 
            reader.readAsDataURL(file); 
        };
        window.clearModalPhoto = () => {
            tempProfilePic = null;
            document.getElementById('form-profile-pic').value = "";
            document.getElementById('form-preview-pic').classList.add('hidden');
            document.getElementById('form-default-icon').classList.remove('hidden');
            document.getElementById('delete-modal-photo-btn').classList.add('hidden');
            alert("Photo marked for removal. Click 'Save Staff' to confirm this change.");
        };

        window.saveEmployee = async (e) => { 
            e.preventDefault(); 
            if (!db || !userId) { alert("System not ready. Please wait for data synchronization."); return; }
            const formData = new FormData(document.getElementById('add-form')); 
            const data = Object.fromEntries(formData.entries()); 
            
            let newProfilePicValue = null;
            if (tempProfilePic && tempProfilePic !== 'KEEP_EXISTING') {
                newProfilePicValue = tempProfilePic;
            } else if (tempProfilePic === null) {
                newProfilePicValue = null;
            } else if (data.id && data.id.trim() !== "") {
                const existingEmp = employees.find(e => String(e.id) === String(data.id));
                newProfilePicValue = existingEmp ? existingEmp.profilePic : null;
            }
            
            data.profilePic = newProfilePicValue;

            const isNew = !(data.id && data.id.trim() !== "");
            let docRef;

            if (!isNew) { 
                docRef = getDocRef('neerada_payroll_employees', data.id);
            } else {
                // Use a default new document reference
                docRef = getDocRef('neerada_payroll_employees', Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase());
                data.id = docRef.id;
            }
            
            // Prepare data for saving (clean properties not needed in DB)
            delete data.profilePicFile; // Assuming file input name was changed to "form-profile-pic"
            
            // Check for department change to wipe history (only if updating existing)
            let existingEmp = null;
            if (!isNew) {
                existingEmp = employees.find(e => String(e.id) === String(data.id));
            }
            
            let newEmployeeData = { 
                name: data.name, 
                department: data.department, 
                position: data.position, 
                email: data.email, 
                campus: data.campus,
                whatsapp: data.whatsapp || '',
                profilePic: data.profilePic || null,
                lastModified: new Date().toISOString()
            };

            if (!isNew && existingEmp.department !== data.department) {
                if(confirm("Changing the department will clear the employee's payroll history. Continue?")) {
                    newEmployeeData.payrollHistory = {};
                    newEmployeeData.savedPayroll = createInitialState(data.department);
                } else {
                    alert("Department change cancelled.");
                    return;
                }
            } else if (isNew) {
                 newEmployeeData.payrollHistory = {};
                 newEmployeeData.savedPayroll = createInitialState(data.department);
            }

            try {
                await setDoc(docRef, newEmployeeData, { merge: true });
                alert(`Staff member ${data.name} saved successfully!`);
                window.closeModal();
            } catch (error) {
                console.error("Error saving employee:", error);
                alert("Failed to save employee. Check console for details.");
            }
        };

        window.deleteBulkPhotos = async () => {
             if (!confirm(`WARNING: This will remove the Profile Picture URL from ALL ${employees.length} employees in the database. Are you sure?`)) return;
            
            if (!db || !userId) { alert("System not ready."); return; }

            const updates = employees
                .filter(emp => emp.profilePic)
                .map(emp => {
                    const empRef = getDocRef('neerada_payroll_employees', emp.id);
                    return setDoc(empRef, { profilePic: null, lastModified: new Date().toISOString() }, { merge: true });
                });

            if (updates.length > 0) {
                try {
                    await Promise.all(updates);
                    alert(`Successfully removed photos from ${updates.length} employees.`);
                } catch (error) {
                    console.error("Error deleting photos:", error);
                    alert("Failed to remove photos. Check console for details.");
                }
            } else {
                alert("No photos were found to delete.");
            }
        };

        window.deleteEmployee = async (id) => { 
            if(!confirm("Are you sure you want to delete this employee? This action is permanent and affects the database.")) return; 
            if (!db || !userId) { alert("System not ready."); return; }

            try {
                await deleteDoc(getDocRef('neerada_payroll_employees', id));
                
                if(selectedEmployee && String(selectedEmployee.id) === String(id)) { 
                    clearSelection(); 
                    document.getElementById('editor-area').classList.add('hidden'); 
                    document.getElementById('empty-state').classList.remove('hidden'); 
                } 
                alert("Employee deleted successfully.");
            } catch (error) {
                 console.error("Error deleting employee:", error);
                 alert("Failed to delete employee. Check console for details.");
            }
        };
        
        window.deleteEmployeesByDepartment = async (campus, department) => {
            const affectedEmployees = employees.filter(e => e.campus === campus && e.department === department);
            if (affectedEmployees.length === 0) {
                alert(`No employees found in ${department} (${campus}) to delete.`);
                return;
            }
            
            if (!confirm(`WARNING: This will permanently delete ALL ${affectedEmployees.length} staff members in ${department} (${campus}). This action cannot be undone.`)) {
                return;
            }

            if (!db || !userId) { alert("System not ready."); return; }

            const deletePromises = affectedEmployees.map(emp => {
                return deleteDoc(getDocRef('neerada_payroll_employees', emp.id));
            });

            alert(`Starting bulk deletion of ${affectedEmployees.length} employees...`);
            try {
                await Promise.all(deletePromises);
                alert(`Successfully deleted all staff in ${department} (${campus}).`);
                if (selectedEmployee && selectedEmployee.campus === campus && selectedEmployee.department === department) {
                    clearSelection();
                    document.getElementById('editor-area').classList.add('hidden');
                    document.getElementById('empty-state').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Bulk deletion failed:", error);
                alert("Bulk deletion failed. Check console for details.");
            }
        };

        // --- VIEW SWITCHING ---
        window.switchView = (view) => { 
            currentView = view; 
            ['view-dashboard', 'view-payroll', 'view-config'].forEach(v => document.getElementById(v).classList.add('hidden')); 
            ['tab-dashboard', 'tab-payroll', 'tab-config'].forEach(t => document.getElementById(t).className = "px-4 py-1.5 text-sm font-medium rounded-md text-blue-100 hover:bg-blue-800 transition-colors"); 
            document.getElementById('view-' + view).classList.remove('hidden'); 
            document.getElementById('tab-' + view).className = "px-4 py-1.5 text-sm font-medium rounded-md bg-blue-800 text-white transition-colors"; 
            if (view === 'dashboard') updateDashboardStats(); 
            else if (view === 'payroll') { 
                isMobileListVisible = true; 
                updateViewVisibility(); 
                updateBulkPeriodDisplay();
            } 
            else if (view === 'config') initConfigView(); 
        };
        function updateViewVisibility() { 
            if (currentView !== 'payroll') return; 
            const sidebar = document.getElementById('sidebar'); 
            const main = document.getElementById('payroll-workspace'); 
            const backBtn = document.getElementById('mobile-back-btn'); 
            if (window.innerWidth < 1024) { 
                if (isMobileListVisible) { 
                    sidebar.classList.remove('hidden'); 
                    main.classList.add('hidden'); 
                    backBtn.classList.add('hidden'); 
                } else { 
                    sidebar.classList.add('hidden'); 
                    main.classList.remove('hidden'); 
                    backBtn.classList.remove('hidden'); 
                } 
            } else { 
                sidebar.classList.remove('hidden'); 
                main.classList.remove('hidden'); 
                backBtn.classList.add('hidden'); 
            } 
        }
        window.goBack = () => { isMobileListVisible = true; updateViewVisibility(); };
        
        // --- FILTERS & LIST RENDERING ---
        function renderDeptSidebar() { 
            const container = document.getElementById('dept-tree'); 
            const depts = Object.keys(departmentConfigs).sort(); 
            const getCount = (c, d) => employees.filter(e => e.campus === c && e.department === d && e.name).length; 
            const getAllCount = () => employees.filter(e => e.name).length; 
            let html = `<div onclick="window.setFilter('All', 'All')" class="cursor-pointer px-3 py-2 rounded mb-2 text-sm flex justify-between items-center gap-2 ${currentFilter.campus === 'All' ? 'bg-blue-100 text-blue-800 font-bold' : 'text-gray-600 hover:bg-gray-200'}"><div class="flex items-center gap-2"><i data-lucide="users" class="w-4 h-4"></i> All Staff</div><span class="text-xs bg-black/10 px-1.5 py-0.5 rounded-full font-mono">${getAllCount()}</span></div>`; 
            CAMPUSES.forEach(campus => { 
                html += `<div class="mt-4 mb-2 px-3 py-1.5 rounded-lg text-xs font-bold uppercase tracking-wider flex justify-between items-center cursor-pointer text-blue-800 bg-blue-100 hover:bg-blue-200 transition-colors shadow-sm" onclick="window.setFilter('${campus}', 'All')">${campus}<i data-lucide="chevron-down" class="w-3 h-3 text-blue-500"></i></div>`; 
                depts.forEach(dept => { 
                    const isActive = currentFilter.campus === campus && currentFilter.department === dept; 
                    const count = getCount(campus, dept); 
                    const deleteBtn = count > 0 ? `<button onclick="event.stopPropagation(); window.deleteEmployeesByDepartment('${campus}', '${dept}')" class="text-red-400 hover:text-red-600 disabled:opacity-50 disabled:cursor-not-allowed ml-1 p-1" title="Delete All ${dept} Staff"><i data-lucide="trash-2" class="w-3 h-3"></i></button>` : '';

                    html += `<div onclick="window.setFilter('${campus}', '${dept}')" class="cursor-pointer px-3 py-1.5 rounded ml-2 text-sm transition-colors flex justify-between items-center ${isActive ? 'bg-white shadow-sm text-blue-700 font-medium border-l-2 border-blue-500' : 'text-gray-500 hover:bg-gray-200 border-l-2 border-transparent'}"><span>${dept}</span><div class="flex items-center"><span class="text-[10px] ${isActive ? 'bg-blue-50 text-blue-600' : 'bg-gray-100 text-gray-400'} px-1.5 py-0.5 rounded-full font-mono">${count}</span>${deleteBtn}</div></div>`; 
                }); 
            }); 
            container.innerHTML = html; 
            const mob = document.getElementById('mobile-filter'); 
            let opts = '<option value="All|All">All Staff</option>'; 
            CAMPUSES.forEach(c => { 
                opts += `<optgroup label="${c}">`; 
                depts.forEach(d => opts += `<option value="${c}|${d}">${d}</option>`); 
                opts += `</optgroup>`; 
            }); 
            mob.innerHTML = opts; 
            mob.value = `${currentFilter.campus}|${currentFilter.department}`;
            if(window.lucide) lucide.createIcons(); 
        }

        window.handleSelect = (id) => { 
            const emp = employees.find(e => String(e.id) === String(id)); 
            if(emp) selectEmployee(emp, true); 
        }
        function clearSelection() { selectedEmployee = null; currentPayrollState = {}; }
        function selectEmployee(emp, shouldGoMobile = false) { 
            try { 
                clearSelection(); 
                selectedEmployee = emp; 
                
                // Load latest data from employee's saved buffer
                currentPayrollState = JSON.parse(JSON.stringify(emp.savedPayroll || createInitialState(emp.department)));
                
                renderEmployeeList(); 
                loadPeriodData(); 
                if (shouldGoMobile && window.innerWidth < 1024) { 
                    isMobileListVisible = false; 
                    updateViewVisibility(); 
                } 
                document.getElementById('empty-state').classList.add('hidden'); 
                document.getElementById('editor-area').classList.remove('hidden'); 
            } catch (e) { 
                console.error("Selection Error:", e); 
                alert("An error occurred while selecting the employee."); 
            } 
        }
        window.loadPeriodData = () => { 
            if (!selectedEmployee) return; 
            
            const selectedMonth = document.getElementById('editor-month').value; 
            const selectedYear = document.getElementById('editor-year').value; 
            const periodKey = `${selectedYear}-${selectedMonth}`; 
            
            // 1. Check history for the selected period
            if (selectedEmployee.payrollHistory && selectedEmployee.payrollHistory[periodKey]) { 
                currentPayrollState = JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[periodKey])); 
            } else { 
                // 2. If no history, load the last saved buffer state (which is in currentPayrollState already in selectEmployee)
                // We ensure it loads the correct structure based on the department config
                if (!isStateHasData(currentPayrollState) || selectedEmployee.department !== currentPayrollState.department) {
                    currentPayrollState = createInitialState(selectedEmployee.department);
                }
            } 
            
            editorMonth = selectedMonth; 
            editorYear = selectedYear; 
            renderEditor(); 
            updateBulkPeriodDisplay();
        };
        window.loadPreviousMonthData = () => { 
            if (!selectedEmployee) return; 
            const currentMonth = document.getElementById('editor-month').value; 
            const currentYear = parseInt(document.getElementById('editor-year').value); 
            const mIndex = MONTHS.indexOf(currentMonth); 
            let prevIndex = mIndex - 1; 
            let prevYear = currentYear; 
            if (prevIndex < 0) { 
                prevIndex = 11; 
                prevYear--; 
            } 
            const prevMonthName = MONTHS[prevIndex]; 
            const prevKey = `${prevYear}-${prevMonthName}`; 
            if (selectedEmployee.payrollHistory && selectedEmployee.payrollHistory[prevKey]) { 
                if(confirm(`Overwrite current data with data from ${prevMonthName} ${prevYear}?`)) { 
                    currentPayrollState = JSON.parse(JSON.stringify(selectedEmployee.payrollHistory[prevKey])); 
                    renderEditor(); 
                } 
            } else { 
                alert(`No saved payroll data found for the previous month (${prevMonthName} ${prevYear}).`); 
            } 
        };
        window.resetCurrentPayroll = () => { if(!confirm("Reset current fields to zero?")) return; currentPayrollState = createInitialState(selectedEmployee.department); renderEditor(); };
        function findLatestPayrollData(emp) { 
            if (emp.savedPayroll && Object.keys(emp.savedPayroll).length > 0) return emp.savedPayroll; 
            if (emp.payrollHistory && Object.keys(emp.payrollHistory).length > 0) { 
                const keys = Object.keys(emp.payrollHistory).sort(); 
                return emp.payrollHistory[keys[keys.length-1]]; 
            } 
            return null; 
        }
        function isStateHasData(state) { 
            if(!state) return false; 
            // Check for English state
            if (state.basicPay !== undefined || state.exchangeRate !== undefined) {
                 return Object.values(state).some(val => val !== 0 && val !== "" && val !== null);
            }
            // Check for Lao state
            return Object.values(state).some(val => { 
                return (typeof val === 'number' && val > 0) || (typeof val === 'string' && parseFloat(val) > 0) || (typeof val === 'string' && val.trim() !== "" && val !== "0"); 
            }); 
        }

        function renderEmployeeList() {
            const container = document.getElementById('employee-list');
            container.innerHTML = '';
            let filtered = employees;
            if (currentFilter.campus !== 'All') filtered = filtered.filter(e => e.campus === currentFilter.campus);
            if (currentFilter.department !== 'All') filtered = filtered.filter(e => e.department === currentFilter.department);
            if (filtered.length === 0) { container.innerHTML = `<div class="text-center p-8 text-gray-400 text-sm">No staff found for this filter.</div>`; return; }
            
            const formatTime = (iso) => {
                if(!iso) return "";
                const d = new Date(iso);
                return d.toLocaleDateString(undefined, {month:'short', day:'numeric'}) + ' ' + d.toLocaleTimeString(undefined, {hour:'2-digit', minute:'2-digit'});
            };

            filtered.forEach(emp => {
                const isActive = selectedEmployee && String(selectedEmployee.id) === String(emp.id);
                const div = document.createElement('div');
                div.className = `p-3 rounded-lg cursor-pointer transition-all border mb-2 ${isActive ? 'bg-blue-50 border-blue-200 shadow-sm' : 'hover:bg-gray-50 border-transparent bg-white'}`;
                
                div.onclick = (e) => {
                    window.handleSelect(String(emp.id));
                };

                const lastMod = emp.lastModified ? `<div class="text-[10px] text-orange-600 mt-2 flex items-center gap-1 bg-orange-50 px-2 py-1 rounded w-fit"><i data-lucide="clock" class="w-3 h-3"></i> Modified: ${formatTime(emp.lastModified)}</div>` : '';

                div.innerHTML = `
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="font-bold text-gray-800 text-sm">${emp.name}</p>
                            <div class="flex items-center gap-1 text-xs text-gray-500 mt-0.5">
                                <span class="truncate max-w-[100px]">${emp.position}</span>
                                <span class="text-gray-300">•</span>
                                <span class="text-blue-600 font-medium">${emp.department}</span>
                            </div>
                            ${lastMod}
                        </div>
                        ${isActive ? '<i data-lucide="chevron-right" class="w-4 h-4 text-blue-500"></i>' : ''}
                    </div>
                    <div class="flex justify-end gap-2 mt-2 border-t pt-1 ${isActive ? 'block' : 'hidden'}">
                        <button onclick="event.stopPropagation(); window.deleteEmployee('${String(emp.id)}')" class="text-xs text-red-400 hover:text-red-600 flex items-center gap-1"><i data-lucide="trash-2" class="w-3 h-3"></i> Del</button>
                    </div>`;
                container.appendChild(div);
            });
            if(window.lucide) lucide.createIcons();
        }

        window.setFilter = (c, d) => { currentFilter = { campus: c, department: d }; document.getElementById('mobile-filter').value = `${c}|${d}`; renderEmployeeList(); renderDeptSidebar(); };
        window.handleMobileFilter = (val) => { const [c, d] = val.split('|'); window.setFilter(c, d); };
        window.clearFilter = () => window.setFilter('All', 'All');
        window.triggerImport = () => document.getElementById('csv-input').click();
        window.downloadTemplate = () => {
            const csvContent = "data:text/csv;charset=utf-8,Full Name,Department,Position,Email,Campus,WhatsApp Number\nSomchai Vong,Kindergarten,Teacher,somchai@school.com,Sibounheuang,8562055555555";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "neerada_staff_template.csv");
            document.body.appendChild(link); link.click(); document.body.removeChild(link);
        };
        window.handleCSV = (input) => {
            const file = input.files[0]; if (!file) return;
            const reader = new FileReader();
            reader.onload = async function(e) {
                if (!db || !userId) { alert("System not ready. Please wait for data synchronization."); input.value = ''; return; }

                const text = e.target.result; const rows = text.split('\n'); let count = 0;
                const batchUpdates = [];

                for(let i=1; i<rows.length; i++) {
                    const cols = rows[i].split(',');
                    if(cols.length >= 5 && cols[0].trim() !== "") {
                        const newId = getColRef('neerada_payroll_employees').doc().id;
                        const newEmp = { 
                            id: newId, 
                            name: cols[0].trim(), 
                            department: cols[1].trim(), 
                            position: cols[2].trim(), 
                            email: cols[3].trim(), 
                            campus: cols[4].trim().replace('\r', ''), 
                            whatsapp: cols[5] ? cols[5].trim().replace('\r', '') : '', 
                            payrollHistory: {},
                            savedPayroll: createInitialState(cols[1].trim()),
                            lastModified: new Date().toISOString()
                        };
                        const docRef = getDocRef('neerada_payroll_employees', newId);
                        batchUpdates.push(setDoc(docRef, newEmp));
                        count++;
                    }
                }
                
                try {
                    await Promise.all(batchUpdates);
                    alert(`Imported ${count} employees and saved to Firestore.`); 
                } catch(error) {
                    console.error("Batch import failed:", error);
                    alert("Failed to save imported employees to Firestore.");
                }

                input.value = ''; 
            };
            reader.readAsText(file);
        };

        // --- DASHBOARD AND STATS LOGIC (FIREBASE) ---
        function updateDashboardStats() {
            // ... (Dashboard logic remains mostly the same, relying on local `employees` and `history` arrays synced by onSnapshot)
            const yearFilter = document.getElementById('filter-year').value;
            const monthFilter = document.getElementById('filter-month').value;
            
            // Filter history for the table (Logs)
            let filteredHistory = history.slice().sort((a, b) => b.dateId.localeCompare(a.dateId)); // Sort descending
            if (yearFilter !== 'All') filteredHistory = filteredHistory.filter(h => h.year == yearFilter);
            if (monthFilter !== 'All') filteredHistory = filteredHistory.filter(h => h.month === monthFilter);
            renderHistoryList(filteredHistory);
            
            // LIVE AGGREGATION for Top Cards & Dept Breakdown
            let displayLAK = 0;
            let displayUSD = 0;
            const deptStats = {};

            CAMPUSES.forEach(c => deptStats[c] = {});

            employees.forEach(emp => {
                if (!emp.payrollHistory) return;
                
                Object.entries(emp.payrollHistory).forEach(([periodKey, state]) => {
                    const [pYear, pMonth] = periodKey.split('-');
                    
                    if (yearFilter !== 'All' && pYear !== yearFilter) return;
                    if (monthFilter !== 'All' && pMonth !== monthFilter) return;

                    const result = calculatePayrollFromState(emp, state);
                    displayLAK += result.lak;
                    displayUSD += result.usd;

                    const c = emp.campus || 'Sibounheuang';
                    const d = emp.department || 'Unassigned';
                    if (!deptStats[c]) deptStats[c] = {};
                    if (!deptStats[c][d]) deptStats[c][d] = { ids: new Set(), lak: 0, usd: 0 };
                    
                    deptStats[c][d].ids.add(emp.id);
                    deptStats[c][d].lak += result.lak;
                    deptStats[c][d].usd += result.usd;
                });
            });

            document.getElementById('stat-employees').innerText = employees.length;
            document.getElementById('stat-total-paid-lak').innerText = formatMoney(displayLAK);
            document.getElementById('stat-total-paid-usd').innerText = '$' + displayUSD.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2});
            
            if (history.length > 0) {
                const sortedHistory = history.slice().sort((a, b) => b.dateId.localeCompare(a.dateId));
                const last = sortedHistory[0];
                document.getElementById('stat-last-month').innerText = `${last.month} ${last.year}`;
                document.getElementById('stat-last-amount').innerText = formatMoney(last.totalLAK);
            } else {
                document.getElementById('stat-last-month').innerText = "No Data";
                document.getElementById('stat-last-amount').innerText = "---";
            }

            renderDeptBreakdownTable(deptStats);
        }

        function renderDeptBreakdownTable(stats) {
            const container = document.getElementById('dept-breakdown');
            let html = `<div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden"><div class="p-4 border-b border-gray-100 bg-gray-50 flex justify-between items-center"><h3 class="font-bold text-gray-700">Department Breakdown</h3><span class="text-xs text-gray-400 uppercase font-bold">Aggregated by selected period</span></div><table class="w-full text-left"><thead class="bg-gray-50 text-gray-500 text-xs uppercase font-medium"><tr><th class="px-4 py-3">Campus</th><th class="px-4 py-3">Department</th><th class="px-4 py-3 text-center">Active Staff</th><th class="px-4 py-3 text-right">Total Pay (LAK)</th><th class="px-4 py-3 text-right">Total Pay (USD)</th></tr></thead><tbody class="divide-y divide-gray-100 text-sm">`;

            let hasData = false;
            CAMPUSES.forEach(campus => {
                if(stats[campus]) {
                    Object.keys(stats[campus]).sort().forEach(dept => {
                        const dData = stats[campus][dept];
                        if (dData.lak > 0 || dData.usd > 0) {
                            hasData = true;
                            const activeStaffInDept = employees.filter(e => e.campus === campus && e.department === dept).length;
                            html += `<tr class="hover:bg-gray-50 transition-colors"><td class="px-4 py-3 font-bold text-blue-900">${campus}</td><td class="px-4 py-3 text-gray-700">${dept}</td><td class="px-4 py-3 text-center text-gray-500">${activeStaffInDept}</td><td class="px-4 py-3 text-right font-mono font-medium">${formatMoney(dData.lak)}</td><td class="px-4 py-3 text-right font-mono text-green-700">$${dData.usd.toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}</td></tr>`;
                        }
                    });
                }
            });

            if (!hasData) {
                html += `<tr><td colspan="5" class="px-4 py-6 text-center text-gray-400">No payment data found for this period.</td></tr>`;
            }

            html += `</tbody></table></div>`;
            container.innerHTML = html;
        }

        // --- NEW: Individual Employee Dashboard Logic ---
        window.viewEmployeeHistory = () => {
            if (!selectedEmployee) return;
            window.viewEmployeeHistoryDetail();
        };
        
        // Detailed history rendering (moved from anonymous function)
        window.viewEmployeeHistoryDetail = () => {
            const modal = document.getElementById('employee-history-modal');
            const tbody = document.getElementById('employee-history-rows');
            
            document.getElementById('hist-emp-name').innerText = selectedEmployee.name;
            document.getElementById('hist-emp-dept').innerText = `${selectedEmployee.department} • ${selectedEmployee.campus}`;

            let totalLifetimeLAK = 0;
            let totalLifetimeUSD = 0;
            let rowsHtml = '';

            const hist = selectedEmployee.payrollHistory || {};
            const sortedKeys = Object.keys(hist).sort((a, b) => b.localeCompare(a));

            if (sortedKeys.length === 0) {
                rowsHtml = `<tr><td colspan="3" class="px-4 py-4 text-center text-gray-400">No payment history recorded yet.</td></tr>`;
            } else {
                sortedKeys.forEach(key => {
                    const [year, month] = key.split('-');
                    const state = hist[key];
                    const result = calculatePayrollFromState(selectedEmployee, state);
                    
                    totalLifetimeLAK += result.lak;
                    totalLifetimeUSD += result.usd;

                    rowsHtml += `
                    <tr>
                        <td class="px-4 py-3 font-medium text-gray-800">${month} ${year}</td>
                        <td class="px-4 py-3 text-right font-mono text-blue-700">${formatMoney(result.lak)}</td>
                        <td class="px-4 py-3 text-right font-mono text-green-700">$${result.usd.toFixed(2)}</td>
                    </tr>`;
                });
            }

            document.getElementById('hist-total-lak').innerText = formatMoney(totalLifetimeLAK);
            document.getElementById('hist-total-usd').innerText = '$' + totalLifetimeUSD.toLocaleString('en-US', {minimumFractionDigits: 2});
            tbody.innerHTML = rowsHtml;

            modal.classList.remove('hidden');
            modal.classList.add('flex');
        };

        // --- Calculation Helpers ---
        function calculatePayrollFromState(emp, state) {
            if (!state) return { lak: 0, usd: 0 };
            let netLAK = 0;
            let cashOutUSD = 0;

            if (emp.department === 'English') {
                 const d = state;
                 const otPayment = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0);
                 const earnSum = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0);
                 const grossUSD = earnSum + otPayment;
                 const dedUSDSum = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0);
                 const netUSD = grossUSD - dedUSDSum;
                 const convertible = netUSD - (parseFloat(d.cashOut)||0);
                 const convertedLAK = convertible * (parseFloat(d.exchangeRate)||0);
                 const extraLAK = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0);
                 const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0);
                 
                 netLAK = convertedLAK + extraLAK - dedLAK;
                 cashOutUSD = parseFloat(d.cashOut)||0;
                 return { lak: Math.max(0, netLAK), usd: Math.max(0, cashOutUSD) }; // Return both USD cashout and final LAK pay
            } else {
                const config = departmentConfigs[emp.department] || { earnings: [], deductions: [] };
                let tEarn = 0, tDed = 0;
                config.earnings.forEach(f => { 
                    const v = parseFloat(state[f] || 0); 
                    const isExcluded = (f === LAO_FIELDS.basic || f === LAO_FIELDS.start);
                    if(v > 0 && !isExcluded) tEarn += v; 
                });
                config.deductions.forEach(f => { 
                    const v = parseFloat(state[f] || 0); 
                    if(v > 0) tDed += v; 
                });
                netLAK = tEarn - tDed;
            }
            return { lak: Math.max(0, netLAK), usd: cashOutUSD };
        }

        // --- BULK OPERATIONS ---

        window.saveAllEmployeePayrollData = async () => {
            if (!db || !userId) { alert("System not ready. Save failed."); return; }
            if (!confirm(`Are you sure you want to save the current payroll data (buffer) for ALL ${employees.length} employees as the record for ${editorMonth} ${editorYear}?`)) return;

            const periodKey = `${editorYear}-${editorMonth}`;
            const updatePromises = [];
            let totalLAK = 0;
            let totalUSD = 0;
            let count = 0;


            employees.forEach(emp => {
                const docRef = getDocRef('neerada_payroll_employees', emp.id);
                // 1. Get the current saved buffer state 
                const currentState = emp.savedPayroll || createInitialState(emp.department);
                
                // 2. Prepare the history update object
                const historyUpdate = emp.payrollHistory || {};
                historyUpdate[periodKey] = currentState; // Save the buffer to history

                // 3. Calculate totals for the summary record from the newly saved state
                const result = calculatePayrollFromState(emp, currentState);
                totalLAK += result.lak;
                totalUSD += result.usd;
                if(result.lak > 0 || result.usd > 0) count++;
                
                // 4. Save the updated history back to the employee document
                updatePromises.push(setDoc(docRef, { 
                    payrollHistory: historyUpdate, 
                    savedPayroll: currentState, // Maintain saved buffer consistency
                    lastModified: new Date().toISOString() 
                }, { merge: true }));
            });
            
            alert(`Starting bulk save for ${employees.length} employees...`);
            try {
                await Promise.all(updatePromises);
                
                // 5. Create the summary record in the history collection
                const record = { 
                    dateId: periodKey, year: editorYear, month: editorMonth, 
                    totalLAK, 
                    totalUSD, 
                    employeeCount: count,
                    timestamp: new Date().toISOString() 
                };
                await setDoc(getDocRef('neerada_payroll_history', periodKey), record);

                alert(`Successfully saved payroll data for all employees for ${editorMonth} ${editorYear}.`);
            } catch (error) {
                console.error("Bulk save failed:", error);
                alert("Bulk payroll save failed. Check console for details.");
            }
        };

        window.resetAllEmployeePayrollData = async () => {
            if (!db || !userId) { alert("System not ready."); return; }
            if (!confirm(`WARNING: Are you sure you want to reset the *unsaved buffer data* for ALL ${employees.length} employees to zero for the period ${editorMonth} ${editorYear}? This action only affects the buffer, not saved history.`)) return;
            
            const updatePromises = employees.map(emp => {
                const docRef = getDocRef('neerada_payroll_employees', emp.id);
                const initialState = createInitialState(emp.department);
                
                return setDoc(docRef, { 
                    savedPayroll: initialState,
                    lastModified: new Date().toISOString() 
                }, { merge: true });
            });

            alert(`Starting bulk reset for ${employees.length} employees...`);
            try {
                await Promise.all(updatePromises);
                alert("Successfully reset payroll data buffer for all employees.");
                // If the currently selected employee was reset, reload the editor
                if (selectedEmployee) window.handleSelect(selectedEmployee.id);
            } catch (error) {
                console.error("Bulk reset failed:", error);
                alert("Bulk payroll reset failed. Check console for details.");
            }
        };

        // --- UPDATED SAVE HISTORY (Dashboard) (FIREBASE) ---
        window.savePayrollHistory = async (e) => {
            e.preventDefault();
            if (!db || !userId) { alert("System not ready."); return; }
            
            const year = document.getElementById('save-year').value;
            const month = document.getElementById('save-month').value;
            const dateId = `${year}-${month}`;
            
            let totalLAK = 0;
            let totalUSD = 0;
            let count = 0;

            const updatePromises = employees.map(async (emp) => {
                const docRef = getDocRef('neerada_payroll_employees', emp.id);
                // 1. Get the current saved buffer state (which is automatically loaded via onSnapshot)
                const currentState = emp.savedPayroll || createInitialState(emp.department);
                
                // 2. Prepare the history update object
                const historyUpdate = emp.payrollHistory || {};
                historyUpdate[dateId] = currentState; // Save the buffer to history

                // 3. Calculate totals for the summary record from the newly saved state
                const result = calculatePayrollFromState(emp, currentState);
                totalLAK += result.lak;
                totalUSD += result.usd;
                if(result.lak > 0 || result.usd > 0) count++;
                
                // 4. Save the updated history back to the employee document
                return setDoc(docRef, { payrollHistory: historyUpdate, lastModified: new Date().toISOString() }, { merge: true });
            });

            document.getElementById('save-modal').classList.add('hidden');
            alert(`Processing monthly payroll for ${month} ${year}. Please wait...`);

            try {
                await Promise.all(updatePromises);

                // 5. Create the summary record in the history collection
                const record = { 
                    dateId, year, month, 
                    totalLAK, 
                    totalUSD, 
                    employeeCount: count,
                    timestamp: new Date().toISOString() 
                };
                
                // Check if record exists (by dateId) and use setDoc for idempotency
                await setDoc(getDocRef('neerada_payroll_history', dateId), record);
                
                alert(`Monthly Payroll Run successfully saved for ${month} ${year}.\n${count} employee records processed.`); 
                updateDashboardStats(); // Will be triggered by onSnapshot anyway, but calling ensures local array is consistent.
            } catch (error) {
                console.error("Error saving payroll history:", error);
                alert("Failed to save monthly run. Check console for details.");
            } finally {
                window.closeSaveHistoryModal();
            }
        };

        function renderEditor() {
            const container = document.getElementById('editor-content');
            if (selectedEmployee.department === 'English') renderEnglishEditor(container);
            else renderDynamicEditor(container);
            renderPreview();
        }

        function renderDynamicEditor(container) {
            const dept = selectedEmployee.department;
            const config = departmentConfigs[dept] || { earnings: [], deductions: [] };
            
            let earnHtml = config.earnings.map(f => {
                const isBasic = f === LAO_FIELDS.basic;
                const isStart = f === LAO_FIELDS.start;
                const highlightClass = isBasic ? 'field-highlight-1' : (isStart ? 'field-highlight-2' : '');
                const readonly = (isBasic || isStart) ? 'readonly' : '';
                
                return `<div class="${highlightClass}">
                            <label class="block text-xs font-bold text-gray-500 mb-1 truncate" title="${f}">${f}</label>
                            <input type="number" ${readonly} data-field-name="${f}" class="w-full text-sm border rounded p-2" value="${currentPayrollState[f] || 0}" oninput="window.updatePayrollField('${f}', this.value)">
                        </div>`;
            }).join('');

            let dedHtml = config.deductions.map(f => `<div><label class="block text-xs font-bold text-gray-500 mb-1 truncate" title="${f}">${f}</label><input type="number" class="w-full text-sm border rounded p-2 text-red-700" value="${currentPayrollState[f] || 0}" oninput="window.updatePayrollField('${f}', this.value)"></div>`).join('');
            
            container.innerHTML = `<div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-4"><h3 class="font-bold text-gray-700 border-b pb-2 text-sm">Earnings (LAK)</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4 max-h-60 overflow-y-auto pr-2">${earnHtml || '<p class="text-xs text-gray-400">No earnings configured.</p>'}</div></div><div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-4 mt-4"><h3 class="font-bold text-red-700 border-b pb-2 text-sm">Deductions (LAK)</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-x-4 gap-y-4 max-h-40 overflow-y-auto pr-2">${dedHtml || '<p class="text-xs text-gray-400">No deductions configured.</p>'}</div></div>`;
        }

        function renderEnglishEditor(container) {
            const d = currentPayrollState;
            container.innerHTML = `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 space-y-2 text-xs">
                    <div class="flex justify-between items-center border-b pb-2"><h3 class="font-bold text-blue-700">Settings</h3><div class="flex gap-2"><div><label class="block text-[9px] font-bold mb-1">Rate</label><input type="number" value="${d.exchangeRate||6000}" oninput="window.updatePayrollField('exchangeRate', this.value)" class="w-16 border rounded text-right p-1"></div><div><label class="block text-[9px] font-bold mb-1">CashOut ($)</label><input type="number" value="${d.cashOut||0}" oninput="window.updatePayrollField('cashOut', this.value)" class="w-12 border rounded text-right p-1"></div></div></div>
                    <h3 class="font-bold text-gray-600 mt-2 mb-2">EARNINGS (USD)</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Basic Pay</label><input type="number" class="w-full border rounded p-1" value="${d.basicPay||0}" oninput="window.updatePayrollField('basicPay', this.value)"></div><div><label class="block font-bold mb-1">Accumulated</label><input type="number" class="w-full border rounded p-1" value="${d.accumulated||0}" oninput="window.updatePayrollField('accumulated', this.value)"></div><div><label class="block font-bold mb-1">Increase</label><input type="number" class="w-full border rounded p-1" value="${d.increase||0}" oninput="window.updatePayrollField('increase', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.earningsOthersUSD||0}" oninput="window.updatePayrollField('earningsOthersUSD', this.value)"></div></div>
                    <h3 class="font-bold text-gray-600 mt-4 mb-2">OVERTIME (USD)</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Total Hours</label><input type="number" class="w-full border rounded p-1" value="${d.otHours||0}" oninput="window.updatePayrollField('otHours', this.value)"></div><div><label class="block font-bold mb-1">Rate/Hr</label><input type="number" class="w-full border rounded p-1" value="${d.otRate||0}" oninput="window.updatePayrollField('otRate', this.value)"></div></div>
                    <h3 class="font-bold text-purple-700 mt-4 mb-2">EXTRA WORK (LAK)</h3><div class="grid grid-cols-3 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">IT</label><input type="number" class="w-full border rounded p-1" value="${d.itLAK||0}" oninput="window.updatePayrollField('itLAK', this.value)"></div><div><label class="block font-bold mb-1">Others</label><input type="number" class="w-full border rounded p-1" value="${d.extraWorkOthersLAK||0}" oninput="window.updatePayrollField('extraWorkOthersLAK', this.value)"></div><div><label class="block font-bold mb-1">Stipend</label><input type="number" class="w-full border rounded p-1" value="${d.stipendLAK||0}" oninput="window.updatePayrollField('stipendLAK', this.value)"></div></div>
                </div>
                <div class="bg-white p-4 rounded-xl shadow-sm border border-gray-200 mt-4 space-y-2 text-xs"><h3 class="font-bold text-red-700 border-b pb-2 mb-2">DEDUCTIONS</h3><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Prof. Tax ($)</label><input type="number" class="w-full border rounded p-1" value="${d.profTax||0}" oninput="window.updatePayrollField('profTax', this.value)"></div><div><label class="block font-bold mb-1">Absences ($)</label><input type="number" class="w-full border rounded p-1" value="${d.absences||0}" oninput="window.updatePayrollField('absences', this.value)"></div><div><div><label class="block font-bold mb-1">Visa ($)</label><input type="number" class="w-full border rounded p-1" value="${d.visa||0}" oninput="window.updatePayrollField('visa', this.value)"></div><div><label class="block font-bold mb-1">Others ($)</label><input type="number" class="w-full border rounded p-1" value="${d.deductionsOthersUSD||0}" oninput="window.updatePayrollField('deductionsOthersUSD', this.value)"></div></div><h4 class="font-bold text-red-500 mt-4 mb-2 text-[10px]">LAK DEDUCTIONS</h4><div class="grid grid-cols-2 gap-x-4 gap-y-2"><div><label class="block font-bold mb-1">Insurance (LAK)</label><input type="number" class="w-full border rounded p-1" value="${d.insuranceLAK||0}" oninput="window.updatePayrollField('insuranceLAK', this.value)"></div><div><label class="block font-bold mb-1">Others (LAK)</label><input type="number" class="w-full border rounded p-1" value="${d.deductionsOthersLAK||0}" oninput="window.updatePayrollField('deductionsOthersLAK', this.value)"></div></div></div>
                <div class="mt-4"><label class="block text-xs font-bold text-gray-500 mb-1">Notes</label><textarea class="w-full border rounded p-2 text-xs" rows="2" oninput="window.updatePayrollField('notes', this.value)">${d.notes || ''}</textarea></div>`;
        }
        
        function calculateLaoFormulas() { 
            const valResearch = parseFloat(currentPayrollState[LAO_FIELDS.research] || 0); 
            const valMedia = parseFloat(currentPayrollState[LAO_FIELDS.media] || 0); 
            const valBehaviorBasic = parseFloat(currentPayrollState[LAO_FIELDS.behaviorBasic] || 0); 
            const valClassResp = parseFloat(currentPayrollState[LAO_FIELDS.classResp] || 0); 
            const valPolicy = parseFloat(currentPayrollState[LAO_FIELDS.policy] || 0); 
            const basicSum = valResearch + valMedia + valBehaviorBasic + valClassResp + valPolicy; 
            currentPayrollState[LAO_FIELDS.basic] = basicSum; 
            const valCert = parseFloat(currentPayrollState[LAO_FIELDS.cert] || 0); 
            const valHomeroom = parseFloat(currentPayrollState[LAO_FIELDS.homeroom] || 0); 
            const valBehaviorStart = parseFloat(currentPayrollState[LAO_FIELDS.behaviorStart] || 0); 
            const startSum = basicSum + valCert + valHomeroom + valBehaviorStart; 
            currentPayrollState[LAO_FIELDS.start] = startSum; 
        }
        
        // --- UPDATED: updatePayrollField to use Firestore savedPayroll buffer ---
        window.updatePayrollField = async (f, v) => { 
            currentPayrollState[f] = v; 
            
            // --- LAO DEPARTMENT SYNCHRONIZATION AND CALCULATIONS ---
            const syncDepts = ['Kindergarten', 'Primary', 'Secondary'];
            const syncFields = [LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy];
            
            if (syncDepts.includes(selectedEmployee.department)) {
                calculateLaoFormulas(); 
                
                // Update UI for the calculated fields instantly
                const basicInput = document.querySelector(`input[data-field-name="${LAO_FIELDS.basic}"]`); 
                const startInput = document.querySelector(`input[data-field-name="${LAO_FIELDS.start}"]`); 
                if(basicInput) basicInput.value = currentPayrollState[LAO_FIELDS.basic]; 
                if(startInput) startInput.value = currentPayrollState[LAO_FIELDS.start]; 
            }

            // --- ENGLISH DEPARTMENT SYNCHRONIZATION (Exchange Rate/Tax) ---
            if (selectedEmployee.department === 'English' && ['exchangeRate', 'profTax'].includes(f)) {
                 const updates = employees
                    .filter(emp => emp.department === 'English')
                    .map(emp => {
                        const empRef = getDocRef('neerada_payroll_employees', emp.id);
                        const savedPayroll = emp.savedPayroll || createInitialState('English');
                        const historyUpdate = emp.payrollHistory || {};

                        // Update current buffer for the global field
                        savedPayroll[f] = v;
                        
                        // Update history for current month if it exists
                        const periodKey = `${editorYear}-${editorMonth}`;
                        if (historyUpdate[periodKey]) historyUpdate[periodKey][f] = v;
                        
                        // Save the updated buffer and history back to Firestore
                        return setDoc(empRef, { savedPayroll: savedPayroll, payrollHistory: historyUpdate, lastModified: new Date().toISOString() }, { merge: true });
                    });
                
                // Do not await here, let it run in the background
                Promise.all(updates).catch(e => console.error("Error updating English bulk field:", e));
            }


            // 4. Save current state to selected employee's buffer immediately
            // This is the source of truth for the active session across page loads/reloads
            selectedEmployee.savedPayroll = JSON.parse(JSON.stringify(currentPayrollState));
            
            // Since we rely on onSnapshot to keep the `employees` array updated, we only need to manually trigger a save for the current employee's buffer.
            const empRef = getDocRef('neerada_payroll_employees', selectedEmployee.id);
            try {
                await setDoc(empRef, { savedPayroll: selectedEmployee.savedPayroll, lastModified: new Date().toISOString() }, { merge: true });
            } catch (error) {
                console.error("Background save to buffer failed:", error);
            }

            renderPreview(); 
        };

        // --- GENERAL APP FUNCTIONS (FIREBASE) ---
        window.openSettings = () => document.getElementById('settings-modal').classList.remove('hidden'); 
        window.closeSettings = () => document.getElementById('settings-modal').classList.add('hidden'); 
        window.setTheme = async (theme, saveToDb = true) => { 
            document.body.className = `bg-gray-100 font-sans text-gray-900 h-screen flex flex-col overflow-hidden theme-${theme}`; 
            
            if (saveToDb && userId) {
                 try {
                     const settingsRef = getDocRef('neerada_settings', 'app_settings');
                     await setDoc(settingsRef, { theme: theme }, { merge: true });
                 } catch (error) {
                     console.error("Failed to save theme setting:", error);
                 }
            }
        };
        window.handleLogoUpload = async (input) => { 
            const file = input.files[0]; 
            if (!file) return; 
            const reader = new FileReader(); 
            reader.onload = async function(e) { 
                if (!userId) { alert("Authentication not ready. Cannot save logo."); return; }
                const base64 = e.target.result; 
                
                try {
                    const settingsRef = getDocRef('neerada_settings', 'app_settings');
                    await setDoc(settingsRef, { logo: base64 }, { merge: true });
                    alert("Logo saved to Firebase successfully!"); 
                } catch (error) {
                    console.error("Error saving logo:", error);
                    alert("Failed to save logo. Max size exceeded or network error.");
                }
            }; 
            reader.readAsDataURL(file); 
        };
        window.exportData = () => { 
            const data = { 
                employees, 
                history, 
                departmentConfigs, 
                theme: settings.theme || 'default', 
                logo: localStorage.getItem('neerada_school_logo') || null,
                version: '3.6' 
            }; 
            const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data)); 
            const link = document.createElement('a'); 
            link.setAttribute("href", dataStr); 
            link.setAttribute("download", `neerada_backup_${new Date().toISOString().slice(0,10)}.json`); 
            document.body.appendChild(link); link.click(); document.body.removeChild(link); 
        };
        window.importData = (input) => { 
            const file = input.files[0]; 
            if(!file) return; 
            
            if(!confirm("WARNING: Importing data will OVERWRITE all existing payroll data, history, and settings in your database. Continue?")) {
                input.value = '';
                return;
            }

            const reader = new FileReader(); 
            reader.onload = async (e) => { 
                if (!db || !userId) { alert("System not ready. Import failed."); input.value = ''; return; }
                try { 
                    const data = JSON.parse(e.target.result); 
                    const batchUpdates = [];

                    // 1. Employees (Delete existing, set new)
                    // Note: Firestore security rules usually prevent mass deletion. We'll stick to replacing/merging for simplicity.
                    if(data.employees && Array.isArray(data.employees)) {
                        for (const emp of data.employees) {
                            const empRef = getDocRef('neerada_payroll_employees', emp.id || Date.now().toString(36) + Math.random().toString(36).substr(2, 5).toUpperCase());
                            batchUpdates.push(setDoc(empRef, emp));
                        }
                    }

                    // 2. History Summary
                    if(data.history && Array.isArray(data.history)) {
                         for (const rec of data.history) {
                            const recRef = getDocRef('neerada_payroll_history', rec.dateId);
                            batchUpdates.push(setDoc(recRef, rec));
                        }
                    }

                    // 3. Configs & Settings
                    if(data.departmentConfigs) {
                        const configRef = getDocRef('neerada_settings', 'department_configs');
                        batchUpdates.push(setDoc(configRef, { configs: data.departmentConfigs }, { merge: true }));
                    }
                    if(data.theme || data.logo) {
                        const settingsRef = getDocRef('neerada_settings', 'app_settings');
                        const settingsUpdate = {};
                        if (data.theme) settingsUpdate.theme = data.theme;
                        if (data.logo) settingsUpdate.logo = data.logo;
                        batchUpdates.push(setDoc(settingsRef, settingsUpdate, { merge: true }));
                    }
                    
                    await Promise.all(batchUpdates);
                    alert("Data import successful! The data will now synchronize from the database."); 
                } catch (err) { 
                    console.error("Error importing data:", err); 
                    alert("Error importing data: " + err.message); 
                } finally {
                    input.value = '';
                }
            }; 
            reader.readAsText(file); 
        };
        window.saveEmployeePayrollData = async () => { 
            if(!selectedEmployee) return; 
            if (!db || !userId) { alert("System not ready. Save failed."); return; }
            
            const periodKey = `${editorYear}-${editorMonth}`; 
            
            // 1. Update the employee's history for the current period (from currentPayrollState buffer)
            const historyUpdate = selectedEmployee.payrollHistory || {};
            historyUpdate[periodKey] = currentPayrollState;
            
            // 2. Update the employee's saved payroll buffer (for copying next month)
            const savedPayrollUpdate = JSON.parse(JSON.stringify(currentPayrollState));
            
            // 3. Save to Firestore
            const empRef = getDocRef('neerada_payroll_employees', selectedEmployee.id);
            try {
                await setDoc(empRef, { 
                    payrollHistory: historyUpdate, 
                    savedPayroll: savedPayrollUpdate,
                    lastModified: new Date().toISOString() 
                }, { merge: true });
                
                alert(`Payroll saved for ${selectedEmployee.name} for ${editorMonth} ${editorYear}.`); 
            } catch (error) {
                console.error("Error saving individual payroll data:", error);
                alert("Failed to save payroll data. Check console for details.");
            }
        };
        
        // --- PRINT FUNCTIONS (NEW) ---
        window.openPrintSettings = () => {
            if(!selectedEmployee) return;
            document.getElementById('print-modal').classList.remove('hidden');
            document.getElementById('print-modal').classList.add('flex');
        };
        window.closePrintSettings = () => {
            document.getElementById('print-modal').classList.add('hidden');
            document.getElementById('print-modal').classList.remove('flex');
        };
        window.executePrint = () => {
            const orientation = document.querySelector('input[name="print-orient"]:checked').value;
            const scale = parseFloat(document.getElementById('print-scale').value) / 100;
            
            const styleId = 'print-dynamic-style';
            let styleEl = document.getElementById(styleId);
            if (!styleEl) { styleEl = document.createElement('style'); styleEl.id = styleId; document.head.appendChild(styleEl); }
            
            styleEl.innerHTML = `
                @media print { 
                    @page { size: A4 ${orientation}; margin: 5mm; } 
                    #preview-pane { 
                        transform: scale(${scale}) !important; 
                        width: calc(100% / ${scale}) !important;
                    }
                }
            `;
            
            window.closePrintSettings();
            setTimeout(() => {
                window.print();
            }, 100);
        };

        // --- EMAIL FUNCTION ---
        window.sendEmail = () => {
            if (!selectedEmployee) return;
            const subject = `Payslip - ${editorMonth} ${editorYear} - ${selectedEmployee.name}`;
            const body = generateEmailText();
            const encodedBody = encodeURIComponent(body);
            window.location.href = `mailto:${selectedEmployee.email}?subject=${encodeURIComponent(subject)}&body=${encodedBody}`;
        };

        function generateEmailText() {
            if (!selectedEmployee) return "";
            const d = currentPayrollState;
            const isEnglish = selectedEmployee.department === 'English';
            const period = `${editorMonth} ${editorYear}`;
            
            const PAD_L = 30; // Label width
            const PAD_R = 15; // Value width
            
            const formatLine = (label, value) => {
                return `${label.padEnd(PAD_L)} : ${value.padStart(PAD_R)}`;
            };
            
            const formatHeader = (text) => {
                return `\n${"=".repeat(50)}\n  ${text.toUpperCase()}\n${"=".repeat(50)}`;
            };

            const formatBold = (label, value) => {
                return `\n*** ${label.toUpperCase().padEnd(PAD_L - 4)} : ${value.padStart(PAD_R)} ***`;
            };

            const baseId = generateEmployeeId(selectedEmployee.department, selectedEmployee.name, selectedEmployee.campus);
            const monthIndex = MONTHS.indexOf(editorMonth) + 1;
            const formattedMonth = monthIndex < 10 ? '0' + monthIndex : monthIndex;
            const fullId = `${baseId}-${formattedMonth}-${editorYear}`;

            let msg = `NEERADA SCHOOL PAYSLIP\n`;
            msg += `Period: ${period}\n\n`;
            
            msg += `EMPLOYEE DETAILS\n`;
            msg += `--------------------------------------------------\n`;
            msg += `NAME    :  ${selectedEmployee.name.toUpperCase()}\n`; 
            msg += `ID      :  ${fullId}\n`;
            msg += `POSITION:  ${selectedEmployee.position}\n`;
            msg += `DEPT    :  ${selectedEmployee.department}\n`;
            msg += `CAMPUS  :  ${selectedEmployee.campus}\n`;
            msg += `--------------------------------------------------\n`;

            if (isEnglish) {
                 const otPayment = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0);
                 const earnSum = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0);
                 const grossUSD = earnSum + otPayment;
                 const dedUSDSum = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0);
                 const netUSD = grossUSD - dedUSDSum;
                 const convertible = netUSD - (parseFloat(d.cashOut)||0);
                 const convertedLAK = convertible * (parseFloat(d.exchangeRate)||0);
                 const extraLAK = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0);
                 const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0);
                 const finalLAK = convertedLAK + extraLAK - dedLAK;

                 msg += formatHeader("EARNINGS (USD)");
                 msg += `\n` + formatLine("Basic Pay", `$${parseFloat(d.basicPay||0).toFixed(2)}`);
                 msg += `\n` + formatLine("Accumulated", `$${parseFloat(d.accumulated||0).toFixed(2)}`);
                 msg += `\n` + formatLine("Increase", `$${parseFloat(d.increase||0).toFixed(2)}`);
                 msg += `\n` + formatLine("Others", `$${parseFloat(d.earningsOthersUSD||0).toFixed(2)}`);
                 msg += `\n` + formatLine(`Overtime (${d.otHours}hrs @ $${d.otRate})`, `$${otPayment.toFixed(2)}`);
                 msg += formatBold("GROSS USD", `$${grossUSD.toFixed(2)}`);

                 msg += formatHeader("DEDUCTIONS (USD)");
                 msg += `\n` + formatLine("Prof. Tax", `$${parseFloat(d.profTax||0).toFixed(2)}`);
                 msg += `\n` + formatLine("Absences", `$${parseFloat(d.absences||0).toFixed(2)}`);
                 msg += `\n` + formatLine("Visa", `$${parseFloat(d.visa||0).toFixed(2)}`);
                 msg += `\n` + formatLine("Others", `$${parseFloat(d.deductionsOthersUSD||0).toFixed(2)}`);
                 msg += formatBold("TOTAL DED (USD)", `$${dedUSDSum.toFixed(2)}`);

                 msg += formatHeader("NET PAY");
                 msg += formatBold("NET USD", `$${netUSD.toFixed(2)}`);
                 
                 msg += `\n\n--------------------------------------------------\n`;
                 msg += `CALCULATION DETAILS:\n`;
                 msg += formatLine("Cash Out", `$${parseFloat(d.cashOut||0).toFixed(2)}`);
                 msg += `\n` + formatLine(`Convertible @ ${d.exchangeRate}`, `$${convertible.toFixed(2)}`);
                 msg += `\n` + formatLine("Converted LAK", formatMoney(convertedLAK));
                 msg += `\n` + formatLine("Extra Work (LAK)", formatMoney(extraLAK));
                 msg += `\n` + formatLine("LAK Deductions", `(${formatMoney(dedLAK)})`);
                 msg += `\n--------------------------------------------------`;
                 msg += formatBold("FINAL PAY (LAK)", formatMoney(finalLAK));

            } else {
                const config = departmentConfigs[selectedEmployee.department] || { earnings: [], deductions: [] };
                let tEarn = 0, tDed = 0;
                
                msg += formatHeader("EARNINGS (LAK)");
                config.earnings.forEach(f => { 
                    const v = parseFloat(d[f] || 0); 
                    const isExcluded = (f === LAO_FIELDS.basic || f === LAO_FIELDS.start);
                    
                    if (v > 0) {
                        msg += `\n` + formatLine(f, formatMoney(v));
                        if(!isExcluded) tEarn += v; 
                    }
                });
                msg += formatBold("TOTAL EARNINGS", formatMoney(tEarn));

                msg += formatHeader("DEDUCTIONS (LAK)");
                config.deductions.forEach(f => { 
                    const v = parseFloat(d[f] || 0); 
                    if(v > 0) {
                        tDed += v; 
                        msg += `\n` + formatLine(f, formatMoney(v));
                    }
                });
                msg += formatBold("TOTAL DEDUCTIONS", formatMoney(tDed));
                
                msg += `\n` + "-".repeat(50);
                msg += formatBold("NET PAY (LAK)", formatMoney(tEarn - tDed));
            }
            
            if (d.notes) {
                msg += `\n\nNOTES:\n${d.notes}\n`;
            }
            
            return msg;
        }

        // --- WHATSAPP FUNCTIONS (UPDATED) ---
        window.sendWhatsApp = () => {
            if (!selectedEmployee) return;
            let phone = selectedEmployee.whatsapp;
            
            if (!phone) {
                alert("This employee has no WhatsApp number.");
                return;
            }
            
            phone = phone.replace(/[^0-9]/g, '');
            if (phone.startsWith("020")) phone = "85620" + phone.substring(3);
            else if (phone.startsWith("20")) phone = "85620" + phone.substring(2);
            else if (!phone.startsWith("856")) phone = "856" + phone;
            
            let text = generatePayslipText();
            
            const year = new Date().getFullYear();
            text += `\n\nComputer Generated message.\n© ${year} Neerada School Payroll System`;
            
            const url = `https://wa.me/${phone}?text=${encodeURIComponent(text)}`;
            
            const newWindow = window.open(url, '_blank');
            
            if (newWindow) {
                 newWindow.focus();
            } else {
                alert("Please check your browser settings: the pop-up for WhatsApp may have been blocked.");
            }
        };

        // --- WHATSAPP PAYSLIP TEXT GENERATOR ---
        function generatePayslipText() {
            if (!selectedEmployee) return "";
            const d = currentPayrollState;
            const isEnglish = selectedEmployee.department === 'English';
            const period = `${editorMonth} ${editorYear}`;

            let text = `*NEERADA SCHOOL PAYSLIP*\n`;
            text += `Period: ${period}\n`;
            text += `Employee: *${selectedEmployee.name}*\n`;

            const fUSD = (n) => `$${parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`;
            const fLAK = (n) => formatMoney(n);
            const formatSection = (title) => `\n*--- ${title.toUpperCase()} ---*`;
            const formatItem = (label, value) => `• ${label}: ${value}`;

            if (isEnglish) {
                 const otPayment = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0);
                 const earnSum = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0);
                 const grossUSD = earnSum + otPayment;
                 const dedUSDSum = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0);
                 const netUSD = grossUSD - dedUSDSum;
                 const convertible = netUSD - (parseFloat(d.cashOut)||0);
                 const convertedLAK = convertible * (parseFloat(d.exchangeRate)||0);
                 const extraLAK = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0);
                 const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0);
                 const finalLAK = convertedLAK + extraLAK - dedLAK;

                 text += formatSection("Earnings (USD)");
                 text += `\n${formatItem('Basic Pay', fUSD(d.basicPay))}`;
                 text += `\n${formatItem('Increase', fUSD(d.increase))}`;
                 text += `\n${formatItem('Overtime', fUSD(otPayment))}`;
                 text += `\n*Gross Pay (USD): ${fUSD(grossUSD)}*`;

                 text += formatSection("Deductions (USD)");
                 text += `\n${formatItem('Prof. Tax', fUSD(d.profTax))}`;
                 text += `\n${formatItem('Absences', fUSD(d.absences))}`;
                 text += `\n${formatItem('Visa', fUSD(d.visa))}`;
                 text += `\n*Total Ded (USD): ${fUSD(dedUSDSum)}*`;

                 text += formatSection("Summary");
                 text += `\n${formatItem('Net USD', fUSD(netUSD))}`;
                 text += `\n${formatItem('Cash Out', fUSD(d.cashOut))}`;
                 text += `\n${formatItem(`Converted LAK (@ ${d.exchangeRate})`, fLAK(convertedLAK))}`;
                 text += `\n${formatItem('Extra Work LAK', fLAK(extraLAK))}`;
                 text += `\n${formatItem('LAK Deductions', fLAK(dedLAK))}`;
                 text += `\n\n*FINAL LAK PAY: ${fLAK(finalLAK)}*`;

            } else {
                const config = departmentConfigs[selectedEmployee.department] || { earnings: [], deductions: [] };
                let tEarn = 0, tDed = 0;
                
                text += formatSection("Earnings (LAK)");
                config.earnings.forEach(f => { 
                    const v = parseFloat(d[f] || 0); 
                    const isExcluded = (f === LAO_FIELDS.basic || f === LAO_FIELDS.start);
                    if (v > 0 && !isExcluded) {
                        text += `\n${formatItem(f, fLAK(v))}`;
                        tEarn += v;
                    }
                });
                text += `\n*Total Earnings: ${fLAK(tEarn)}*`;

                text += formatSection("Deductions (LAK)");
                config.deductions.forEach(f => { 
                    const v = parseFloat(d[f] || 0); 
                    if(v > 0) {
                        text += `\n${formatItem(f, fLAK(v))}`;
                        tDed += v;
                    }
                });
                text += `\n*Total Deductions: ${fLAK(tDed)}*`;

                text += `\n\n*NET PAY (LAK): ${fLAK(tEarn - tDed)}*`;
            }

            if (d.notes) {
                text += formatSection("Notes");
                text += `\n${d.notes}`;
            }

            return text;
        }

        // --- PREVIEW RENDERING ---
        function renderPreview() { 
            if(!selectedEmployee) return; 
            document.getElementById('prev-name').innerText = selectedEmployee.name; 
            document.getElementById('prev-pos').innerText = selectedEmployee.position; 
            document.getElementById('prev-dept').innerText = selectedEmployee.department; 
            const monthIndex = MONTHS.indexOf(editorMonth) + 1; 
            const formattedMonth = monthIndex < 10 ? '0' + monthIndex : monthIndex; 
            const baseId = generateEmployeeId(selectedEmployee.department, selectedEmployee.name, selectedEmployee.campus); 
            document.getElementById('prev-id').innerText = `${baseId}-${formattedMonth}-${editorYear}`; 
            document.getElementById('prev-email').innerText = selectedEmployee.email; 
            document.getElementById('prev-whatsapp').innerText = selectedEmployee.whatsapp || '---'; 
            document.getElementById('prev-campus').innerText = selectedEmployee.campus + " Campus"; 
            document.getElementById('prev-date').innerText = getSmartPaymentDate(editorMonth, editorYear); 
            const savedLogo = localStorage.getItem('neerada_school_logo'); 
            const logoEl = document.getElementById('prev-school-logo'); 
            if (savedLogo) { logoEl.src = savedLogo; logoEl.classList.remove('hidden'); } else { logoEl.classList.add('hidden'); } 
            const picEl = document.getElementById('prev-profile-pic'); 
            if (selectedEmployee.profilePic) { picEl.src = selectedEmployee.profilePic; picEl.classList.remove('hidden'); } else { picEl.classList.add('hidden'); } 
            const container = document.getElementById('preview-content'); 
            if (selectedEmployee.department === 'English') renderEnglishPreview(container); 
            else renderDynamicPreview(container); 
        }
        function renderDynamicPreview(container) { 
            const config = departmentConfigs[selectedEmployee.department] || { earnings: [], deductions: [] }; 
            let totalEarn = 0, totalDed = 0; 
            let earnHtml = config.earnings.map(f => { 
                const v = parseFloat(currentPayrollState[f] || 0); 
                const isExcluded = (f === LAO_FIELDS.basic || f === LAO_FIELDS.start); 
                const isAccumulated = f === LAO_FIELDS.accumulated; 
                const isIncrease = f === LAO_FIELDS.increase; 
                if (!isExcluded) totalEarn += v; 
                if (v > 0) { 
                    if (isExcluded) { 
                        let highlightClass = f === LAO_FIELDS.basic ? 'print-highlight-1 bg-green-50 text-green-800' : 'print-highlight-2 bg-orange-50 text-orange-800'; 
                        return `<div class="flex justify-between py-1.5 px-2 rounded mb-1 font-bold ${highlightClass}"><span class="truncate pr-2">${f}</span><span class="font-mono whitespace-nowrap">${formatMoney(v)}</span></div>`; 
                    } else if (isAccumulated || isIncrease) { 
                        return `<div class="flex justify-between py-1.5 px-2 rounded mb-1 print-highlight-special"><span class="truncate pr-2">${f}</span><span class="font-mono whitespace-nowrap">${formatMoney(v)}</span></div>`; 
                    } else { 
                        return `<div class="flex justify-between py-1 border-b border-gray-100 text-xs"><span class="text-gray-600 truncate pr-2">${f}</span><span class="font-mono text-gray-900 whitespace-nowrap">${formatMoney(v)}</span></div>`; 
                    } 
                } 
                return ''; 
            }).join(''); 
            let dedHtml = config.deductions.map(f => { 
                const v = parseFloat(currentPayrollState[f] || 0); 
                totalDed += v; 
                return v > 0 ? `<div class="flex justify-between py-1 border-b border-gray-100 text-xs"><span class="text-gray-600 truncate pr-2">${f}</span><span class="font-mono text-red-600 whitespace-nowrap">(${formatMoney(v)})</span></div>` : ''; 
            }).join(''); 
            const net = totalEarn - totalDed; 
            container.innerHTML = `<div class="flex flex-col gap-6 mb-6"><div><h3 class="font-bold text-green-700 border-b border-green-200 mb-2 pb-1">Earnings (LAK)</h3>${earnHtml}<div class="flex justify-between mt-2 pt-2 border-t print-highlight-total text-green-900"><span>Total Earnings (Calculated)</span><span>${formatMoney(totalEarn)}</span></div></div><div><h3 class="font-bold text-red-700 border-b border-red-200 mb-2 pb-1">Deductions (LAK)</h3>${dedHtml}<div class="flex justify-between mt-2 pt-2 border-t font-bold text-red-800"><span>Total Deductions</span><span>(${formatMoney(totalDed)})</span></div></div></div><div class="bg-blue-900 text-white p-4 rounded flex justify-between items-center mt-8"><span class="font-bold uppercase tracking-wider">Net Pay (LAK)</span><span class="font-bold text-xl font-mono">${formatMoney(net)}</span></div><div class="mt-6 pt-4 border-t border-gray-300 text-[10px] text-gray-600"><p class="font-bold underline mb-1">ໝາຍເຫດ:</p><ol class="list-decimal list-inside space-y-0.5"><li>ການຕອບຮັບຈາກ ຜປຄ ຫາຄູທີ່ສອນ/ຄູປະຈຳຫ້ອງ</li><li>ຄວາມເປັນລະບຽບໃນຫ້ອງທີ່ສອນ: ຄວາມເປັນລະບຽບຂອງໂຕະຕັ່ງ, ຄວາມສະອາດ ແລະ ອື່ນໆ</li><li>ທຸກໆການເຄື່ອນໄຫວໄປປະຊຸມ/ອອກວຽກກິດຈະກຳນອກ ຕ້ອງເຮັດບົດລາຍງານສົ່ງ.</li></ol></div>`; 
        }
        function renderEnglishPreview(container) { 
            const d = currentPayrollState; 
            const otPayment = (parseFloat(d.otHours)||0)*(parseFloat(d.otRate)||0); 
            const earnSum = (parseFloat(d.basicPay)||0)+(parseFloat(d.accumulated)||0)+(parseFloat(d.increase)||0)+(parseFloat(d.earningsOthersUSD)||0); 
            const grossUSD = earnSum + otPayment; 
            const dedUSDSum = (parseFloat(d.profTax)||0)+(parseFloat(d.absences)||0)+(parseFloat(d.visa)||0)+(parseFloat(d.deductionsOthersUSD)||0); 
            const netUSD = grossUSD - dedUSDSum; 
            const convertible = netUSD - (parseFloat(d.cashOut)||0); 
            const convertedLAK = convertible * (parseFloat(d.exchangeRate)||0); 
            const extraLAK = (parseFloat(d.itLAK)||0)+(parseFloat(d.extraWorkOthersLAK)||0)+(parseFloat(d.stipendLAK)||0); 
            const dedLAK = (parseFloat(d.insuranceLAK)||0)+(parseFloat(d.deductionsOthersLAK)||0); 
            const finalLAK = convertedLAK + extraLAK - dedLAK; 
            const fUSD = (n) => `$${parseFloat(n||0).toLocaleString('en-US', {minimumFractionDigits: 2, maximumFractionDigits: 2})}`; 
            const fLAK = (n) => formatMoney(n); 
            const renderRow = (l, v, d, c) => `<div class="flex justify-between py-1 border-b border-gray-100 last:border-0"><span class="text-gray-600">${l}</span><span class="font-mono ${d?'text-red-600':''}">${c==='USD'?fUSD(v):fLAK(v)}</span></div>`; 
            container.innerHTML = `<div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-xs"><div><h4 class="font-bold text-blue-900 border-b-2 border-blue-100 mb-2 pb-1">EARNINGS</h4>${renderRow('Basic Pay ($)', d.basicPay, false, 'USD')}${renderRow('Accumulated ($)', d.accumulated, false, 'USD')}${renderRow('2025-26 Increased ($)', d.increase, false, 'USD')}${renderRow('Others ($)', d.earningsOthersUSD, false, 'USD')}<h4 class="font-bold text-blue-900 border-b-2 border-blue-100 mt-4 mb-2 pb-1">OVERTIME (USD)</h4><div class="flex justify-between py-1 text-gray-500 italic"><span>Total no. of hours</span><span>${d.otHours}</span></div><div class="flex justify-between py-1 text-gray-500 italic"><span>Rate per hour</span><span>$${d.otRate}</span></div>${renderRow('Payment', otPayment, false, 'USD')}<h4 class="font-bold text-purple-900 border-b-2 border-purple-100 mt-4 mb-2 pb-1">EXTRA WORK (LAK)</h4>${renderRow('IT (LAK)', d.itLAK, false, 'LAK')}${renderRow('Others (LAK)', d.extraWorkOthersLAK, false, 'LAK')}${renderRow('STIPEND (4 levels)', d.stipendLAK, false, 'LAK')}<div class="bg-blue-50 p-2 rounded mt-4"><div class="flex justify-between font-bold text-blue-800"><span>Gross Pay ($)</span><span>${fUSD(grossUSD)}</span></div><div class="flex justify-between text-[10px] text-gray-500 mt-1"><span>Rate USD to LAK</span><span>${formatMoney(d.exchangeRate)}</span></div></div></div><div><h4 class="font-bold text-red-900 border-b-2 border-red-100 mb-2 pb-1">DEDUCTIONS</h4>${renderRow('Professional Tax ($)', d.profTax, true, 'USD')}${renderRow('Absences ($)', d.absences, true, 'USD')}${renderRow('Visa ($)', d.visa, true, 'USD')}${renderRow('Others ($)', d.deductionsOthersUSD, true, 'USD')}<div class="flex justify-between font-bold text-red-700 border-t border-red-200 mt-1 pt-1 mb-4"><span>TOTAL DEDUCTIONS ($)</span><span>(${fUSD(dedUSDSum)})</span></div>${renderRow('Insurance (LAK)', d.insuranceLAK, true, 'LAK')}${renderRow('Others (LAK)', d.deductionsOthersLAK, true, 'LAK')}<div class="flex justify-between font-bold text-red-700 border-t border-red-200 mt-1 pt-1"><span>Deductions (LAK)</span><span>(${fLAK(dedLAK)})</span></div></div></div><div class="mt-6 border-t-2 border-gray-800 pt-4 text-xs"><div class="flex justify-between items-center mb-1"><span class="font-bold text-gray-700">Net Pay ($)</span><span class="font-mono font-bold">${fUSD(netUSD)}</span></div><div class="flex justify-between items-center mb-1 text-gray-500"><span>Cash out ${fUSD(d.cashOut)}</span><span>(${fUSD(d.cashOut)})</span></div><div class="flex justify-between items-center mb-1 text-gray-500"><span>$ convertible to LAK</span><span>${fUSD(convertible)}</span></div><div class="bg-blue-900 text-white p-4 rounded flex justify-between items-center mt-3 shadow-lg"><span class="font-bold uppercase tracking-wider text-sm">Salary Pay (LAK)</span><span class="font-bold text-2xl font-mono">${fLAK(finalLAK)}</span></div></div>${d.notes ? `<div class="mt-4 pt-2 border-t border-gray-300 text-[10px]"><p class="font-bold">Notes:</p><p class="whitespace-pre-wrap">${d.notes}</p></div>` : ''}`; 
        }
        function renderHistoryList(data) { 
            const list = document.getElementById('history-list'); 
            list.innerHTML = data && data.length ? data.map(h => `<tr class="border-b border-gray-100"><td class="py-3 px-4 text-sm font-bold text-gray-700">${h.month} ${h.year}</td><td class="py-3 px-4 text-sm">${h.employeeCount} Staff</td><td class="py-3 px-4 text-sm font-mono text-right font-bold">${formatMoney(h.totalLAK)}</td><td class="py-3 px-4 text-sm font-mono text-right font-bold text-green-700">$${(h.totalUSD||0).toFixed(2)}</td><td class="py-3 px-4 text-right"><button onclick="deleteHistory('${h.dateId}')" class="text-red-400 underline text-xs">Del</button></td></tr>`).join('') : `<tr><td colspan="5" class="text-center py-4 text-gray-400">No history found for filter.</td></tr>`; 
        }
        window.deleteHistory = async (id) => { 
            if(confirm("Delete record? This will delete the summary record, but individual employee history for this period will remain.")) { 
                 if (!db || !userId) { alert("System not ready."); return; }
                 try {
                     await deleteDoc(getDocRef('neerada_payroll_history', id));
                     alert("History summary deleted.");
                 } catch (error) {
                     console.error("Error deleting history summary:", error);
                     alert("Failed to delete history summary.");
                 }
            }
        };
        window.openSaveHistoryModal = () => {
            const saveYear = document.getElementById('save-year');
            const saveMonth = document.getElementById('save-month');
            
            saveYear.value = new Date().getFullYear();
            saveMonth.value = MONTHS[new Date().getMonth()];

            document.getElementById('save-modal').classList.remove('hidden'); 
            document.getElementById('save-modal').classList.add('flex');
        }; 
        window.closeSaveHistoryModal = () => document.getElementById('save-modal').classList.add('hidden');
        window.downloadCSVReport = () => { 
            const yearFilter = document.getElementById('filter-year').value; 
            const monthFilter = document.getElementById('filter-month').value; 
            let reportData = []; 
            let grandTotalLAK = 0; 
            let grandTotalUSD = 0; 
            
            employees.forEach(emp => { 
                if (!emp.payrollHistory) return; 
                Object.entries(emp.payrollHistory).forEach(([periodKey, state]) => { 
                    const [pYear, pMonth] = periodKey.split('-'); 
                    if (yearFilter !== 'All' && pYear !== yearFilter) return; 
                    if (monthFilter !== 'All' && pMonth !== monthFilter) return; 
                    const result = calculatePayrollFromState(emp, state); 
                    reportData.push({ 
                        period: `${pMonth} ${pYear}`, 
                        sortPeriod: `${pYear}-${MONTHS.indexOf(pMonth).toString().padStart(2, '0')}`, 
                        id: generateEmployeeId(emp.department, emp.name, emp.campus) + '-' + pMonth.slice(0, 3).toUpperCase() + '-' + pYear,
                        name: emp.name, 
                        campus: emp.campus, 
                        department: emp.department, 
                        position: emp.position, 
                        totalLAK: result.lak, 
                        totalUSD: result.usd 
                    }); 
                    grandTotalLAK += result.lak; 
                    grandTotalUSD += result.usd; 
                }); 
            }); 
            
            if (reportData.length === 0) { alert("No data found for the selected period to export."); return; } 
            reportData.sort((a, b) => { 
                if (a.sortPeriod !== b.sortPeriod) return a.sortPeriod.localeCompare(b.sortPeriod); 
                if (a.campus !== b.campus) return a.campus.localeCompare(b.campus); 
                if (a.department !== b.department) return a.department.localeCompare(b.department); 
                return a.name.localeCompare(b.name); 
            }); 
            let csvRows = []; 
            csvRows.push(["Period", "Employee ID", "Name", "Campus", "Department", "Position", "Total LAK (₭)", "Total USD ($)"]); 
            reportData.forEach(row => { 
                csvRows.push([ 
                    row.period, 
                    row.id, 
                    row.name, 
                    row.campus, 
                    row.department, 
                    row.position, 
                    row.totalLAK, 
                    row.totalUSD 
                ]); 
            }); 
            csvRows.push(["GRAND TOTAL", "", "", "", "", "", grandTotalLAK, grandTotalUSD]); 
            const csvString = csvRows.map(e => e.map(i => `"${String(i).replace(/"/g, '""')}"`).join(",")).join("\n"); 
            const blob = new Blob(["\uFEFF" + csvString], { type: 'text/csv;charset=utf-8;' }); 
            const url = URL.createObjectURL(blob); 
            const link = document.createElement("a"); 
            link.setAttribute("href", url); 
            link.setAttribute("download", `Neerada_Payroll_Report_${yearFilter}_${monthFilter}.csv`); 
            document.body.appendChild(link); link.click(); document.body.removeChild(link); 
        };
        
        // Helper to get only the editable fields (excluding calculated fields)
        function getEditableLaoFields(dept) {
            const config = departmentConfigs[dept];
            if (!config) return [];
            
            const calculatedFields = [LAO_FIELDS.basic, LAO_FIELDS.start];
            
            let fields = [];
            if (config.earnings) {
                fields = fields.concat(config.earnings.filter(f => !calculatedFields.includes(f)));
            }
            if (config.deductions) {
                fields = fields.concat(config.deductions);
            }
            return fields;
        }

        // Function to download Payslip Template CSV
        window.downloadPayslipTemplate = (deptName) => {
            if (deptName === 'English') { alert("English department payroll is complex and should be managed individually or via bulk update of shared fields (Tax/Rate). No specific template provided."); return; }
            const allEditableFields = getEditableLaoFields(deptName);

            if (allEditableFields.length === 0) {
                alert(`The department "${deptName}" has no editable fields configured for payroll data.`);
                return;
            }

            const standardFields = ["Employee Name", "Campus", "Department", "Payroll Month", "Payroll Year"];
            const headers = [...standardFields, ...allEditableFields];
            
            const deptConfig = departmentConfigs[deptName];
            const currentMonth = MONTHS[new Date().getMonth()];
            const currentYear = new Date().getFullYear();
            
            let exampleEmployee = employees.find(e => e.department === deptName && CAMPUSES.includes(e.campus));
            
            let exampleRowValues = standardFields.map(h => {
                if (h === "Employee Name") return exampleEmployee ? exampleEmployee.name : "Example Somchai Vong";
                if (h === "Campus") return exampleEmployee ? exampleEmployee.campus : "Sibounheuang";
                if (h === "Department") return deptName;
                if (h === "Payroll Month") return currentMonth;
                if (h === "Payroll Year") return currentYear;
                return '';
            });
            
            allEditableFields.forEach(f => {
                const isDeduction = deptConfig.deductions && deptConfig.deductions.includes(f);
                exampleRowValues.push(isDeduction ? 100000 : 500000);
            });

            let csvContent = headers.map(h => `"${h.replace(/"/g, '""')}"`).join(',') + '\n';
            csvContent += exampleRowValues.map(v => `"${String(v).replace(/"/g, '""')}"`).join(',') + '\n';
            
            const blob = new Blob(["\uFEFF" + csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.setAttribute('href', url);
            link.setAttribute('download', `payslip_template_${deptName.toLowerCase().replace(/[^a-z]/g, '')}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            alert(`Payslip Data Template for ${deptName} downloaded! It includes all editable LAK fields.`);
        };

        // Function to update multiple employees from a single CSV upload (FIREBASE)
        window.handlePayslipCSV = (input) => {
            const file = input.files[0];
            if (!file) return;
            
            const confirmMessage = "Importing this CSV will overwrite the *saved payroll data (buffer)* and corresponding *history records* for all matched employees in the database. Do you wish to continue?";
            if (!confirm(confirmMessage)) {
                input.value = '';
                return;
            }

            const reader = new FileReader();
            reader.onload = async function(e) {
                if (!db || !userId) { alert("System not ready. Import failed."); input.value = ''; return; }
                const csv = e.target.result;
                const lines = csv.split('\n').filter(line => line.trim() !== '');
                if (lines.length <= 1) { alert("CSV file is empty or missing data rows."); input.value = ''; return; }

                const headers = lines[0].toLowerCase().replace(/\r/g, '').split(',').map(h => h.trim().replace(/[^a-z0-9]/g, ''));
                const originalHeaders = lines[0].split(',').map(h => h.trim().replace('\r', ''));
                
                const requiredHeaders = ['employeename', 'department', 'payrollmonth', 'payrollyear'];
                const missingHeaders = requiredHeaders.filter(h => !headers.includes(h));
                if (missingHeaders.length > 0) { alert(`Missing required CSV headers: ${missingHeaders.join(', ')}. Please use the template.`); input.value = ''; return; }

                let updatedCount = 0;
                let historyUpdated = 0;
                const updatePromises = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = lines[i].split(',').map(v => v.trim().replace('\r', ''));
                    if (values.length !== headers.length || values[0] === '') continue;

                    const rowData = {};
                    headers.forEach((h, j) => { rowData[h] = values[j]; });
                    
                    const targetEmployee = employees.find(e => 
                        String(e.name).toUpperCase() === String(rowData.employeename).toUpperCase() &&
                        String(e.department).toUpperCase() === String(rowData.department).toUpperCase()
                    );

                    if (!targetEmployee) continue;
                    
                    const dept = targetEmployee.department;
                    if (dept === 'English') continue; // English department is excluded from this bulk update

                    // Load existing state from DB to merge new data
                    const currentState = targetEmployee.savedPayroll || createInitialState(dept);
                    let hasNewData = false;
                    const period = `${rowData.payrollyear}-${rowData.payrollmonth}`;
                    const historyUpdate = targetEmployee.payrollHistory || {};

                    for (let hIndex = 0; hIndex < headers.length; hIndex++) {
                        const originalHeader = originalHeaders[hIndex]; 
                        const value = values[hIndex];
                        
                        if (requiredHeaders.includes(headers[hIndex]) || headers[hIndex] === 'campus' || !value || isNaN(parseFloat(value))) continue;
                        
                        if (currentState.hasOwnProperty(originalHeader)) {
                            currentState[originalHeader] = parseFloat(value);
                            hasNewData = true;
                        }
                    }

                    if (hasNewData) {
                        // Recalculate Basic/Start totals based on imported data
                        const syncFields = [LAO_FIELDS.research, LAO_FIELDS.media, LAO_FIELDS.behaviorBasic, LAO_FIELDS.classResp, LAO_FIELDS.policy];
                        const basicSum = syncFields.reduce((sum, field) => sum + parseFloat(currentState[field] || 0), 0);
                        currentState[LAO_FIELDS.basic] = basicSum;
                        currentState[LAO_FIELDS.start] = basicSum + parseFloat(currentState[LAO_FIELDS.cert] || 0) + parseFloat(currentState[LAO_FIELDS.homeroom] || 0) + parseFloat(currentState[LAO_FIELDS.behaviorStart] || 0);
                        
                        // Update history record
                        historyUpdate[period] = currentState; 
                        historyUpdated++;
                        
                        const docRef = getDocRef('neerada_payroll_employees', targetEmployee.id);
                        updatePromises.push(setDoc(docRef, { 
                            savedPayroll: currentState, 
                            payrollHistory: historyUpdate, 
                            lastModified: new Date().toISOString() 
                        }, { merge: true }));
                        updatedCount++;
                    }
                }

                try {
                    await Promise.all(updatePromises);
                    alert(`Successfully updated ${updatedCount} employee records in the payroll buffer and ${historyUpdated} history entries in Firestore.`);
                    if (selectedEmployee) window.handleSelect(selectedEmployee.id); // Refresh editor if visible
                } catch (error) {
                    console.error("Bulk Payslip Import Failed:", error);
                    alert("Bulk payroll import failed. See console for errors.");
                }
                
                input.value = '';
            };
            reader.readAsText(file);
        }

    </script>
</body>
</html>